---
title: "RI-CLPM for social isolation and ADHD symptoms in childhood, using residuals for ADHD"
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: hide
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'asis')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(lavaan)
library(modelr)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path, include=FALSE}
#source raw data directory: data_raw and data included
source("../isolation_ADHD_data_path.R")
```

```{r read in dta data file}
dat.raw <- read_dta(paste0(data.raw_path, "Katie_19Jan22.dta"))

dat <- dat.raw %>%
  select(id = atwinid,
         sampsex,
         seswq35,
         sisoem5,  # social isolation mother report
         sisoem7,
         sisoem10,
         sisoem12,
         sisoet5,  # social isolation teacher report
         sisoet7, 
         sisoet10,
         sisoet12,
         tadhdem5,  # total ADHD mother report
         tadhdem7,
         tadhdem10,
         tadhdem12,
         tadhdet5,  # total ADHD teacher report
         tadhdet7,
         tadhdet10,
         tadhdet12,
         hyem5,     # hyperactivity ADHD mother report
         hyem7,
         hyem10,
         hyem12, 
         hyet5,     # hyperactivity ADHD teacher report
         hyet7,
         hyet10,
         hyet12,
         inem5,    # inattention ADHD mother report
         inem7,
         inem10,
         inem12,
         inet5,    # inattention ADHD teacher report
         inet7,
         inet10,
         inet12
  )

colnames(dat)
```

```{r recode sex variable}
dat <- dat %>%
  mutate(
    sex = 
      recode_factor(as_factor(sampsex),
        "1" = "Male",
        "2" = "Female"))

table(dat$sex)
```

# Create residuals for hyperactivity and inattention

```{r residuals for adhd age 5}
# Hyperactivity
hyp.resid <- lm(hyem5 ~ inem5, data = dat)

dat <- dat %>%
  add_residuals(model = hyp.resid, var = "hypresidm5")

# Inattention
inat.resid <- lm(inem5 ~ hyem5, data = dat)

dat <- dat %>%
  add_residuals(model = inat.resid, var = "inatresidm5")
```

```{r residuals for adhd age 7}
# Hyperactivity
hyp.resid <- lm(hyem7 ~ inem7, data = dat)

dat <- dat %>%
  add_residuals(model = hyp.resid, var = "hypresidm7")

# Inattention
inat.resid <- lm(inem7 ~ hyem7, data = dat)

dat <- dat %>%
  add_residuals(model = inat.resid, var = "inatresidm7")
```

```{r residuals for adhd age 10}
# Hyperactivity
hyp.resid <- lm(hyem10 ~ inem10, data = dat)

dat <- dat %>%
  add_residuals(model = hyp.resid, var = "hypresidm10")

# Inattention
inat.resid <- lm(inem10 ~ hyem10, data = dat)

dat <- dat %>%
  add_residuals(model = inat.resid, var = "inatresidm10")
```

```{r residuals for adhd age 12}
# Hyperactivity
hyp.resid <- lm(hyem12 ~ inem12, data = dat)

dat <- dat %>%
  add_residuals(model = hyp.resid, var = "hypresidm12")

# Inattention
inat.resid <- lm(inem12 ~ hyem12, data = dat)

dat <- dat %>%
  add_residuals(model = inat.resid, var = "inatresidm12")
```

***

# RI-CLPM: Mother report only, Hyperactive/Impulsive ADHD symptoms

## Cross-lagged panel model (CLPM_hyp)

```{r specify CLPM_hyp}
CLPM_hyp <- '
  # Estimate the lagged effects between the observed variables.
  hypresidm7 + sisoem7 ~ hypresidm5 + sisoem5
  hypresidm10 + sisoem10 ~ hypresidm7 + sisoem7
  hypresidm12 + sisoem12 ~ hypresidm10 + sisoem10

  # Estimate the covariance between the observed variables at the first wave. 
  hypresidm5 ~~ sisoem5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  hypresidm7 ~~ sisoem7
  hypresidm10 ~~ sisoem10
  hypresidm12 ~~ sisoem12
  
  # Estimate the (residual) variance of the observed variables.
  hypresidm5 ~~ hypresidm5 # Variances
  sisoem5 ~~ sisoem5 
  hypresidm7 ~~ hypresidm7 # Residual variances
  sisoem7 ~~ sisoem7 
  hypresidm10 ~~ hypresidm10 
  sisoem10 ~~ sisoem10 
  hypresidm12 ~~ hypresidm12 
  sisoem12 ~~ sisoem12 
'
```

```{r fit CLPM_hyp}
CLPM_hyp.fit <- lavaan(CLPM_hyp, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust") 

summary(CLPM_hyp.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

## The basic RI-CLPM model (RICLPM_hyp)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPM_hyp}
RICLPM_hyp <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hypresidm5 + 1*hypresidm7 + 1*hypresidm10 + 1*hypresidm12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hypresidm5
  wad7 =~ 1*hypresidm7
  wad10 =~ 1*hypresidm10 
  wad12 =~ 1*hypresidm12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp}
RICLPM_hyp.fit <- lavaan(RICLPM_hyp,       # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE)   # if FALSE, the intercepts of the observed variables are fixed to zero

RICLPM_hyp.fit.summary <- summary(RICLPM_hyp.fit, 
                                  fit.measures = TRUE,
                                  standardized = TRUE)

#Table of model fit 
RICLPM_hyp.fit.summary.fit <- as.data.frame(t(as.data.frame(RICLPM_hyp.fit.summary$FIT)))[,c(3,4,9,10,13,14,16,17,18,19,21)]

#Table of regression coefficient 
RICLPM_hyp.fit.summary.reg <- as.tibble(RICLPM_hyp.fit.summary$PE[c(17:32),-c(4)])
```

```{r fit RICLPM_hyp grouped by sex}
RICLPM_hyp.sex.fit <- lavaan(RICLPM_hyp, 
                      data = dat, 
                      missing = 'ML', 
                      group = "sex",
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust") 

RICLPM_hyp.sex.fit.summary <- summary(RICLPM_hyp.sex.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)
```

Now we want to aaply constraints over time to test if lagged parameters are invariant across groups, if the chi square is significant then the lagged effects for boys and girls are different.  

```{r specify RICLPM_hyp.sex2}
RICLPM_hyp.sex2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hypresidm5 + 1*hypresidm7 + 1*hypresidm10 + 1*hypresidm12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hypresidm5
  wad7 =~ 1*hypresidm7
  wad10 =~ 1*hypresidm10 
  wad12 =~ 1*hypresidm12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Estimate the lagged effects between the within-person centered variables. Constrain the autoregressive effects across groups. 
  wad7 ~ c(a1, a1)*wad5 + c(b1, b1)*wsi5
  wsi7 ~ c(c1, c1)*wad5 + c(d1, d1)*wsi5
  wad10 ~ c(a2, a2)*wad7 + c(b2, b2)*wsi7
  wsi10 ~ c(c2, c2)*wad7 + c(d2, d2)*wsi7
  wad12 ~ c(a3, a3)*wad10 + c(b3, b3)*wsi10
  wsi12 ~ c(c3, c3)*wad10 + c(d3, d3)*wsi10 

  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM.sex2 grouped by sex}
RICLPM_hyp.sex2.fit <- lavaan(RICLPM_hyp.sex2, 
                      data = dat, 
                      missing = 'ML', 
                      group = "sex",
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust") 

RICLPM_hyp.sex2.fit.summary <- summary(RICLPM_hyp.sex2.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)
```

Now we see if there is a significantly worse fit when the lagged-parameters are constrained to be equal across groups. 

```{r LRT for RICLPM.sex and RICLPM.sex2}
lavTestLRT(RICLPM_hyp.sex.fit, RICLPM_hyp.sex2.fit)
```

The chi-square difference test of these two nested models is non-significant (p=0.7304), which implies that the  lagged effects appear to be the **same for girls and boys.** 



## RI-CLPM Constraints over time {.tabset .tabset-fade}

Imposing constraints to the model can be achieved through **pre-multiplication**. It means that we have to prepend the number that we want to fix the parameter to, and an asterisk, to the parameter in the model specification. For example, `F =~ 0*x1` fixes the factor loading of item `x1` to factor `F` to 0. Using pre-multiplication we can also constrain parameters to be the same by giving them the same label. Below we specify an RI-CLPM with the following constraints: 

1) fixed auto-regressive and cross-lagged relations over time, `wx2 ~ a*wx1 + b*wy1; ...`
2) time-invariant (residual) (co-)variances in the within-person part `wx2 ~~ cov*wy2; ...`, `wx2 ~~ vx*wx2; ...`, and `wy2 ~~ vy*wy2; ...`
3) constrained grand means over time, `x1 + ... ~ mx*1` and `y1 + ... ~ my*1`

### Unconstrained factor loadings for the random intercepts (RICLPM_hyp1) 

```{r specify RICLPM_hyp1}
RICLPM_hyp1 <- '
  # Create between components (random intercepts)
  RIad =~ 1*hypresidm5 + hypresidm7 + hypresidm10 + hypresidm12 #x
  RIsi =~ 1*sisoem5 + sisoem7 + sisoem10 + sisoem12 #y
  
  # Create within-person centered variables
  wad5 =~ 1*hypresidm5
  wad7 =~ 1*hypresidm7
  wad10 =~ 1*hypresidm10 
  wad12 =~ 1*hypresidm12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp1}
RICLPM_hyp1.fit <- lavaan(RICLPM_hyp1, 
                          data = dat, 
                          missing = 'ML', 
                          meanstructure = TRUE, 
                          int.ov.free = TRUE,
                          se = "robust") 
summary(RICLPM_hyp1.fit, 
        standardized = TRUE)
```

*This model RICLPM_hyp1 did not converge, therefore random intercepts loadings will be fixed to 1 throughout all other models.*

***

### Fixed autoregressive and cross-lagged relations over time (RICLPM_hyp2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPM2)

```{r specify RICLPM_hyp2}
RICLPM_hyp2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hypresidm5 + 1*hypresidm7 + 1*hypresidm10 + 1*hypresidm12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hypresidm5
  wad7 =~ 1*hypresidm7
  wad10 =~ 1*hypresidm10 
  wad12 =~ 1*hypresidm12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2}
RICLPM_hyp2.fit <- lavaan(RICLPM_hyp2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust") 

summary(RICLPM_hyp2.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp and RICLPM_hyp2}
lavTestLRT(RICLPM_hyp.fit, RICLPM_hyp2.fit)
```

RICLPM_hyp2 is significantly *worse* fit compared to RICLPM_hyp. 

#### Constraining lag in ADHD parameter (RICLPM_hyp2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPM_hyp2a}
RICLPM_hyp2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hypresidm5 + 1*hypresidm7 + 1*hypresidm10 + 1*hypresidm12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hypresidm5
  wad7 =~ 1*hypresidm7
  wad10 =~ 1*hypresidm10 
  wad12 =~ 1*hypresidm12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2a}
RICLPM_hyp2a.fit <- lavaan(RICLPM_hyp2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust") 

summary(RICLPM_hyp2a.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp and RICLPM_hyp2a}
lavTestLRT(RICLPM_hyp.fit, RICLPM_hyp2a.fit)
```

RICLPM_hyp2a is significantly *worse* fit compared to RICLPM_hyp. Now we will constrain the other set of stability coefficients: lag in si (b)

#### Constraining lag in social isolation parameter (RICLPM_hyp2b)

```{r specify RICLPM_hyp2b}
RICLPM_hyp2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hypresidm5 + 1*hypresidm7 + 1*hypresidm10 + 1*hypresidm12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hypresidm5
  wad7 =~ 1*hypresidm7
  wad10 =~ 1*hypresidm10 
  wad12 =~ 1*hypresidm12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2b}
RICLPM_hyp2b.fit <- lavaan(RICLPM_hyp2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust") 

summary(RICLPM_hyp2b.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp and RICLPM_hyp2b}
lavTestLRT(RICLPM_hyp.fit, RICLPM_hyp2b.fit)
```

RICLPM_hyp2b is significantly *worse* fit compared to RICLPM_hyp. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPM_hyp2c)

```{r specify RICLPM_hyp2c}
RICLPM_hyp2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hypresidm5 + 1*hypresidm7 + 1*hypresidm10 + 1*hypresidm12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hypresidm5
  wad7 =~ 1*hypresidm7
  wad10 =~ 1*hypresidm10 
  wad12 =~ 1*hypresidm12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2c}
RICLPM_hyp2c.fit <- lavaan(RICLPM_hyp2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust") 

summary(RICLPM_hyp2c.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp and RICLPM_hyp2c}
lavTestLRT(RICLPM_hyp.fit, RICLPM_hyp2c.fit)
```

RICLPM_hyp2c is *NOT* significantly worse fit compared to RICLPM_hyp (p = 0.9071). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPM_hyp2d) - **compared to RICLPM_hyp2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPM_hyp2d}
RICLPM_hyp2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hypresidm5 + 1*hypresidm7 + 1*hypresidm10 + 1*hypresidm12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hypresidm5
  wad7 =~ 1*hypresidm7
  wad10 =~ 1*hypresidm10 
  wad12 =~ 1*hypresidm12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2d}
RICLPM_hyp2d.fit <- lavaan(RICLPM_hyp2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust") 

RICLPM_hyp2d.fit.summary <- summary(RICLPM_hyp2d.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPM_hyp2d.fit.summary.fit <- as.data.frame(t(as.data.frame(RICLPM_hyp2d.fit.summary$FIT)))[,c(3,4,9,10,13,14,16,17,18,19,21)]

#Table of regression coefficient 
RICLPM_hyp2d.fit.summary.reg <- as.tibble(RICLPM_hyp2d.fit.summary$PE[c(17:28),-c(4,5)])

# Table of co-variances - concurrent associations between SI and ADHD
RICLPM_hyp2d.fit.summary.covar <- as.tibble(RICLPM_hyp2d.fit.summary$PE[c(29:32),-c(4,5)])
```

```{r LRT for RICLPM_hyp2c and RICLPM_hyp2d}
lavTestLRT(RICLPM_hyp2c.fit, RICLPM_hyp2d.fit) #comparing to other best fitting model
```

RICLPM_hyp2d is *NOT* significantly worse fit compared to RICLPM_hyp2c.fit (p = 0.1995). 

**The best fitting model (mother report and Hyperactivity/impulsivity ADHD symptoms) is currently RICLPM2d where cross-lags are constrained to be equal across time.**

***

# RI-CLPM: Mother report only, Inattention ADHD symptoms

## The basic RI-CLPM model (RICLPM_inat)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPM_inat}
RICLPM_inat <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inatresidm5 + 1*inatresidm7 + 1*inatresidm10 + 1*inatresidm12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*inatresidm5
  wad7 =~ 1*inatresidm7
  wad10 =~ 1*inatresidm10 
  wad12 =~ 1*inatresidm12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_inat}
RICLPM_inat.fit <- lavaan(RICLPM_inat,     # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE)   # if FALSE, the intercepts of the observed variables are fixed to zero

RICLPM_inat.fit.summary <- summary(RICLPM_inat.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPM_inat.fit.summary.fit <- as.data.frame(t(as.data.frame(RICLPM_inat.fit.summary$FIT)))[,c(3,4,9,10,13,14,16,17,18,19,21)]

#Table of regression coefficient 
RICLPM_inat.fit.summary.reg <- as.tibble(RICLPM_inat.fit.summary$PE[c(17:28),-c(4)])

# Table of co-variances - concurrent associations between SI and ADHD
RICLPM_inat.fit.summary.covar <- as.tibble(RICLPM_inat.fit.summary$PE[c(29:32),-c(4)])
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

Imposing constraints to the model can be achieved through **pre-multiplication**. It means that we have to prepend the number that we want to fix the parameter to, and an asterisk, to the parameter in the model specification. For example, `F =~ 0*x1` fixes the factor loading of item `x1` to factor `F` to 0. Using pre-multiplication we can also constrain parameters to be the same by giving them the same label. Below we specify an RI-CLPM with the following constraints: 

1) fixed auto-regressive and cross-lagged relations over time, `wx2 ~ a*wx1 + b*wy1; ...`
2) time-invariant (residual) (co-)variances in the within-person part `wx2 ~~ cov*wy2; ...`, `wx2 ~~ vx*wx2; ...`, and `wy2 ~~ vy*wy2; ...`
3) constrained grand means over time, `x1 + ... ~ mx*1` and `y1 + ... ~ my*1`






























