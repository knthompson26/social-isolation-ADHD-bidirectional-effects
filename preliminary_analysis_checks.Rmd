---
title: "Preliminary analysis checks"
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: hide
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'asis')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(polycor)
library(summarytools)
library(psych)
library(skimr)
library(ggpubr)
library(tidyr)
library(ggplot2)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path, include=FALSE}
#source raw data directory: data_raw and data included
source("../isolation_ADHD_data_path.R")
```

```{r read in dta data file}
dat.raw <- read_dta(paste0(data.raw_path, "preliminary_Katie_12Nov21.dta"))
colnames(dat.raw)
```

```{r read in prepped regression data and check variable names, include=FALSE}
dat.rds <- readRDS("/Users/katiethompson/Documents/PhD/LISS-DTP_Louise_and_Tim/Social isolation trajectories_Paper 1/data_analysis/data_full/data/class_joined_preprocessed_isolation_data_full_sample.rds")
colnames(dat.rds)

dat.rds <- dat.rds %>%
  select(atwinid = id,
         isolation_mother_05,
         isolation_mother_07,
         isolation_mother_10,
         isolation_mother_12,
         isolation_teacher_05,
         isolation_teacher_07,
         isolation_teacher_10,
         isolation_teacher_12
         )
```

```{r combine data I have and new data}
dataframe_list <- list(
  dat.raw,
  dat.rds
)

#merge data frames
dat <- plyr::join_all(
  dataframe_list,
  by = "atwinid" # Alternatively you can join by several columns
  )

colnames(dat)
```


```{r variable list}
si.adhd.variables <- c(
  "sisoe5",
  "inem5",
  "hyem5",
  "tadhdem5",
  "inet5",
  "hyet5",
  "tadhdet5",
  "sisoe7",
  "inem7",
  "hyem7",
  "tadhdem7",
  "inet7",
  "hyet7",
  "tadhdet7",
  "sisoe10",
  "inem10",
  "hyem10",
  "tadhdem10",
  "inet10",
  "hyet10",
  "tadhdet10",
  "sisoe12",
  "inem12",
  "hyem12",
  "tadhdem12",
  "inet12",
  "hyet12",
  "tadhdet12",
  "isolation_mother_05",
  "isolation_mother_07",
  "isolation_mother_10",
  "isolation_mother_12",
  "isolation_teacher_05",
  "isolation_teacher_07",
  "isolation_teacher_10",
  "isolation_teacher_12"
)

name.list <- c(
  "Social isolation age 5",
  "Inattention mother report age 5",
  "Hyperactivity mother report age 5",
  "Total ADHD mother report age 5",
  "Inattention teacher report age 5",
  "Hyperactivity teacher report age 5",
  "Total ADHD teacher report age 5",
  "Social isolation age 7",
  "Inattention mother report age 7",
  "Hyperactivity mother report age 7",
  "Total ADHD mother report age 7",
  "Inattention teacher report age 7",
  "Hyperactivity teacher report age 7",
  "Total ADHD teacher report age 7",
  "Social isolation age 10",
  "Inattention mother report age 10",
  "Hyperactivity mother report age 10",
  "Total ADHD mother report age 10",
  "Inattention teacher report age 10",
  "Hyperactivity teacher report age 10",
  "Total ADHD teacher report age 10",
  "Social isolation age 12",
  "Inattention mother report age 12",
  "Hyperactivity mother report age 12",
  "Total ADHD mother report age 12",
  "Inattention teacher report age 12",
  "Hyperactivity teacher report age 12",
  "Total ADHD teacher report age 12",
  "Social isolation mother report age 5",
  "Social isolation mother report age 7",
  "Social isolation mother report age 10",
  "Social isolation mother report age 12",
  "Social isolation teacher report age 5",
  "Social isolation teacher report age 7",
  "Social isolation teacher report age 10",
  "Social isolation teacher report age 12"
)
```

```{r functions, include=FALSE}
reorder_cor_matrix <- function(cor_matrix){
 dd <- as.dist((1-cor_matrix)/2) #Use correlation between variables as distance
 hc <- hclust(dd)
 cormat <-cor_matrix[hc$order, hc$order]
}
```

## Demographic variables

Sample group, cohort, sex, zygosity, SES, and ethnicity variables below have been recoded into a factor for use in R and renamed to something familiar. Only the categorical variables need recoding to establish the levels of the variable. To see the code for this, click the "code" button on the right hand side. 

Twin order
```{r twin order factor}
# # twin order
# dat <- dat %>%
#   mutate(
#     twin_order = 
#       recode_factor(torder,
#         "1" = "Elder",
#         "2" = "Younger"))
```

Sample group (Low/high risk)
```{r sample group factor}
# # sample groups
# dat <- dat %>%
#   mutate(
#     risk = # this represents mothers who had their first child under 20 years old
#       recode_factor(risks,
#         "0" = "Low risk",
#         "1" = "High risk"))
```

Cohort 
```{r cohort factor}
# # cohort
# dat <- dat %>%
#   mutate(
#     cohort_binary = 
#       recode_factor(cohort,
#         "94" = "Born in 1994",
#         "95" = "Born in 1995"))
```

Sex
```{r sex factor}
# # sex
# dat <- dat %>%
#   dplyr::mutate(
#     sex = 
#       recode_factor(sampsex,
#         "1" = "Male",
#         "2" = "Female"))
```

Zygosity
```{r zygosity factor}
# # zygosity
# dat <- dat %>%
#   mutate(
#     zygosity_binary = 
#       recode_factor(zygosity,
#         "1" = "MZ",
#         "2" = "DZ"))
```

SES
```{r SES factor}
# # SES
# dat <- dat %>%
#   mutate(
#     SES = 
#       recode_factor(seswq35,
#         "1" = "Low",
#         "2" = "Middle", #this was missing in original SPSS file but still have 2s in the data set
#         "3" = "High"))
```

Ethnicity
```{r ethnicity factor}
# # ethnicity
# dat <- dat %>%
#   mutate(
#     ethnicity = 
#       recode_factor(sethnic,
#         "1" = "White",
#         "2" = "Asian", 
#         "3" = "Black",
#         "4" = "Mixed race",
#         "5" = "Other"))
```

A new variable was created for SES. SES_ordered has ordered SES to show that there are order differences between the labels "low", "middle", and "high". 

```{r SES ordered variable, class.source = 'fold-show'}
# dat <- dat %>%
#   mutate(
#     SES_ordered = 
#       ordered(SES,
#               levels = c("Low",
#                          "Middle",
#                          "High")
#       )
#   )
```

```{r polychoric correlation matrix}
# create data frame with variables
si.adhd_data_frame <- as.data.frame(dat[,si.adhd.variables])
colnames(si.adhd_data_frame) <- name.list

# get correlation matrix
cor_matrix <- cor(si.adhd_data_frame, method = "spearman", use = "pairwise.complete.obs")

# Reorder the correlation matrix
cor_matrix_full <- reorder_cor_matrix(cor_matrix)
  
#melt the values
metled_cor_matrix <- reshape::melt(cor_matrix_full, na.rm = TRUE)

#correlation heat map
correlation_heat_map <- ggplot(metled_cor_matrix, aes(X2, X1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white",
   midpoint = 0, limit = c(-1,1), space = "Lab",
    name="Spearman\nCorrelation") +
  theme_minimal() +
  labs(y = "",
       x = "",
       title = "Correlation heat map of ADHD and social isolation variables")+
 theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1),
       axis.text.y = element_text(size = 12),
       plot.margin=grid::unit(c(0,0,0,0), "mm"),
       plot.title = element_text(size = 20),
       )+
 coord_fixed() +
  geom_text(aes(X2, X1, label = round(value, digits = 2)), color = "black", size = 3)
```

```{r heat map fig, fig.width=15, fig.height=15}
correlation_heat_map
```

```{r save correlation heat map, include=FALSE}
# #save
ggsave(
  "adhd.si_correlation_heat_map.png",
  plot = correlation_heat_map,
  device = "png",
  path = paste0(graph_save_data_path, "preliminary/"),
  width = 15,
  height = 15
)
```

```{r correlation matrix social isolation total}
si.cor_matrix_total <- as.data.frame(cor_matrix_full) %>%
  select(`Social isolation age 5`,
         `Social isolation age 7`,
         `Social isolation age 10`,
         `Social isolation age 12`
         )

# create correlation matrices for mother reported total, inattention and hyperactivity
si.tot.cor_matrix_total <- si.cor_matrix_total[c(19,22,12,14),]  # total  
si.inat.cor_matrix_total <- si.cor_matrix_total[c(17,20,15,16),] # inattention
si.hyp.cor_matrix_total <- si.cor_matrix_total[c(18,21,11,13),]  # hyperactivity
```

```{r tables for total cor matrix}
kable(round(si.tot.cor_matrix_total,2))
kable(round(si.inat.cor_matrix_total,2))
kable(round(si.hyp.cor_matrix_total,2))
```

```{r correlation matrix social isolation mother}
si.cor_matrix_mother <- as.data.frame(cor_matrix_full) %>%
  select(`Social isolation mother report age 5`,
         `Social isolation mother report age 7`,
         `Social isolation mother report age 10`,
         `Social isolation mother report age 12`
         )

# create correlation matrices for mother reported total, inattention and hyperactivity
si.tot.cor_matrix_mother <- si.cor_matrix_mother[c(19,22,12,14),]  # total  
si.inat.cor_matrix_mother <- si.cor_matrix_mother[c(17,20,15,16),] # inattention
si.hyp.cor_matrix_mother <- si.cor_matrix_mother[c(18,21,11,13),]  # hyperactivity
```

```{r tables for mother cor matrix}
kable(round(si.tot.cor_matrix_mother, 2))
kable(round(si.inat.cor_matrix_mother,2))
kable(round(si.hyp.cor_matrix_mother,2))
```

```{r full mother correlation matrix}
kable(round(rbind(si.tot.cor_matrix_mother, si.inat.cor_matrix_mother, si.hyp.cor_matrix_mother),2))
```


