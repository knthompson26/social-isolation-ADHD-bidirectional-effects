---
title: "Random intercept cross lagged panel models for social isolation and ADHD symptoms in childhood"
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: hide
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'asis')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(lavaan)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path, include=FALSE}
#source raw data directory: data_raw and data included
source("../isolation_ADHD_data_path.R")
```

```{r read in dta data file}
dat.raw <- read_dta(paste0(data.raw_path, "preliminary_Katie_12Nov21.dta"))
#colnames(dat.raw)
```

```{r read in prepped regression data and check variable names, include=FALSE}
dat.rds <- readRDS("/Users/katiethompson/Documents/PhD/LISS-DTP_Louise_and_Tim/Social isolation trajectories_Paper 1/data_analysis/data_full/data/class_joined_preprocessed_isolation_data_full_sample.rds")
#colnames(dat.rds)

dat.rds <- dat.rds %>%
  select(atwinid = id,
         isolation_mother_05,
         isolation_mother_07,
         isolation_mother_10,
         isolation_mother_12,
         isolation_teacher_05,
         isolation_teacher_07,
         isolation_teacher_10,
         isolation_teacher_12
         )
```

## Variable names
```{r combine data I have and new data}
dataframe_list <- list(
  dat.raw,
  dat.rds
)

#merge data frames
dat <- plyr::join_all(
  dataframe_list,
  by = "atwinid" # Alternatively you can join by several columns
  )

colnames(dat)
```

# All RI-CLPM models 

| Model       | Description                                                                                                                   | 
| ----------- | ----------------------------------------------------------------------------------------------------------------------------- |
|    RICLPM   |  Basic RI-CLPM model using combined parent and teacher raings for AD and SI, and total inattentive and hyperacitivty scores   |
|      CLPM   |  Basic CLPM model using combined parent and teacher raings for AD and SI, and total inattentive and hyperacitivty scores      |
|   RICLPM1   |  RICLPM but with unconstrained factor loadings for the random intercepts                                                      |
|   RICLPM2   |  RICLPM but with fixed autoregressive and cross-lagged relations over time                                                    |
|   RICLPM3   |  RICLPM but with constrained grand means for AD and SI                                                                        |
|   RICLPM4   |  RICLPM but with fixed autoregressive and cross-lagged relations over time, constrained grand means and covariances           |


# Basic RI-CLPM {.tabset .tabset-fade}

For SEM in [lavaan](https://lavaan.ugent.be/index.html), we use three different formula types: latent variabele definitions (using the `=~` operator, which can be read as is "measured by"), regression formulas (using the `~` operator), and (co)variance formulas (using the `~~` operator). The regression formulas are similar to ordinary formulas in R. The expression `y1 ~~ y2` allows the residual variances of the two observed variables to be correlated. This is sometimes done if it is believed that the two variables have something in common that is not captured by the latent variables. Note that the two expressions `y2 ~~ y4` and `y2 ~~ y6`, can be combined into the expression `y2 ~~ y4 + y6`, because the variable on the left of the `~~` operator (y2) is the same. This is just a shorthand notation. In general, to fix a parameter in a lavaan formula, you need to pre-multiply the corresponding variable in the formula by a numerical value. This is called the pre-multiplication mechanism and will be used for many purposes e.g. `1*x2`. If you wish to fix the correlation (or covariance) between a pair of latent variables to zero, you need to explicity add a covariance-formula for this pair, and fix the parameter to zero.

To specify the RI-CLPM we need four parts: notes from [Mulder's webpage](https://jeroendmulder.github.io/RI-CLPM/lavaan.html).

* A between part, consisting of the random intercepts. It is specified using the =~ command, `RIx =~ 1*x1 1*x2 ...`, where 1* fixes the factor loading to one.

* A within part, consisting of within-unit fluctuations. It is also specified using the =~ command, `wx1 =~ 1*x1; wx2 =~ 1*x2;`

* The lagged regressions between the within-unit components, using `wx2 ~ wx1 wy1; wx3 ~ wx2 wy2; ...`. Here, this is writted with two variables on the left hand side of the `~`, this is doing the same thing as calculating just regression paths - but combining DVs that have the same paths leading to them, e.g. `wx2 ~ wx1 + wy1` and `wy2 ~ wx1 + wy1` becomes `wx2+ wy2 ~ wx1 + wy1`. 

* Relevant covariances in both the between and within part. In the within part the components at wave 1, and their residuals at waves 2 and further are correlated within each wave, using `wx1 ~~ wy1; wx2 ~~ wy2;...`. We also need to specify their (residual) variances here using `wx1 ~~ wx1; wx2 ~~ wx2; ...`. For the between part we have to specify the variances and covariance of the random intercepts using `RIx ~~ RIy;`.

## The basic RI-CLPM model (RICLPM)
The code for specifying the basic RI-CLPM is given below plus the CLPM afterwards so these can be compared. 

```{r specify RICLPM}
RICLPM <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM}
RICLPM.fit <- lavaan(RICLPM,               # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     int.ov.free = TRUE)   # if FALSE, the intercepts of the observed variables are fixed to zero

summary(RICLPM.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

### CLPM

```{r specify CLPM}
CLPM <- '
  # Estimate the lagged effects between the observed variables.
  tadhdem7 + isolation_mother_07 ~ tadhdem5 + isolation_mother_05
  tadhdem10 + isolation_mother_10 ~ tadhdem7 + isolation_mother_07
  tadhdem12 + isolation_mother_12 ~ tadhdem10 + isolation_mother_10

  # Estimate the covariance between the observed variables at the first wave. 
  tadhdem5 ~~ isolation_mother_05 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  tadhdem7 ~~ isolation_mother_07
  tadhdem10 ~~ isolation_mother_10
  tadhdem12 ~~ isolation_mother_12
  
  # Estimate the (residual) variance of the observed variables.
  tadhdem5 ~~ tadhdem5 # Variances
  isolation_mother_05 ~~ isolation_mother_05 
  tadhdem7 ~~ tadhdem7 # Residual variances
  isolation_mother_07 ~~ isolation_mother_07 
  tadhdem10 ~~ tadhdem10 
  isolation_mother_10 ~~ isolation_mother_10 
  tadhdem12 ~~ tadhdem12 
  isolation_mother_12 ~~ isolation_mother_12 
'
```

```{r fit CLPM}
CLPM.fit <- lavaan(CLPM, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE) 

summary(CLPM.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

## RI-CLPM Constraints over time

Imposing constraints to the model can be achieved through **pre-multiplication**. It means that we have to prepend the number that we want to fix the parameter to, and an asterisk, to the parameter in the model specification. For example, `F =~ 0*x1` fixes the factor loading of item `x1` to factor `F` to 0. Using pre-multiplication we can also constrain parameters to be the same by giving them the same label. Below we specify an RI-CLPM with the following constraints: 

1) fixed auto-regressive and cross-lagged relations over time, `wx2 ~ a*wx1 + b*wy1; ...`
2) time-invariant (residual) (co-)variances in the within-person part `wx2 ~~ cov*wy2; ...`, `wx2 ~~ vx*wx2; ...`, and `wy2 ~~ vy*wy2; ...`
3) constrained grand means over time, `x1 + ... ~ mx*1` and `y1 + ... ~ my*1`

### Unconstrained factor loadings for the random intercepts (RICLPM1) - *Why is this needed?* 

```{r specify RICLPM1}
RICLPM1 <- '
  # Create between components (random intercepts)
  RIad =~ 1*tadhdem5 + tadhdem7 + tadhdem10 + tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + isolation_mother_07 + isolation_mother_10 + isolation_mother_12 #y
  
  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM1}
RICLPM1.fit <- lavaan(RICLPM1, data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 
summary(RICLPM1.fit, 
        standardized = TRUE)
```

### Fixed autoregressive and cross-lagged relations over time (RICLPM2)

a = lag in ad
b = cross lag si->ad
c = cross lag ad->si
d = lag in si

```{r specify RICLPM2}
RICLPM2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + b*wsi5 
  wsi7 ~ c*wad5 + d*wsi5
  
  wad10 ~ a*wad7 + b*wsi7
  wsi10 ~ c*wad7 + d*wsi7
  
  wad12 ~ a*wad10 + b*wsi10
  wsi12 ~ c*wad10 + d*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM2}
RICLPM2.fit <- lavaan(RICLPM2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM2.fit, standardized = T)
```

### Constrained grand means (RICLPM3)

```{r specify RICLPM3}
RICLPM3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  tadhdem5 + tadhdem7 + tadhdem10 + tadhdem12 ~ mad*1
  isolation_mother_05 + isolation_mother_07 + isolation_mother_10 + isolation_mother_12 ~ msi*1
'
```

```{r fit RICLPM3}
RICLPM3.fit <- lavaan(RICLPM3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM3.fit, standardized = T)
```

### Fixed lag effects and contrained grand means and covariances (RICLPM4)

```{r specify RICLPM4}
RICLPM4 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y
  
  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + b*wsi5 
  wsi7 ~ c*wad5 + d*wsi5
  wad10 ~ a*wad7 + b*wsi7
  wsi10 ~ c*wad7 + d*wsi7
  wad12 ~ a*wad10 + b*wsi10
  wsi12 ~ c*wad10 + d*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations, *constrained*).
  wad7 ~~ cov*wsi7
  wad10 ~~ cov*wsi10
  wad12 ~~ cov*wsi12 
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  tadhdem5 + tadhdem7 + tadhdem10 + tadhdem12 ~ mad*1
  isolation_mother_05 + isolation_mother_07 + isolation_mother_10 + isolation_mother_12 ~ msi*1
'
```

```{r fit RICLPM4}
RICLPM4.fit <- lavaan(RICLPM4, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = T, 
                      int.ov.free = T) 

summary(RICLPM4.fit, 
        standardized = T)
```

***
INSERT THE SAME MODELS FOR HYPERACTIVITY AND INATTENTION SEPARATELY
***

# Multiple reporter {.tabset .tabset-fade}
Use the tabs below to navigate to the model specification of a multiple indicator RI-CLPM, 5 waves and 3 indicators for each variable at each wave. The five steps correspond to:

- Step 1: the configural model
- Step 2: weak factorial invariance 
- Step 3: strong factorial invariance
- Step 3a (Extra): strong factorial invariance with factor loadings equal to the within-person factor loadings 
- Step 4: the latent RI-CLPM

## Step 1
When we have three indicators $X$, measured at five waves, we specify three random intercepts to capture the trait-like part of each indicator, that is, `RIX1 =~ 1*x11 1*x21 ...`, `RIX2 =~ 1*x121 1*x22@1 ...`, and `RIX3 =~ 1*x13 1*x23 ...`. In addition, we specify five within-unit components that capture the state-like part at each wave, using `WFX1 =~ x11 x12 x13; WFX2 =~ x21 x22 x23; ...`.

At the latent within-unit level, we specify the dynamic model in Mplus using `WFX2 ~ WFY1 + WFX1; WFX3 ~ WFY2 + WFX2; ...`. In addition, we allow the within-person factors at the first wave, and their residuals at subsequent waves to be correlated within each wave, `WFX1 ~~ WFY1; WFX2 ~~ WFY2; ...`. The six random intercepts are allowed to be freely correlated with each other through `RIX1 + RIX2 + ... ~~ RIX1 + RIX2 + ...`. 

















