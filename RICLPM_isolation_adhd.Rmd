---
title: "Random intercept cross lagged panel models for social isolation and ADHD symptoms in childhood"
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: hide
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'asis')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(lavaan)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path, include=FALSE}
#source raw data directory: data_raw and data included
source("../isolation_ADHD_data_path.R")
```

```{r read in dta data file}
dat.raw <- read_dta(paste0(data.raw_path, "preliminary_Katie_12Nov21.dta"))
#colnames(dat.raw)
```

```{r read in prepped regression data and check variable names, include=FALSE}
dat.rds <- readRDS("/Users/katiethompson/Documents/PhD/LISS-DTP_Louise_and_Tim/Social isolation trajectories_Paper 1/data_analysis/data_full/data/class_joined_preprocessed_isolation_data_full_sample.rds")
#colnames(dat.rds)

dat.rds <- dat.rds %>%
  select(atwinid = id,
         isolation_mother_05,
         isolation_mother_07,
         isolation_mother_10,
         isolation_mother_12,
         isolation_teacher_05,
         isolation_teacher_07,
         isolation_teacher_10,
         isolation_teacher_12
         )
```

## Variable names
```{r combine data I have and new data}
dataframe_list <- list(
  dat.raw,
  dat.rds
)

#merge data frames
dat <- plyr::join_all(
  dataframe_list,
  by = "atwinid" # Alternatively you can join by several columns
  )

colnames(dat)
```

***

# All RI-CLPM models 

| Model           | Description                                                                                                                      | 
| --------------- | -------------------------------------------------------------------------------------------------------------------------------  |
|    RICLPM       |  Basic RI-CLPM model using combined parent and teacher ratings for AD and SI, and **total ADHD** scores                          |
|      CLPM       |  Basic CLPM model using combined parent and teacher ratings for AD and SI, and total inattentive and hyperacitivty scores        |
|   RICLPM1       |  RICLPM but with unconstrained factor loadings for the random intercepts                                                         |
|   RICLPM2       |  RICLPM but with fixed autoregressive and cross-lagged relations over time                                                       |
|   RICLPM2a      |  RICLPM but with fixed ADHD autoregressive over time                                                                             |
|   RICLPM2b      |  RICLPM but with fixed social isolation autoregressive over time                                                                 |
|   RICLPM2c      |  RICLPM but with fixed ADHD to social isolation cross-lagged relations over time                                                 |
|   RICLPM2d      |  RICLPM but with fixed all cross-lagged relations over time                                                                      |
|   RICLPM3       |  RICLPM but with constrained grand means for AD and SI                                                                           |
|   RICLPM_hyp    |  Basic RI-CLPM model using combined parent and teacher ratings for AD and SI, and **hyperacitivty** scores                       |
|   RICLPM_hyp1   |  RICLPM_hyp but with unconstrained factor loadings for the random intercepts                                                     |
|   RICLPM_hyp2   |  RICLPM_hyp but with fixed autoregressive and cross-lagged relations over time                                                   |
|   RICLPM_hyp2a  |  RICLPM_hyp but with fixed ADHD autoregressive over time                                                                         |
|   RICLPM_hyp2b  |  RICLPM_hyp but with fixed social isolation autoregressive over time                                                             |
|   RICLPM_hyp2c  |  RICLPM_hyp but with fixed ADHD to social isolation cross-lagged relations over time                                             |
|   RICLPM_hyp2d  |  RICLPM_hyp but with fixed all cross-lagged relations over time                                                                  |
|   RICLPM_hyp3   |  RICLPM_hyp but with constrained grand means for AD and SI                                                                       |
|   RICLPM_inat   |  Basic RI-CLPM model using combined parent and teacher ratings for AD and SI, and **inattention** scores                         |
|   RICLPM_inat1  |  RICLPM_inat but with unconstrained factor loadings for the random intercepts                                                    |
|   RICLPM_inat2  |  RICLPM_inat but with fixed autoregressive and cross-lagged relations over time                                                  |
|   RICLPM_inat2a |  RICLPM_inat but with fixed ADHD autoregressive over time                                                                        |
|   RICLPM_inat2b |  RICLPM_inat but with fixed social isolation autoregressive over time                                                            |
|   RICLPM_inat2c |  RICLPM_inat but with fixed ADHD to social isolation cross-lagged relations over time                                            |
|   RICLPM_inat2d |  RICLPM_inat but with fixed all cross-lagged relations over time                                                                 |
|   RICLPM_inat3  |  RICLPM_inat but with constrained grand means for AD and SI                                                                      |
|   RICLPM_multi  |  RI-CLPM model using latent factors for parent and teacher ratings for AD and SI, and **total ADHD** scores                      |                                              

***

# RI-CLPM: Mother report only, total ADHD symptoms

For SEM in [lavaan](https://lavaan.ugent.be/index.html), we use three different formula types: latent variabele definitions (using the `=~` operator, which can be read as is "measured by"), regression formulas (using the `~` operator), and (co)variance formulas (using the `~~` operator). The regression formulas are similar to ordinary formulas in R. The expression `y1 ~~ y2` allows the residual variances of the two observed variables to be correlated. This is sometimes done if it is believed that the two variables have something in common that is not captured by the latent variables. Note that the two expressions `y2 ~~ y4` and `y2 ~~ y6`, can be combined into the expression `y2 ~~ y4 + y6`, because the variable on the left of the `~~` operator (y2) is the same. This is just a shorthand notation. In general, to fix a parameter in a lavaan formula, you need to pre-multiply the corresponding variable in the formula by a numerical value. This is called the pre-multiplication mechanism and will be used for many purposes e.g. `1*x2`. If you wish to fix the correlation (or covariance) between a pair of latent variables to zero, you need to explicity add a covariance-formula for this pair, and fix the parameter to zero.

To specify the RI-CLPM we need four parts: notes from [Mulder's webpage](https://jeroendmulder.github.io/RI-CLPM/lavaan.html).

* A between part, consisting of the random intercepts. It is specified using the =~ command, `RIx =~ 1*x1 1*x2 ...`, where 1* fixes the factor loading to one.

* A within part, consisting of within-unit fluctuations. It is also specified using the =~ command, `wx1 =~ 1*x1; wx2 =~ 1*x2;`

* The lagged regressions between the within-unit components, using `wx2 ~ wx1 wy1; wx3 ~ wx2 wy2; ...`. Here, this is writted with two variables on the left hand side of the `~`, this is doing the same thing as calculating just regression paths - but combining DVs that have the same paths leading to them, e.g. `wx2 ~ wx1 + wy1` and `wy2 ~ wx1 + wy1` becomes `wx2+ wy2 ~ wx1 + wy1`. 

* Relevant covariances in both the between and within part. In the within part the components at wave 1, and their residuals at waves 2 and further are correlated within each wave, using `wx1 ~~ wy1; wx2 ~~ wy2;...`. We also need to specify their (residual) variances here using `wx1 ~~ wx1; wx2 ~~ wx2; ...`. For the between part we have to specify the variances and covariance of the random intercepts using `RIx ~~ RIy;`.


## The basic RI-CLPM model (RICLPM)
The code for specifying the basic RI-CLPM is given below plus CLPM afterwards so these can be compared. 

```{r specify RICLPM}
RICLPM <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM}
RICLPM.fit <- lavaan(RICLPM,               # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     int.ov.free = TRUE)   # if FALSE, the intercepts of the observed variables are fixed to zero

summary(RICLPM.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

### CLPM

```{r specify CLPM}
CLPM <- '
  # Estimate the lagged effects between the observed variables.
  tadhdem7 + isolation_mother_07 ~ tadhdem5 + isolation_mother_05
  tadhdem10 + isolation_mother_10 ~ tadhdem7 + isolation_mother_07
  tadhdem12 + isolation_mother_12 ~ tadhdem10 + isolation_mother_10

  # Estimate the covariance between the observed variables at the first wave. 
  tadhdem5 ~~ isolation_mother_05 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  tadhdem7 ~~ isolation_mother_07
  tadhdem10 ~~ isolation_mother_10
  tadhdem12 ~~ isolation_mother_12
  
  # Estimate the (residual) variance of the observed variables.
  tadhdem5 ~~ tadhdem5 # Variances
  isolation_mother_05 ~~ isolation_mother_05 
  tadhdem7 ~~ tadhdem7 # Residual variances
  isolation_mother_07 ~~ isolation_mother_07 
  tadhdem10 ~~ tadhdem10 
  isolation_mother_10 ~~ isolation_mother_10 
  tadhdem12 ~~ tadhdem12 
  isolation_mother_12 ~~ isolation_mother_12 
'
```

```{r fit CLPM}
CLPM.fit <- lavaan(CLPM, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE) 

summary(CLPM.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

Imposing constraints to the model can be achieved through **pre-multiplication**. It means that we have to prepend the number that we want to fix the parameter to, and an asterisk, to the parameter in the model specification. For example, `F =~ 0*x1` fixes the factor loading of item `x1` to factor `F` to 0. Using pre-multiplication we can also constrain parameters to be the same by giving them the same label. Below we specify an RI-CLPM with the following constraints: 

1) fixed auto-regressive and cross-lagged relations over time, `wx2 ~ a*wx1 + b*wy1; ...`
2) time-invariant (residual) (co-)variances in the within-person part `wx2 ~~ cov*wy2; ...`, `wx2 ~~ vx*wx2; ...`, and `wy2 ~~ vy*wy2; ...`
3) constrained grand means over time, `x1 + ... ~ mx*1` and `y1 + ... ~ my*1`

### Unconstrained factor loadings for the random intercepts (RICLPM1) 

From [Mulder and Hamaker (2021)](https://www.tandfonline.com/doi/full/10.1080/10705511.2020.1784738): One can choose to relax; instead, of impose, constraints over time to allow for a more flexible and better fitting model. The RI-CLPM is based on the assumption that the random intercepts have the exact same influence on the observed variables at each occasion, which is reflected by the factor loadings that are all constrained to be 1 over time. However, researchers may want to test this, which can be done by comparing the model with these constrained factor loadings to a model in which the factor loadings are estimated freely; the latter model implies that there are stable, trait-like differences between individuals, but the size of these differences can change over time. The between components are then no longer random intercepts, but can be interpreted as traits. To fit a model with freely estimated factor loadings, at least four occasions of data are needed; in contrast, with the fixed factor loadings, the model is already identified with only three waves of data.

```{r specify RICLPM1}
RICLPM1 <- '
  # Create between components (random intercepts)
  RIad =~ 1*tadhdem5 + tadhdem7 + tadhdem10 + tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + isolation_mother_07 + isolation_mother_10 + isolation_mother_12 #y
  
  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM1}
RICLPM1.fit <- lavaan(RICLPM1, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 
summary(RICLPM1.fit, 
        standardized = TRUE)
```

*This model did not converge, therefore random intercepts loadings will be fixed to 1 throughout all other models.*

***

### Fixed autoregressive and cross-lagged relations over time (RICLPM2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

From [Mulder and Hamaker (2021)](https://www.tandfonline.com/doi/full/10.1080/10705511.2020.1784738): We may consider testing if the lagged regression coefficients are time-invariant. This can be done by comparing the fit of a model with constrained regression coefficients (over time), with the fit of a model where these parameters are freely estimated (i.e., the unconstrained model). If this chi-square difference test is non-significant, this implies the constraints are tenable and the dynamics of the process are time-invariant. If the constraints are not tenable, this could be indicative of some kind of developmental process taking place during the time span covered by the study.
In this context, it is important to realize that the lagged regression coefficients depend critically on the time interval between the repeated measures. Hence, constraining the lagged parameters to be invariant across consecutive waves only makes sense when the time interval between the occasions is *(approximately) equal*. 

#### Constraining all lag and crosslag parameters at once (RICLPM2)

```{r specify RICLPM2}
RICLPM2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM2}
RICLPM2.fit <- lavaan(RICLPM2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM2.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM and RICLPM2}
lavTestLRT(RICLPM.fit, RICLPM2.fit)
```

RICLPM2 is significantly *worse* fit compared to RICLPM. 

#### Constraining lag in ADHD parameter (RICLPM2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPM2a}
RICLPM2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM2a}
RICLPM2a.fit <- lavaan(RICLPM2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM2a.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM and RICLPM2a}
lavTestLRT(RICLPM.fit, RICLPM2a.fit)
```

RICLPM2a is significantly *worse* fit compared to RICLPM. Now we will constrain the other set of stability coefficients: lag in si (b)

#### Constraining lag in social isolation parameter (RICLPM2b)

```{r specify RICLPM2b}
RICLPM2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM2b}
RICLPM2b.fit <- lavaan(RICLPM2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM2b.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM and RICLPM2b}
lavTestLRT(RICLPM.fit, RICLPM2b.fit)
```

RICLPM2b is significantly *worse* fit compared to RICLPM. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPM2c)

```{r specify RICLPM2c}
RICLPM2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM2c}
RICLPM2c.fit <- lavaan(RICLPM2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM2c.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM and RICLPM2c}
lavTestLRT(RICLPM.fit, RICLPM2c.fit)
```

RICLPM2c is *NOT* significantly worse fit compared to RICLPM (p = 0.9275). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPM2d) - **compared to RICLPM2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPM2d}
RICLPM2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM2d}
RICLPM2d.fit <- lavaan(RICLPM2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM2d.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM2c and RICLPM2d}
lavTestLRT(RICLPM2c.fit, RICLPM2d.fit) #comparing to other best fitting model
```

RICLPM2d is *NOT* significantly worse fit compared to RICLPM2c (p = 0.1844). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPM2d where cross-lags are constrained to be equal across time.**

***

### Constrained grand means (RICLPM3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPM3}
RICLPM3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  tadhdem5 + tadhdem7 + tadhdem10 + tadhdem12 ~ mad*1
  isolation_mother_05 + isolation_mother_07 + isolation_mother_10 + isolation_mother_12 ~ msi*1
'
```

```{r fit RICLPM3}
RICLPM3.fit <- lavaan(RICLPM3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM3.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM and RICLPM3}
lavTestLRT(RICLPM.fit, RICLPM3.fit) 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Mother report only, Hyperactive/Impulsive ADHD symptoms

## The basic RI-CLPM model (RICLPM_hyp)
The code for specifying the basic RI-CLPM is given below plus CLPM afterwards so the fit can be compared. 

```{r specify RICLPM_hyp}
RICLPM_hyp <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp}
RICLPM_hyp.fit <- lavaan(RICLPM_hyp,       # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     int.ov.free = TRUE)   # if FALSE, the intercepts of the observed variables are fixed to zero

summary(RICLPM_hyp.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

Imposing constraints to the model can be achieved through **pre-multiplication**. It means that we have to prepend the number that we want to fix the parameter to, and an asterisk, to the parameter in the model specification. For example, `F =~ 0*x1` fixes the factor loading of item `x1` to factor `F` to 0. Using pre-multiplication we can also constrain parameters to be the same by giving them the same label. Below we specify an RI-CLPM with the following constraints: 

1) fixed auto-regressive and cross-lagged relations over time, `wx2 ~ a*wx1 + b*wy1; ...`
2) time-invariant (residual) (co-)variances in the within-person part `wx2 ~~ cov*wy2; ...`, `wx2 ~~ vx*wx2; ...`, and `wy2 ~~ vy*wy2; ...`
3) constrained grand means over time, `x1 + ... ~ mx*1` and `y1 + ... ~ my*1`

### Unconstrained factor loadings for the random intercepts (RICLPM_hyp1) 

```{r specify RICLPM_hyp1}
RICLPM_hyp1 <- '
  # Create between components (random intercepts)
  RIad =~ 1*hyem5 + hyem7 + hyem10 + hyem12 #x
  RIsi =~ 1*isolation_mother_05 + isolation_mother_07 + isolation_mother_10 + isolation_mother_12 #y
  
  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp1}
RICLPM_hyp1.fit <- lavaan(RICLPM_hyp1, 
                          data = dat, 
                          missing = 'ML', 
                          meanstructure = TRUE, 
                          int.ov.free = TRUE) 
summary(RICLPM_hyp1.fit, 
        standardized = TRUE)
```

*This model RICLPM_hyp1 did not converge, therefore random intercepts loadings will be fixed to 1 throughout all other models.*

***

### Fixed autoregressive and cross-lagged relations over time (RICLPM_hyp2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPM2)

```{r specify RICLPM_hyp2}
RICLPM_hyp2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2}
RICLPM_hyp2.fit <- lavaan(RICLPM_hyp2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_hyp2.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp and RICLPM_hyp2}
lavTestLRT(RICLPM_hyp.fit, RICLPM_hyp2.fit)
```

RICLPM_hyp2 is significantly *worse* fit compared to RICLPM_hyp. 

#### Constraining lag in ADHD parameter (RICLPM_hyp2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPM_hyp2a}
RICLPM_hyp2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2a}
RICLPM_hyp2a.fit <- lavaan(RICLPM_hyp2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_hyp2a.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp and RICLPM_hyp2a}
lavTestLRT(RICLPM_hyp.fit, RICLPM_hyp2a.fit)
```

RICLPM_hyp2a is significantly *worse* fit compared to RICLPM_hyp. Now we will constrain the other set of stability coefficients: lag in si (b)

#### Constraining lag in social isolation parameter (RICLPM_hyp2b)

```{r specify RICLPM_hyp2b}
RICLPM_hyp2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2b}
RICLPM_hyp2b.fit <- lavaan(RICLPM_hyp2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_hyp2b.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp and RICLPM_hyp2b}
lavTestLRT(RICLPM_hyp.fit, RICLPM_hyp2b.fit)
```

RICLPM_hyp2b is significantly *worse* fit compared to RICLPM_hyp. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPM_hyp2c)

```{r specify RICLPM_hyp2c}
RICLPM_hyp2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2c}
RICLPM_hyp2c.fit <- lavaan(RICLPM_hyp2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_hyp2c.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp and RICLPM_hyp2c}
lavTestLRT(RICLPM_hyp.fit, RICLPM_hyp2c.fit)
```

RICLPM_hyp2c is *NOT* significantly worse fit compared to RICLPM_hyp (p = 0.9071). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPM_hyp2d) - **compared to RICLPM_hyp2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPM_hyp2d}
RICLPM_hyp2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_hyp2d}
RICLPM_hyp2d.fit <- lavaan(RICLPM_hyp2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_hyp2d.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp2c and RICLPM_hyp2d}
lavTestLRT(RICLPM_hyp2c.fit, RICLPM_hyp2d.fit) #comparing to other best fitting model
```

RICLPM_hyp2d is *NOT* significantly worse fit compared to RICLPM_hyp2c.fit (p = 0.1995). 

**The best fitting model (mother report and Hyperactivity/impulsivity ADHD symptoms) is currently RICLPM2d where cross-lags are constrained to be equal across time.**

***

### Constrained grand means (RICLPM_hyp3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPM_hyp3}
RICLPM_hyp3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  hyem5 + hyem7 + hyem10 + hyem12 ~ mad*1
  isolation_mother_05 + isolation_mother_07 + isolation_mother_10 + isolation_mother_12 ~ msi*1
'
```

```{r fit RICLPM_hyp3}
RICLPM_hyp3.fit <- lavaan(RICLPM_hyp3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_hyp3.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_hyp and RICLPM_hyp3}
lavTestLRT(RICLPM_hyp.fit, RICLPM_hyp3.fit) 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Mother report only, Inattention ADHD symptoms

## The basic RI-CLPM model (RICLPM_inat)
The code for specifying the basic RI-CLPM is given below plus CLPM afterwards so the fit can be compared. 

```{r specify RICLPM_inat}
RICLPM_inat <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_inat}
RICLPM_inat.fit <- lavaan(RICLPM_inat,     # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     int.ov.free = TRUE)   # if FALSE, the intercepts of the observed variables are fixed to zero

summary(RICLPM_inat.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

Imposing constraints to the model can be achieved through **pre-multiplication**. It means that we have to prepend the number that we want to fix the parameter to, and an asterisk, to the parameter in the model specification. For example, `F =~ 0*x1` fixes the factor loading of item `x1` to factor `F` to 0. Using pre-multiplication we can also constrain parameters to be the same by giving them the same label. Below we specify an RI-CLPM with the following constraints: 

1) fixed auto-regressive and cross-lagged relations over time, `wx2 ~ a*wx1 + b*wy1; ...`
2) time-invariant (residual) (co-)variances in the within-person part `wx2 ~~ cov*wy2; ...`, `wx2 ~~ vx*wx2; ...`, and `wy2 ~~ vy*wy2; ...`
3) constrained grand means over time, `x1 + ... ~ mx*1` and `y1 + ... ~ my*1`

### Unconstrained factor loadings for the random intercepts (RICLPM_inat1) 

```{r specify RICLPM_inat1}
RICLPM_inat1 <- '
  # Create between components (random intercepts)
  RIad =~ 1*inem5 + inem7 + inem10 + inem12 #x
  RIsi =~ 1*isolation_mother_05 + isolation_mother_07 + isolation_mother_10 + isolation_mother_12 #y
  
  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_inat1}
RICLPM_inat1.fit <- lavaan(RICLPM_inat1, 
                          data = dat, 
                          missing = 'ML', 
                          meanstructure = TRUE, 
                          int.ov.free = TRUE) 
summary(RICLPM_inat1.fit, 
        standardized = TRUE)
```

*This model RICLPM_inat1 did not converge, therefore random intercepts loadings will be fixed to 1 throughout all other models.*

***

### Fixed autoregressive and cross-lagged relations over time (RICLPM_inat2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPM2)

```{r specify RICLPM_inat2}
RICLPM_inat2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_inat2}
RICLPM_inat2.fit <- lavaan(RICLPM_inat2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_inat2.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_inat and RICLPM_inat2}
lavTestLRT(RICLPM_inat.fit, RICLPM_inat2.fit)
```

RICLPM_inat2 is significantly *worse* fit compared to RICLPM_inat. 

#### Constraining lag in ADHD parameter (RICLPM_inat2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPM_inat2a}
RICLPM_inat2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_inat2a}
RICLPM_inat2a.fit <- lavaan(RICLPM_inat2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_inat2a.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_inat and RICLPM_inat2a}
lavTestLRT(RICLPM_inat.fit, RICLPM_inat2a.fit)
```

RICLPM_inat2a is significantly *worse* fit compared to RICLPM_inat. Now we will constrain the other set of stability coefficients: lag in si (b)

#### Constraining lag in social isolation parameter (RICLPM_inat2b)

```{r specify RICLPM_inat2b}
RICLPM_inat2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_inat2b}
RICLPM_inat2b.fit <- lavaan(RICLPM_inat2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_inat2b.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_inat and RICLPM_inat2b}
lavTestLRT(RICLPM_inat.fit, RICLPM_inat2b.fit)
```

RICLPM_inat2b is significantly *worse* fit compared to RICLPM_inat. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPM_inat2c)

```{r specify RICLPM_inat2c}
RICLPM_inat2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_inat2c}
RICLPM_inat2c.fit <- lavaan(RICLPM_inat2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_inat2c.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_inat and RICLPM_inat2c}
lavTestLRT(RICLPM_inat.fit, RICLPM_inat2c.fit)
```

RICLPM_inat2c is *NOT* significantly worse fit compared to RICLPM_inat (p = 0.7238). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPM_inat2d) - **compared to RICLPM_inat2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPM_inat2d}
RICLPM_inat2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPM_inat2d}
RICLPM_inat2d.fit <- lavaan(RICLPM_inat2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_inat2d.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_inat2c and RICLPM_inat2d}
lavTestLRT(RICLPM_inat2c.fit, RICLPM_inat2d.fit) #comparing to other best fitting model
```

RICLPM_inat2d is *NOT* significantly worse fit compared to RICLPM_inat2c.fit (p = 0.756). 

**The best fitting model (mother report and inateractivity/impulsivity ADHD symptoms) is currently RICLPM2d where cross-lags are constrained to be equal across time.**

***

### Constrained grand means (RICLPM_inat3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPM_inat3}
RICLPM_inat3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*isolation_mother_05
  wsi7 =~ 1*isolation_mother_07
  wsi10 =~ 1*isolation_mother_10
  wsi12 =~ 1*isolation_mother_12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  inem5 + inem7 + inem10 + inem12 ~ mad*1
  isolation_mother_05 + isolation_mother_07 + isolation_mother_10 + isolation_mother_12 ~ msi*1
'
```

```{r fit RICLPM_inat3}
RICLPM_inat3.fit <- lavaan(RICLPM_inat3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE) 

summary(RICLPM_inat3.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

```{r LRT for RICLPM_inat and RICLPM_inat3}
lavTestLRT(RICLPM_inat.fit, RICLPM_inat3.fit) 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# Multiple reporter {.tabset .tabset-fade}

From [Mulder and Hamaker (2021)](https://www.tandfonline.com/doi/full/10.1080/10705511.2020.1784738): We include multiple indicators for each of the constructs (mother and teacher), while formulating the dynamics over time between the latent variables. There are two ways in which this can be done. First, a random intercept can be included for each indicator and these random intercepts are allowed to be correlated with each other. In addition, a common factor of the multiple indicators is included per occasion to capture the common within-unit variability over time. Second, the random intercepts can be included at the latent level as shown in the bottom panel of (e.g., Seddig, 2020). There is a common factor for each construct at each occasion, which is then being further decomposed into a time-invariant part captured by the random intercept, and a time-varying part that is used to model the within-unit dynamics. *These two approaches are nested with
the second being a special case of the first.*

To allow for a meaningful comparison of factors over time, the factor loadings should be time-invariant, such that there is **(at least)** weak factorial invariance over time (Meredith, 1993;
Millsap, 2011). If we are unable to establish this invariance, it implies that the constructs that we try to measure are interpreted differently over time, and it is difficult to make meaningful comparisons between the constructs measured at different occasions. The below steps need to be considered to establish longitudinal measurement invariance, and detail how the decomposition into within-unit and between-unit variance can be obtained in the context of multiple indicators.

- Step 1: the configural model (RICLPM_multi_S1)
- Step 2: weak factorial invariance 
- Step 3: strong factorial invariance
- Step 3a (Extra): strong factorial invariance with factor loadings equal to the within-person factor loadings 
- Step 4: the latent RI-CLPM

![Multiple indicator model from Mulder and Hamaker (2021)](/Users/katiethompson/Documents/PhD/LISS-DTP_Louise_and_Tim/Social isolation heritability_Paper 2/data_analysis/scripts/scripts_github/multi_model.jpeg)

## Step 1 (RICLPM_multi_S1) 

We have two indicators $X$, measured at four waves, we specify two random intercepts to capture the trait-like part of each indicator, that is, `RIX1 =~ 1*x11 1*x21 ...`, and `RIX2 =~ 1*x121 1*x22@1 ...`. In addition, we specify four within-unit components that capture the state-like part at each wave, using `WFX1 =~ x11 x12 x13; WFX2 =~ x21 x22 x23; ...`.

At the latent within-unit level, we specify the dynamic model using `WFX2 ~ WFY1 + WFX1; WFX3 ~ WFY2 + WFX2; ...`. In addition, we allow the within-person factors at the first wave, and their residuals at subsequent waves to be correlated within each wave, `WFX1 ~~ WFY1; WFX2 ~~ WFY2; ...`. The four random intercepts are allowed to be freely correlated with each other through `RIX1 + RIX2 + ... ~~ RIX1 + RIX2 + ...`. 

```{r specify RICLPM_multi_S1}
RICLPM_multi_S1 <- '
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each indicator (mother/teacher) separately
  RIadm =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12
  RIadt =~ 1*tadhdet5 + 1*tadhdet7 + 1*tadhdet10 + 1*tadhdet12
  
  RIsim =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12
  RIsit =~ 1*isolation_teacher_05 + 1*isolation_teacher_07 + 1*isolation_teacher_10 + 1*isolation_teacher_12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for adhd at 4 waves
  WFad5 =~ tadhdem5 + tadhdet5 
  WFad7 =~ tadhdem7 + tadhdet7 
  WFad10 =~ tadhdem10 + tadhdet10
  WFad12 =~ tadhdem12 + tadhdet12 
  
  # Factor models for social isolation at 4 waves
  WFsi5 =~ isolation_mother_05 + isolation_teacher_05 
  WFsi7 =~ isolation_mother_07 + isolation_teacher_07
  WFsi10 =~ isolation_mother_10 + isolation_teacher_10
  WFsi12 =~ isolation_mother_12 + isolation_teacher_12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFad7 + WFsi7 ~ WFad5 + WFsi5
  WFad10 + WFsi10 ~ WFad7 + WFsi7
  WFad12 + WFsi12 ~ WFad10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFad5 ~~ WFsi5
  WFad7 ~~ WFsi7
  WFad10 ~~ WFsi10 
  WFad12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIadm + RIadt + RIsim + RIsit ~~ 0*WFsi5 + 0*WFad5
'
```

```{r fit RICLPM_multi_S1}
RICLPM_multi_S1.fit <- cfa(RICLPM_multi_S1, 
                           data = dat, 
                           missing = 'ML')

summary(RICLPM_multi_S1.fit, 
        standardized = TRUE)
```

## Step 2 (RICLPM_multi_S2)

In second step, we constrain the factor loadings to be invariant over time using the labels `a*`, `b*`, `c*`, `d*`. 

```{r specify RICLPM_multi_S2}
RICLPM_multi_S2 <- '
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each indicator (mother/teacher) separately
  RIadm =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12
  RIadt =~ 1*tadhdet5 + 1*tadhdet7 + 1*tadhdet10 + 1*tadhdet12
  
  RIsim =~ 1*isolation_mother_05 + 1*isolation_mother_07 + 1*isolation_mother_10 + 1*isolation_mother_12
  RIsit =~ 1*isolation_teacher_05 + 1*isolation_teacher_07 + 1*isolation_teacher_10 + 1*isolation_teacher_12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for adhd at 4 waves (constrained)
  WFad5 =~ a*tadhdem5 + b*tadhdet5 
  WFad7 =~ a*tadhdem7 + b*tadhdet7 
  WFad10 =~ a*tadhdem10 + b*tadhdet10
  WFad12 =~ a*tadhdem12 + b*tadhdet12 
  
  # Factor models for social isolation at 4 waves (constrained)
  WFsi5 =~ c*isolation_mother_05 + d*isolation_teacher_05 
  WFsi7 =~ c*isolation_mother_07 + d*isolation_teacher_07
  WFsi10 =~ c*isolation_mother_10 + d*isolation_teacher_10
  WFsi12 =~ c*isolation_mother_12 + d*isolation_teacher_12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFad7 + WFsi7 ~ WFad5 + WFsi5
  WFad10 + WFsi10 ~ WFad7 + WFsi7
  WFad12 + WFsi12 ~ WFad10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFad5 ~~ WFsi5
  WFad7 ~~ WFsi7
  WFad10 ~~ WFsi10 
  WFad12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIadm + RIadt + RIsim + RIsit ~~ 0*WFsi5 + 0*WFad5
'
```

```{r fit RICLPM_multi_S2}
RICLPM_multi_S2.fit <- cfa(RICLPM_multi_S2, 
                           data = dat, 
                           missing = 'ML')

summary(RICLPM_multi_S2.fit, 
        standardized = TRUE)
```

**This model did not converge**

This could be due to issues with the data - missingness or skewness. But Mulder and Hamaker (2021) state that if we are unable to establish this measurement invariance, it implies that the constructs that we try to measure are interpreted differently over time, and it is **difficult to make meaningful comparisons between the constructs measured at different occasions.** I think to test measurement invariance truly, I will need the raw data points to look at factors of "mother" and "teacher" over time. 

### Longitudinal CFA to further test measurement invariance {.tabset .tabset-fade}

#### Social isolation

##### Configural invariance

```{r config invariance social isolation}
config.si <- '#factor loadings - NA stops setting first item as a loading of 1
          si05 =~ NA*isolation_mother_05 + a*isolation_mother_05 + isolation_teacher_05        #mother constrained to be the same over time 
          si07 =~ NA*isolation_mother_07 + a*isolation_mother_07 + isolation_teacher_07 
          si10 =~ NA*isolation_mother_10 + a*isolation_mother_10 + isolation_teacher_10 
          si12 =~ NA*isolation_mother_12 + a*isolation_mother_12 + isolation_teacher_12

          #means/intercepts
          si05 ~ 0*1                  #set the intercept of latent factor at the first time point to 0 by pre- multiplying the intercept (1) by 0. 
          si07 ~ start(0)*1           #specifying a starting value can assist with model convergence or reduce model run time
          si10 ~ start(0)*1
          si12 ~ start(0)*1
          isolation_mother_05 ~ b*1              #setting the intercepts to be equal across time
          isolation_mother_07 ~ b*1
          isolation_mother_10 ~ b*1
          isolation_mother_12 ~ b*1

          #variances/covariances
          si05 ~~ 1*si05
          si07 ~~ start(1)*si07
          si10 ~~ start(1)*si10
          si12 ~~ start(1)*si12
          isolation_mother_05 ~~ isolation_mother_07 + isolation_mother_10 + isolation_mother_12
          isolation_mother_07 ~~ isolation_mother_10 +  isolation_mother_12
          isolation_mother_10 ~~ isolation_mother_12
          isolation_teacher_05 ~~ isolation_teacher_07 + isolation_teacher_10 + isolation_teacher_12
          isolation_teacher_07 ~~ isolation_teacher_10 +  isolation_teacher_12
          isolation_teacher_10 ~~ isolation_teacher_12
         '

config.si.fit <- sem(config.si, 
                  data = dat, 
                  meanstructure = TRUE)

summary(config.si.fit, 
        fit.measures = TRUE, 
        estimates = TRUE)
```

As this is the first model in a series, we are primarily interested in model fit to the observed data:
Comparative Fit Index (CFI)                    1.000 ( 0.95)
Tucker-Lewis Index (TLI)                       0.996 ( 0.95)
Akaike (AIC)                               37246.048
Bayesian (BIC)                             37466.515
Sample-size adjusted Bayesian (BIC)        37333.097
RMSEA                                          0.016 ( 0.06)
SRMR                                           0.005 ( 0.08) 
- All measures indicate an excellent fit of the model to the data, and we conclude configural invariance holds. This implies the construct itself is the same over time, but we do not know if we can measure it comparably at each time point. Prior to examining model results in detail (e.g., loadings, variances, etc.) we must first evaluate higher forms of invariance. We will begin with weak invariance.
- **Important to note that this should be done with the raw scores, not total scores, but hopefully this can be added later.** 

#### Weak invariance 

Whereas configural invariance is satisfied if the same pattern of zero and non-zero parameter values holds across time, weak invariance requires that the numerical values of the factor loadings are equal over time within item. In effect, all we need to do is modify the prior chunk to impose equality constraints on all of the factor loadings, not simply for the mother items. Any parameter sharing the same label is constrained to be equal, so the extra pre-multiplication imposes equal factor loadings over time, implying weak invariance.

```{r weak invariance social isolation}
weak.invar.si <- '#factor loadings - NA stops setting first item as a loading of 1
          si05 =~ NA*isolation_mother_05 + a*isolation_mother_05 + b*isolation_teacher_05        #mother and teacher constrained to be the same over time 
          si07 =~ NA*isolation_mother_07 + a*isolation_mother_07 + b*isolation_teacher_07 
          si10 =~ NA*isolation_mother_10 + a*isolation_mother_10 + b*isolation_teacher_10 
          si12 =~ NA*isolation_mother_12 + a*isolation_mother_12 + b*isolation_teacher_12

          #means/intercepts
          si05 ~ 0*1                  #set the intercept of latent factor at the first time point to 0 by pre- multiplying the intercept (1) by 0. 
          si07 ~ start(0)*1           #specifying a starting value can assist with model convergence or reduce model run time
          si10 ~ start(0)*1
          si12 ~ start(0)*1
          isolation_mother_05 ~ c*1              #setting the intercepts to be equal across time
          isolation_mother_07 ~ c*1
          isolation_mother_10 ~ c*1
          isolation_mother_12 ~ c*1

          #variances/covariances
          si05 ~~ 1*si05
          si07 ~~ start(1)*si07
          si10 ~~ start(1)*si10
          si12 ~~ start(1)*si12
          isolation_mother_05 ~~ isolation_mother_07 + isolation_mother_10 + isolation_mother_12
          isolation_mother_07 ~~ isolation_mother_10 +  isolation_mother_12
          isolation_mother_10 ~~ isolation_mother_12
          isolation_teacher_05 ~~ isolation_teacher_07 + isolation_teacher_10 + isolation_teacher_12
          isolation_teacher_07 ~~ isolation_teacher_10 +  isolation_teacher_12
          isolation_teacher_10 ~~ isolation_teacher_12
         '

weak.invar.si.fit <- sem(weak.invar.si, 
                  data = dat, 
                  meanstructure = TRUE)

summary(weak.invar.si.fit, 
        fit.measures = TRUE, 
        estimates = TRUE)
```

We are primarily concerned with model fit at this point, so we focus on that output for the time being:
  Comparative Fit Index (CFI)                    0.993
  Tucker-Lewis Index (TLI)                       0.963
  Akaike (AIC)                               37258.035
  Bayesian (BIC)                             37462.754
  Sample-size adjusted Bayesian (BIC)        37338.866
  RMSEA                                          0.047
  SRMR                                           0.021
  
The overall fit of the weak invariance model remains excellent. 
We can compute the likelihood ratio test to compare the change in fit between the configural (config) and the weak (weak) invariance models:
  
```{r LRT config.si and weak.invar.si}
lavTestLRT(config.si.fit, weak.invar.si.fit)
```
  
Thus the LRT shows **significant loss in fit** associated with imposing equality on the factor loadings over time. 
Since weak invariance does not holds, we can NOT conclude that we are measuring the same construct over time, and we are NOT measuring this construct in comparable units. As we cannot show weak invariance, we cannot make comparisons between factor variances and covariances for social isolation. 

#### ADHD

##### Configural invariance

```{r config invariance ADHD}
config.ad <- '#factor loadings - NA stops setting first item as a loading of 1
          ad05 =~ NA*tadhdem5 + a*tadhdem5 + tadhdet5        #mother constrained to be the same over time 
          ad07 =~ NA*tadhdem7 + a*tadhdem7 + tadhdet7 
          ad10 =~ NA*tadhdem10 + a*tadhdem10 + tadhdet10 
          ad12 =~ NA*tadhdem12 + a*tadhdem12 + tadhdet12

          #means/intercepts
          ad05 ~ 0*1                  #set the intercept of latent factor at the first time point to 0 by pre- multiplying the intercept (1) by 0. 
          ad07 ~ start(0)*1           #specifying a starting value can assist with model convergence or reduce model run time
          ad10 ~ start(0)*1
          ad12 ~ start(0)*1
          tadhdem5 ~ b*1              #setting the intercepts to be equal across time
          tadhdem7 ~ b*1
          tadhdem10 ~ b*1
          tadhdem12 ~ b*1

          #variances/covariances
          ad05 ~~ 1*ad05
          ad07 ~~ start(1)*ad07
          ad10 ~~ start(1)*ad10
          ad12 ~~ start(1)*ad12
          tadhdem5 ~~ tadhdem7 + tadhdem10 + tadhdem12
          tadhdem7 ~~ tadhdem10 +  tadhdem12
          tadhdem10 ~~ tadhdem12
          tadhdet5 ~~ tadhdet7 + tadhdet10 + tadhdet12
          tadhdet7 ~~ tadhdet10 +  tadhdet12
          tadhdet10 ~~ tadhdet12
         '

config.ad.fit <- sem(config.ad, 
                  data = dat, 
                  meanstructure = TRUE)

summary(config.ad.fit, 
        fit.measures = TRUE, 
        estimates = TRUE)
```

As this is the first model in a series, we are primarily interested in model fit to the observed data:
Comparative Fit Index (CFI)                    0.995 ( 0.95)
Tucker-Lewis Index (TLI)                       0.936 ( 0.95)
Akaike (AIC)                               50113.037
Bayesian (BIC)                             50331.392
Sample-size adjusted Bayesian (BIC)        50197.977
RMSEA                                          0.078 ( 0.06)
SRMR                                           0.012 ( 0.08) 
- All measures indicate an adequate fit of the model to the data, and we conclude configural invariance holds (just!). This implies the construct itself is the same over time, but we do not know if we can measure it comparably at each time point. Prior to examining model results in detail (e.g., loadings, variances, etc.) we must first evaluate higher forms of invariance. We will begin with weak invariance.
- **Important to note that this should be done with the raw scores, not total scores, but hopefully this can be added later.** 

#### Weak invariance 

```{r weak invariance ADHD}
weak.invar.ad <- '#factor loadings - NA stops setting first item as a loading of 1
          ad05 =~ NA*tadhdem5 + a*tadhdem5 + b*tadhdet5        #mother constrained to be the same over time 
          ad07 =~ NA*tadhdem7 + a*tadhdem7 + b*tadhdet7 
          ad10 =~ NA*tadhdem10 + a*tadhdem10 + b*tadhdet10 
          ad12 =~ NA*tadhdem12 + a*tadhdem12 + b*tadhdet12

          #means/intercepts
          ad05 ~ 0*1                  #set the intercept of latent factor at the first time point to 0 by pre- multiplying the intercept (1) by 0. 
          ad07 ~ start(0)*1           #specifying a starting value can assist with model convergence or reduce model run time
          ad10 ~ start(0)*1
          ad12 ~ start(0)*1
          tadhdem5 ~ c*1              #setting the intercepts to be equal across time
          tadhdem7 ~ c*1
          tadhdem10 ~ c*1
          tadhdem12 ~ c*1

          #variances/covariances
          ad05 ~~ 1*ad05
          ad07 ~~ start(1)*ad07
          ad10 ~~ start(1)*ad10
          ad12 ~~ start(1)*ad12
          tadhdem5 ~~ tadhdem7 + tadhdem10 + tadhdem12
          tadhdem7 ~~ tadhdem10 +  tadhdem12
          tadhdem10 ~~ tadhdem12
          tadhdet5 ~~ tadhdet7 + tadhdet10 + tadhdet12
          tadhdet7 ~~ tadhdet10 +  tadhdet12
          tadhdet10 ~~ tadhdet12
         '

weak.invar.ad.fit <- sem(weak.invar.ad, 
                  data = dat, 
                  meanstructure = TRUE)

summary(weak.invar.ad.fit, 
        fit.measures = TRUE, 
        estimates = TRUE)
```

Comparative Fit Index (CFI)                    0.987
Tucker-Lewis Index (TLI)                       0.928
Akaike (AIC)                               50140.000
Bayesian (BIC)                             50342.758
Sample-size adjusted Bayesian (BIC)        50218.872
RMSEA                                          0.083
SRMR                                           0.033

Still adequate fit. 

We can compute the likelihood ratio test to compare the change in fit between the configural (config) and the weak (weak) invariance models:
  
```{r LRT config.ad and weak.invar.ad}
lavTestLRT(config.ad.fit, weak.invar.ad.fit)
```
  
Thus the LRT shows **significant loss in fit** associated with imposing equality on the factor loadings over time. 
Since weak invariance does not holds, we can NOT conclude that we are measuring the same construct over time, and we are NOT measuring this construct in comparable units. As we cannot show weak invariance, we cannot make comparisons between factor variances and covariances for ADHD. 

***

# NEXT STEPS

- Use raw scores to look at measurement invariance across time. Does weak invariance hold when only looking at mother report? If so, may only use those reports??
- Do some reading around assessing measurement invariance when using different reporters across time (different teachers).
















