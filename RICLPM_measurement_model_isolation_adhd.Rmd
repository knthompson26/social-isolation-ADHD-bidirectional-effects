---
title: "RICLPM with factor measurement model for social isolation and ADHD symptoms in childhood"
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: hide
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'asis')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(lavaan)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path, include=FALSE}
#source raw data directory: data_raw and data included
source("../isolation_ADHD_data_path.R")
```

```{r read in dta data file}
dat.raw <- read_dta(paste0(data.raw_path, "Katie_19Jan22.dta"))
colnames(dat.raw)

dat <- dat.raw %>%
  dplyr::select(id = atwinid,
         pe2m5,   # social isolation mother report raw items (elder variables)
         pe4m5,
         pe7m5,
         pe11m5,
         pe13m5,
         pe25m5,
         trf11e5, # social isolation teacher report raw items (elder variables)
         trf19e5,
         trf24e5,
         trf30e5,
         trf34e5,
         trf77e5,
         pe2m7,   # social isolation mother report raw items (elder variables)
         pe4m7,
         pe7m7,
         pe11m7,
         pe13m7,
         pe25m7,
         trf11e7, # social isolation teacher report raw items (elder variables)
         trf19e7,
         trf24e7,
         trf30e7,
         trf34e7,
         trf77e7,
         pe2m10,   # social isolation mother report raw items (elder variables)
         pe4m10,
         pe7m10,
         pe11m10,
         pe13m10,
         pe25m10,
         trf11e10, # social isolation teacher report raw items (elder variables)
         trf19e10,
         trf24e10,
         trf30e10,
         trf34e10,
         trf77e10,
         pe2m12,   # social isolation mother report raw items (elder variables)
         pe4m12,
         pe7m12,
         pe11m12,
         pe13m12,
         pe25m12,
         trf11e12, # social isolation teacher report raw items (elder variables)
         trf19e12,
         trf24e12,
         trf30e12,
         trf34e12,
         trf77e12,
         pe81m5,  # Inattention mother report raw items (elder variables)
         pe82m5,
         pe83m5,
         pe86m5,
         pe87m5,
         pe88m5,
         pe89m5,
         pe90m5,
         pe91m5,
         pe81m7,  # Inattention mother report raw items (elder variables)
         pe82m7,
         pe83m7,
         pe86m7,
         pe87m7,
         pe88m7,
         pe89m7,
         pe90m7,
         pe91m7,
         pe81m10,  # Inattention mother report raw items (elder variables)
         pe82m10,
         pe83m10,
         pe86m10,
         pe87m10,
         pe88m10,
         pe89m10,
         pe90m10,
         pe91m10,
         pe81m12,  # Inattention mother report raw items (elder variables)
         pe82m12,
         pe83m12,
         pe86m12,
         pe87m12,
         pe88m12,
         pe89m12,
         pe90m12,
         pe91m12,
         trf89e5,  # Inattention teacher report raw items (elder variables)
         trf90e5,
         trf91e5,
         trf94e5,
         trf95e5,
         trf96e5,
         trf97e5,
         trf98e5,
         trf99e5,
         trf89e7,  # Inattention teacher report raw items (elder variables)
         trf90e7,
         trf91e7,
         trf94e7,
         trf95e7,
         trf96e7,
         trf97e7,
         trf98e7,
         trf99e7,
         trf89e10,  # Inattention teacher report raw items (elder variables)
         trf90e10,
         trf91e10,
         trf94e10,
         trf95e10,
         trf96e10,
         trf97e10,
         trf98e10,
         trf99e10,
         trf89e12,  # Inattention teacher report raw items (elder variables)
         trf90e12,
         trf91e12,
         trf94e12,
         trf95e12,
         trf96e12,
         trf97e12,
         trf98e12,
         trf99e12, 
         pe84m5,    # Hyperactivity/impulsivity mother report raw items (elder variables)
         pe85m5,
         pe96m5,
         pe97m5,
         pe92m5,   
         pe93m5, 
         pe94m5, 
         pe95m5,
         pe64m5,
         pe84m7,    # Hyperactivity/impulsivity mother report raw items (elder variables)
         pe85m7,
         pe96m7,
         pe97m7, 
         pe92m7, 
         pe93m7, 
         pe94m7, 
         pe95m7, 
         pe64m7,
         pe84m10,    # Hyperactivity/impulsivity mother report raw items (elder variables)
         pe85m10,
         pe96m10,
         pe97m10, 
         pe92m10, 
         pe93m10, 
         pe94m10, 
         pe95m10, 
         pe64m10,
         pe84m12,    # Hyperactivity/impulsivity mother report raw items (elder variables)
         pe85m12,
         pe96m12,
         pe97m12, 
         pe92m12, 
         pe93m12, 
         pe94m12, 
         pe95m12, 
         pe64m12,
         trf92e5,   # Hyperactivity/impulsivity teacher report raw items (elder variables)
         trf93e5,
         trf104e5,
         trf105e5,
         trf100e5,
         trf101e5,
         trf102e5,
         trf103e5,
         trf66e5,
         trf92e7,   # Hyperactivity/impulsivity teacher report raw items (elder variables)
         trf93e7,
         trf104e7,
         trf105e7,
         trf100e7,
         trf101e7,
         trf102e7,
         trf103e7,
         trf66e7,
         trf92e10,   # Hyperactivity/impulsivity teacher report raw items (elder variables)
         trf93e10,
         trf104e10,
         trf105e10,
         trf100e10,
         trf101e10,
         trf102e10,
         trf103e10,
         trf66e10,
         trf92e12,   # Hyperactivity/impulsivity teacher report raw items (elder variables)
         trf93e12,
         trf104e12,
         trf105e12,
         trf100e12,
         trf101e12,
         trf102e12,
         trf103e12,
         trf66e12  
  )

colnames(dat)
```

# Cronbach alpha for social isolation items 

```{r identifying items}
isolation.mother.age5 <- c("pe2m5", "pe4m5", "pe7m5", "pe11m5", "pe13m5", "pe25m5")
isolation.mother.age7 <- c("pe2m7", "pe4m7", "pe7m7", "pe11m7", "pe13m7", "pe25m7")
isolation.mother.age10 <- c("pe2m10", "pe4m10", "pe7m10", "pe11m10", "pe13m10", "pe25m10")
isolation.mother.age12 <- c("pe2m12", "pe4m12", "pe7m12", "pe11m12", "pe13m12", "pe25m12")

isolation.teacher.age5 <- c( "trf11e5", "trf19e5","trf24e5","trf30e5","trf34e5","trf77e5")
isolation.teacher.age7 <- c( "trf11e7", "trf19e7","trf24e7","trf30e7","trf34e7","trf77e7")
isolation.teacher.age10 <- c( "trf11e10", "trf19e10","trf24e10","trf30e10","trf34e10","trf77e10")
isolation.teacher.age12 <- c( "trf11e12", "trf19e12","trf24e12","trf30e12","trf34e12","trf77e12")
```

```{r cronbach alpha}
# mother report
cronbach.alpha(dat[isolation.mother.age5], standardized = TRUE, CI = TRUE, na.rm = TRUE)
cronbach.alpha(dat[isolation.mother.age7], standardized = TRUE, CI = TRUE, na.rm = TRUE)
cronbach.alpha(dat[isolation.mother.age10], standardized = TRUE, CI = TRUE, na.rm = TRUE)
cronbach.alpha(dat[isolation.mother.age12], standardized = TRUE, CI = TRUE, na.rm = TRUE)
# teacher report
cronbach.alpha(dat[isolation.teacher.age5], standardized = TRUE, CI = TRUE, na.rm = TRUE)
cronbach.alpha(dat[isolation.teacher.age7], standardized = TRUE, CI = TRUE, na.rm = TRUE)
cronbach.alpha(dat[isolation.teacher.age10], standardized = TRUE, CI = TRUE, na.rm = TRUE)
cronbach.alpha(dat[isolation.teacher.age12], standardized = TRUE, CI = TRUE, na.rm = TRUE)
```

Teacher report Cronbach's alpha (standardized): 0.596
Mother report Cronbach's alpha (standardized): 0.785


The loaded data is for se = robust and listwise deletion models.
Need to create a new saved dataset where all models are robust standard errors and pairwise deletion. 
For now the robust standard errors isn't computing for the pairwise deletion (I think this is an issue with the package). *So all models have se='robust' hashed out for now.*
```{r load saved environment with models run}
#load("../measurement_environment.RData")
```

# All RI-CLPM models displayed here **This needs to be updated**

| Model                 | Description                                                                                                                    |
| --------------------- | -----------------------------------------------------------------------------------------------------------------------------  |
| RICLPM_multi_inat_S1  |  RI-CLPM model using latent factors for **mother report** ratings for AD and SI, and **total ADHD** scores, Step 1             |

***

# Multiple indicator RI-CLPM 

From [Mulder and Hamaker (2021)](https://www.tandfonline.com/doi/full/10.1080/10705511.2020.1784738): We include multiple indicators for each of the constructs (mother and teacher), while formulating the dynamics over time between the latent variables. There are two ways in which this can be done. First, a random intercept can be included for each indicator and these random intercepts are allowed to be correlated with each other. In addition, a common factor of the multiple indicators is included per occasion to capture the common within-unit variability over time. Second, the random intercepts can be included at the latent level as shown in the bottom panel of (e.g., Seddig, 2020). There is a common factor for each construct at each occasion, which is then being further decomposed into a time-invariant part captured by the random intercept, and a time-varying part that is used to model the within-unit dynamics. *These two approaches are nested with the second being a special case of the first.*

To allow for a meaningful comparison of factors over time, the factor loadings should be time-invariant, such that there is **(at least)** weak factorial invariance over time (Meredith, 1993; Millsap, 2011). If we are unable to establish this invariance, it implies that the constructs that we try to measure are interpreted differently over time, and it is difficult to make meaningful comparisons between the constructs measured at different occasions. The below steps need to be considered to establish longitudinal measurement invariance, and detail how the decomposition into within-unit and between-unit variance can be obtained in the context of multiple indicators.

- Step 1: the configural model (RICLPM_multi_S1)
- Step 2: weak factorial invariance  (RICLPM_multi_S2)
- Step 3: strong factorial invariance  (RICLPM_multi_S3)
- Step 4: the latent RI-CLPM (RICLPM_multi_S4)

![Multiple indicator model from Mulder and Hamaker (2021)](/Users/katiethompson/Documents/PhD/LISS-DTP_Louise_and_Tim/Social isolation heritability_Paper 2/data_analysis/scripts/scripts_github/multi_model.jpeg)

***

# Mother report RI-CLPM: Inattention and social isolation

## RICLPM_multi_inat_S1: Inattention step 1

**Multiple response items RICLPM mother report inattention ADHD symptoms and social isolation: Step 1, the configural model**  

The configural model is the least stringent test of invariance, it is designed to test if the constructs have the same pattern of free and fixed loadings. Configural *non*invariance means that the pattern of loadings of items on the latent factors differs over the time points. This would then suggest that a slightly different concept is being measured at each time point (Putnick and Bornstein, 2016). To test if the configural variance holds, we will look at the fit of the configural model (S1).

We have six indicators of $Social isolation$, measured at four waves, we specify six random intercepts to capture the trait-like part of each indicator, that is, `RIX1 =~ 1*x11 1*x21 ...`, and `RIX2 =~ 1*x121 1*x22@1 ...`. In addition, we specify four within-unit components that capture the state-like part at each wave, using `WFX1 =~ x11 x12 x13; WFX2 =~ x21 x22 x23; ...`.

At the latent within-unit level, we specify the dynamic model using `WFX2 ~ WFY1 + WFX1; WFX3 ~ WFY2 + WFX2; ...`. In addition, we allow the within-person factors at the first wave, and their residuals at subsequent waves to be correlated within each wave, `WFX1 ~~ WFY1; WFX2 ~~ WFY2; ...`. The random intercepts are allowed to be freely correlated with each other through using the cfa() command below. 

**At the moment all models are using pairwise deletion**

```{r specify RICLPM_multi_inat_S1}
RICLPM_multi_inat_S1 <- '
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of inattention (mother report)
  RIinat1 =~ 1*pe81m5 + 1*pe81m7 + 1*pe81m10 + 1*pe81m12
  RIinat2 =~ 1*pe82m5 + 1*pe82m7 + 1*pe82m10 + 1*pe82m12
  RIinat3 =~ 1*pe83m5 + 1*pe83m7 + 1*pe83m10 + 1*pe83m12
  RIinat4 =~ 1*pe86m5 + 1*pe86m7 + 1*pe86m10 + 1*pe86m12
  RIinat5 =~ 1*pe87m5 + 1*pe87m7 + 1*pe87m10 + 1*pe87m12
  RIinat6 =~ 1*pe88m5 + 1*pe88m7 + 1*pe88m10 + 1*pe88m12
  RIinat7 =~ 1*pe89m5 + 1*pe89m7 + 1*pe89m10 + 1*pe89m12
  RIinat8 =~ 1*pe90m5 + 1*pe90m7 + 1*pe90m10 + 1*pe90m12
  RIinat9 =~ 1*pe91m5 + 1*pe91m7 + 1*pe91m10 + 1*pe91m12
  
  # Create between factors (random intercepts) for each item of social isolation (mother report)
  RIsi1 =~ 1*pe2m5 + 1*pe2m7 + 1*pe2m10 + 1*pe2m12 
  RIsi2 =~ 1*pe4m5 + 1*pe4m7 + 1*pe4m10 + 1*pe4m12
  RIsi3 =~ 1*pe7m5 + 1*pe7m7 + 1*pe7m10 + 1*pe7m12
  RIsi4 =~ 1*pe11m5 + 1*pe11m7 + 1*pe11m10 + 1*pe11m12
  RIsi5 =~ 1*pe13m5 + 1*pe13m7 + 1*pe13m10 + 1*pe13m12
  RIsi6 =~ 1*pe25m5 + 1*pe25m7 + 1*pe25m10 + 1*pe25m12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for inattention symptoms at 4 waves
  WFinat5 =~ pe81m5 + pe82m5 + pe83m5 + pe86m5 + pe87m5 + pe88m5 + pe89m5 + pe90m5 + pe91m5
  WFinat7 =~ pe81m7 + pe82m7 + pe83m7 + pe86m7 + pe87m7 + pe88m7 + pe89m7 + pe90m7 + pe91m7
  WFinat10 =~ pe81m10 + pe82m10 + pe83m10 + pe86m10 + pe87m10 + pe88m10 + pe89m10 + pe90m10 + pe91m10
  WFinat12 =~ pe81m12 + pe82m12 + pe83m12 + pe86m12 + pe87m12 + pe88m12 + pe89m12 + pe90m12 + pe91m12 
  
  # Factor models for social isolation at 4 waves
  WFsi5 =~ pe2m5 + pe4m5 + pe7m5 + pe11m5 + pe13m5 + pe25m5 
  WFsi7 =~ pe2m7 + pe4m7 + pe7m7 + pe11m7 + pe13m7 + pe25m7 
  WFsi10 =~ pe2m10 + pe4m10 + pe7m10 + pe11m10 + pe13m10 + pe25m10
  WFsi12 =~ pe2m12 + pe4m12 + pe7m12 + pe11m12 + pe13m12 + pe25m12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFinat7 + WFsi7 ~ WFinat5 + WFsi5
  WFinat10 + WFsi10 ~ WFinat7 + WFsi7
  WFinat12 + WFsi12 ~ WFinat10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFinat5 ~~ WFsi5
  WFinat7 ~~ WFsi7
  WFinat10 ~~ WFsi10 
  WFinat12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIinat1 + RIinat2 + RIinat3 + RIinat4 + RIinat5 + RIinat6 + RIinat7 + RIinat8 + RIinat9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFinat5
'
```

When running se = "robust" the error comes up as: Error in inherits(NVarCov, "try-error") : object 'NVarCov' not found
Not sure how to fix this so for the moment running without robust standard errors. 

```{r fit RICLPM_multi_inat_S1}
RICLPM_multi_inat_S1.fit <- cfa(RICLPM_multi_inat_S1, 
                           data = dat, 
                        #   se = "robust",         # computes robust standard errors to account for use of twins
                           ordered = TRUE,        # using the "ordered" option will use DWLS with polychoric correlations for the ordinal variables
                           missing = 'pairwise'    # only excludes people who are missing both variables
)

summary(RICLPM_multi_inat_S1.fit, fit.measures = TRUE, standardized = TRUE)
```

For the listwise deletion model:
S1 Model fit (robust indices):
Comparative Fit Index (CFI)                    0.990 (>0.95)
Tucker-Lewis Index (TLI)                       0.998 (>0.95)      
RMSEA                                          0.016 (≤ 0.06)         
90 Percent confidence interval - lower         0.015 
90 Percent confidence interval - upper         0.017       
SRMR                                           0.033 (≤ 0.08)      

We can conclude that the model shows very good fit. 

## RICLPM_multi_inat_S2: Inattention step 2 

**Multiple response items RICLPM mother report inattention ADHD symptoms and social isolation: Step 2**.
If configural variance is supported, we next test for weak invariance (sometimes called metric invariance). This tests for the equivalence of the item loadings on the factors. Weak (metric) invariance means that each item contributes to the latent construct to a similar degree across groups. this is tested by constraining factor loadings (i.e., the loadings of the items on the constructs) to be equivalent in the two time points (Putnick and Bornstein, 2016). The model with constrained factor loadings (S2) is then compared to the configural invariance model (S1) to determine fit. If the overall model fit is significantly worse in the weak invariance model compared to the configural invariance model, it indicates that at least one loading is not equivalent across the groups, and weak invariance is not supported.

In our second step model, we constrain the factor loadings to be invariant over time using the labels `a*`, `b*`, `c*`, `d*` etc, in the "within" part of the model. 

```{r specify RICLPM_multi_inat_S2}
RICLPM_multi_inat_S2 <- '
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of inattention (mother report)
  RIinat1 =~ 1*pe81m5 + 1*pe81m7 + 1*pe81m10 + 1*pe81m12
  RIinat2 =~ 1*pe82m5 + 1*pe82m7 + 1*pe82m10 + 1*pe82m12
  RIinat3 =~ 1*pe83m5 + 1*pe83m7 + 1*pe83m10 + 1*pe83m12
  RIinat4 =~ 1*pe86m5 + 1*pe86m7 + 1*pe86m10 + 1*pe86m12
  RIinat5 =~ 1*pe87m5 + 1*pe87m7 + 1*pe87m10 + 1*pe87m12
  RIinat6 =~ 1*pe88m5 + 1*pe88m7 + 1*pe88m10 + 1*pe88m12
  RIinat7 =~ 1*pe89m5 + 1*pe89m7 + 1*pe89m10 + 1*pe89m12
  RIinat8 =~ 1*pe90m5 + 1*pe90m7 + 1*pe90m10 + 1*pe90m12
  RIinat9 =~ 1*pe91m5 + 1*pe91m7 + 1*pe91m10 + 1*pe91m12
  
  # Create between factors (random intercepts) for each item of social isolation (mother report)
  RIsi1 =~ 1*pe2m5 + 1*pe2m7 + 1*pe2m10 + 1*pe2m12 
  RIsi2 =~ 1*pe4m5 + 1*pe4m7 + 1*pe4m10 + 1*pe4m12
  RIsi3 =~ 1*pe7m5 + 1*pe7m7 + 1*pe7m10 + 1*pe7m12
  RIsi4 =~ 1*pe11m5 + 1*pe11m7 + 1*pe11m10 + 1*pe11m12
  RIsi5 =~ 1*pe13m5 + 1*pe13m7 + 1*pe13m10 + 1*pe13m12
  RIsi6 =~ 1*pe25m5 + 1*pe25m7 + 1*pe25m10 + 1*pe25m12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for inattention symptoms at 4 waves (constrained)
  WFinat5 =~ a*pe81m5 + b*pe82m5 + c*pe83m5 + d*pe86m5 + e*pe87m5 + f*pe88m5 + g*pe89m5 + h*pe90m5 + i*pe91m5
  WFinat7 =~ a*pe81m7 + b*pe82m7 + c*pe83m7 + d*pe86m7 + e*pe87m7 + f*pe88m7 + g*pe89m7 + h*pe90m7 + i*pe91m7
  WFinat10 =~ a*pe81m10 + b*pe82m10 + c*pe83m10 + d*pe86m10 + e*pe87m10 + f*pe88m10 + g*pe89m10 + h*pe90m10 + i*pe91m10
  WFinat12 =~ a*pe81m12 + b*pe82m12 + c*pe83m12 + d*pe86m12 + e*pe87m12 + f*pe88m12 + g*pe89m12 + h*pe90m12 + i*pe91m12 
  
  # Factor models for social isolation at 4 waves (constrained)
  WFsi5 =~ j*pe2m5 + k*pe4m5 + l*pe7m5 + m*pe11m5 + n*pe13m5 + o*pe25m5 
  WFsi7 =~ j*pe2m7 + k*pe4m7 + l*pe7m7 + m*pe11m7 + n*pe13m7 + o*pe25m7 
  WFsi10 =~ j*pe2m10 + k*pe4m10 + l*pe7m10 + m*pe11m10 + n*pe13m10 + o*pe25m10
  WFsi12 =~ j*pe2m12 + k*pe4m12 + l*pe7m12 + m*pe11m12 + n*pe13m12 + o*pe25m12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFinat7 + WFsi7 ~ WFinat5 + WFsi5
  WFinat10 + WFsi10 ~ WFinat7 + WFsi7
  WFinat12 + WFsi12 ~ WFinat10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFinat5 ~~ WFsi5
  WFinat7 ~~ WFsi7
  WFinat10 ~~ WFsi10 
  WFinat12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIinat1 + RIinat2 + RIinat3 + RIinat4 + RIinat5 + RIinat6 + RIinat7 + RIinat8 + RIinat9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFinat5
'
```

```{r fit RICLPM_multi_inat_S2}
RICLPM_multi_inat_S2.fit <- cfa(RICLPM_multi_inat_S2, 
                           data = dat, 
                          # se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

summary(RICLPM_multi_inat_S2.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S2 Model fit:
(We have included here the change in CFI, TLI and RMSEA compared to the S1 model)
Comparative Fit Index (CFI)                    0.991 (>0.95)    Change in CFI:   0.001 (increase) - better fit 
Tucker-Lewis Index (TLI)                       0.990 (>0.95)    Change in TLI:   0.001 (increase) - better fit 
RMSEA                                          0.015 (≤ 0.06)   Change in RMSEA: 0.001 (decrease) - better fit
90 Percent confidence interval - lower         0.014 
90 Percent confidence interval - upper         0.016       
SRMR                                           0.036 (≤ 0.08)   Change in SRMR: 0.003 (increase)  - worse fit (to be expected)

We can look at the best fitting model and the difference in fit indices by using the compareFit function from semTools. 

```{r compare fit RICLPM_multi_inat_S1 and RICLPM_multi_inat_S2}
summary(semTools::compareFit(RICLPM_multi_inat_S1.fit, RICLPM_multi_inat_S2.fit, nested = TRUE)) #† indicates the best fitting model - using the robust statistics
```

Now we need to conduct a Likelihood ratio test to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. 

Really important to note that the Chi Square p value is very likely to be significant when using large samples. We should consider the change in model fit as well as the Chi square.

```{r LRT for RICLPM_multi_inat_S1 and RICLPM_multi_inat_S2}
lavTestLRT(RICLPM_multi_inat_S1.fit, RICLPM_multi_inat_S2.fit)
```

Significantly worse fit to include the restrictions, p=0.001017.

**However this is almost never going to be nonsignificant, we can assume here that because the S2 model did not show substantial decrease in model fit (actually showed better fit than the S1 model), that weak invariance holds here.**

Now we will move onto strong invariance tests. 

## RICLPM_multi_inat_S3: Inattention step 3

**Multiple response items RICLPM mother report inattention ADHD symptoms and social isolation: Step 3** 

As full or partial weak invariance is supported, the next step is to test for strong (scalar) invariance, or equivalence of item intercepts, for weak invariant items. Strong invariance means that mean differences in the latent construct capture all mean differences in the shared variance of the items. Strong invariance is tested by constraining the item intercepts to be equivalent in the two groups - with the restraint applied in the weak invariance model retained. *Any items that had unequal loadings in the weak invariance model (and were allowed to vary) should be allowed to vary in the strong invariance model because it is meaningless to test for equal item intercepts if the factor loadings of the items differs across groups* (Putnick and Bornstein, 2016). 

Fitting a model with constraints to ensure strong factorial invariance, with a random intercept for each indicator separately.

```{r specify RICLPM_multi_inat_S3}
RICLPM_multi_inat_S3 <- '
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of inattention (mother report)
  RIinat1 =~ 1*pe81m5 + 1*pe81m7 + 1*pe81m10 + 1*pe81m12
  RIinat2 =~ 1*pe82m5 + 1*pe82m7 + 1*pe82m10 + 1*pe82m12
  RIinat3 =~ 1*pe83m5 + 1*pe83m7 + 1*pe83m10 + 1*pe83m12
  RIinat4 =~ 1*pe86m5 + 1*pe86m7 + 1*pe86m10 + 1*pe86m12
  RIinat5 =~ 1*pe87m5 + 1*pe87m7 + 1*pe87m10 + 1*pe87m12
  RIinat6 =~ 1*pe88m5 + 1*pe88m7 + 1*pe88m10 + 1*pe88m12
  RIinat7 =~ 1*pe89m5 + 1*pe89m7 + 1*pe89m10 + 1*pe89m12
  RIinat8 =~ 1*pe90m5 + 1*pe90m7 + 1*pe90m10 + 1*pe90m12
  RIinat9 =~ 1*pe91m5 + 1*pe91m7 + 1*pe91m10 + 1*pe91m12
  
  # Create between factors (random intercepts) for each item of social isolation (mother report)
  RIsi1 =~ 1*pe2m5 + 1*pe2m7 + 1*pe2m10 + 1*pe2m12 
  RIsi2 =~ 1*pe4m5 + 1*pe4m7 + 1*pe4m10 + 1*pe4m12
  RIsi3 =~ 1*pe7m5 + 1*pe7m7 + 1*pe7m10 + 1*pe7m12
  RIsi4 =~ 1*pe11m5 + 1*pe11m7 + 1*pe11m10 + 1*pe11m12
  RIsi5 =~ 1*pe13m5 + 1*pe13m7 + 1*pe13m10 + 1*pe13m12
  RIsi6 =~ 1*pe25m5 + 1*pe25m7 + 1*pe25m10 + 1*pe25m12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for inattention symptoms at 4 waves (constrained)
  WFinat5 =~ a*pe81m5 + b*pe82m5 + c*pe83m5 + d*pe86m5 + e*pe87m5 + f*pe88m5 + g*pe89m5 + h*pe90m5 + i*pe91m5
  WFinat7 =~ a*pe81m7 + b*pe82m7 + c*pe83m7 + d*pe86m7 + e*pe87m7 + f*pe88m7 + g*pe89m7 + h*pe90m7 + i*pe91m7
  WFinat10 =~ a*pe81m10 + b*pe82m10 + c*pe83m10 + d*pe86m10 + e*pe87m10 + f*pe88m10 + g*pe89m10 + h*pe90m10 + i*pe91m10
  WFinat12 =~ a*pe81m12 + b*pe82m12 + c*pe83m12 + d*pe86m12 + e*pe87m12 + f*pe88m12 + g*pe89m12 + h*pe90m12 + i*pe91m12 
  
  # Factor models for social isolation at 4 waves (constrained)
  WFsi5 =~ j*pe2m5 + k*pe4m5 + l*pe7m5 + m*pe11m5 + n*pe13m5 + o*pe25m5 
  WFsi7 =~ j*pe2m7 + k*pe4m7 + l*pe7m7 + m*pe11m7 + n*pe13m7 + o*pe25m7 
  WFsi10 =~ j*pe2m10 + k*pe4m10 + l*pe7m10 + m*pe11m10 + n*pe13m10 + o*pe25m10
  WFsi12 =~ j*pe2m12 + k*pe4m12 + l*pe7m12 + m*pe11m12 + n*pe13m12 + o*pe25m12
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  pe81m5 + pe81m7 + pe81m10 + pe81m12 ~ p*1
  pe82m5 + pe82m7 + pe82m10 + pe82m12 ~ q*1
  pe83m5 + pe83m7 + pe83m10 + pe83m12 ~ r*1
  pe86m5 + pe86m7 + pe86m10 + pe86m12 ~ s*1
  pe87m5 + pe87m7 + pe87m10 + pe87m12 ~ t*1
  pe88m5 + pe88m7 + pe88m10 + pe88m12 ~ u*1
  pe89m5 + pe89m7 + pe89m10 + pe89m12 ~ v*1
  pe90m5 + pe90m7 + pe90m10 + pe90m12 ~ w*1
  pe91m5 + pe91m7 + pe91m10 + pe91m12 ~ x*1
  
  pe2m5 + pe2m7 + pe2m10 + pe2m12 ~ y*1
  pe4m5 + pe4m7 + pe4m10 + pe4m12 ~ z*1
  pe7m5 + pe7m7 + pe7m10 + pe7m12 ~ aa*1
  pe11m5 + pe11m7 + pe11m10 + pe11m12 ~ ab*1
  pe13m5 + pe13m7 + pe13m10 + pe13m12 ~ ac*1
  pe25m5 + pe25m7 + pe25m10 + pe25m12 ~ ad*1
  
  # Free latent means from timepoint = 2 (age 7) onward. 
  # Only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  WFinat7 + WFinat10 + WFinat12 + WFsi7 + WFsi10 + WFsi12 ~ 1
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFinat7 + WFsi7 ~ WFinat5 + WFsi5
  WFinat10 + WFsi10 ~ WFinat7 + WFsi7
  WFinat12 + WFsi12 ~ WFinat10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFinat5 ~~ WFsi5
  WFinat7 ~~ WFsi7
  WFinat10 ~~ WFsi10 
  WFinat12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIinat1 + RIinat2 + RIinat3 + RIinat4 + RIinat5 + RIinat6 + RIinat7 + RIinat8 + RIinat9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFinat5
'
```

```{r fit RICLPM_multi_inat_S3}
RICLPM_multi_inat_S3.fit <- cfa(RICLPM_multi_inat_S3, 
                           data = dat, 
                       #    se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise')

RICLPM_multi_inat_S3.fit.summary <- summary(RICLPM_multi_inat_S3.fit, 
                                            fit.measures = TRUE,
                                            standardized = TRUE)
```  

S3 Model fit:
(We have included here the change in CFI, TLI and RMSEA compared to the S1 model)
Comparative Fit Index (CFI)                    0.991 (>0.95)    Change in CFI:   0.000 (decrease)
Tucker-Lewis Index (TLI)                       0.990 (>0.95)    Change in TLI:   0.000 (decrease)
RMSEA                                          0.015 (≤ 0.06)   Change in RMSEA: 0.000 (increase)
90 Percent confidence interval - lower         0.014 
90 Percent confidence interval - upper         0.016       
SRMR                                           0.036 (≤ 0.08)   Change in SRMR:  0.000 

We attempted to view the fit differences using semTools but it gives the error "a dimention is zero". We aren't sure why this is the case, but there is no difference in model fit between S2 and S3, so we can assume that **strong invariance holds here.**

```{r compare fit RICLPM_multi_inat_S2 and RICLPM_multi_inat_S3}
summary(semTools::compareFit(RICLPM_multi_inat_S2.fit, RICLPM_multi_inat_S3.fit, nested = TRUE)) #† indicates the best fitting model - have hashed out here
```

```{r tables for inattention ADHD S3}
# Table of model fit 
RICLPM_multi_inat_S3.fit.summary.fit <- as.data.frame(t(as.data.frame(RICLPM_multi_inat_S3.fit.summary$FIT)))[,c(6,7,19,20,27,28,29,35)]

# Table of regression coefficients and covariances 
RICLPM_multi_inat_S3.fit.summary.reg <- as.tibble(RICLPM_multi_inat_S3.fit.summary$PE[c(187:202),-c(4,5)])
```

Our model does not loose *any* fi, which means we can assume that strong factorial invariance holds over time. In contrast, If the overall model fit is not significantly worse in the strong invariance model compared to the weak invariance model, it indicates that constraining the item intercepts across time points does not significantly affect the model fit, and strong invariance is supported. 

**Going forward, we will assume that we have strong invariance for our inattention and social isolation mother report RI-CLPM.**

***

## RICLPM_multi_inat_S4: Inattention step 4 - *Full model*

From Mulder and Hamaker (2021):
A significant chi-square difference test would mean strong factorial invariance does not hold, implying that the actual scores cannot be compared over time, but individual differences in scores can still be meaningfully compared since weak factorial invariance holds. As the focus in cross-lagged panel modeling is primarily on comparing individual differences (by decomposing the observed scores into between-unit and withinunit components) rather than mean scores over time, weak factorial invariance may be enough. However, from a measurement point of view, having strong factorial invariance would be considered more ideal.

Instead of including a random intercept at the observed level for each indicator separately (as done so far and in the upper part of the figure at the beginning of this document), we can also choose to specify the entire RI-CLPM at the latent level; this is illustrated in the lower part of the beginning figure. This can be done in either a model with weak or strong factorial invariance over time. To this end, we specify the common factors that capture both trait-like and state-like common variance, and thereby make the assumption that the trait- and state structures coincide. We then decompose these latent variables into a stable, between-unit part and the within-unit components.

We set the factor loadings of these second-order factors to be identical to the corresponding factor loadings of the withinunit factors. Additionally, we constrain the residual variances for the first-order factors to zero. This model is nested under the model we just presented (top panel of the figure), and is statistically equivalent to the model presented in the lower panel of the figure. This implies that we can use a chi-square difference test to compare. 

Multiple indicator RI-CLPM, 5 waves with 3 indicators for each variable at each wave (30 observed variables). Fitting a model with constraints to ensure strong factorial invariance, with the RI-CLPM at the latent level.

```{r specify RICLPM_multi_inat_S4}
RICLPM_multi_inat_S4 <- '
  #####################
  # MEASUREMENT MODEL #
  #####################
  
  # Factor models for inattention symptoms at 4 waves (constrained)
  Finat5 =~ a*pe81m5 + b*pe82m5 + c*pe83m5 + d*pe86m5 + e*pe87m5 + f*pe88m5 + g*pe89m5 + h*pe90m5 + i*pe91m5
  Finat7 =~ a*pe81m7 + b*pe82m7 + c*pe83m7 + d*pe86m7 + e*pe87m7 + f*pe88m7 + g*pe89m7 + h*pe90m7 + i*pe91m7
  Finat10 =~ a*pe81m10 + b*pe82m10 + c*pe83m10 + d*pe86m10 + e*pe87m10 + f*pe88m10 + g*pe89m10 + h*pe90m10 + i*pe91m10
  Finat12 =~ a*pe81m12 + b*pe82m12 + c*pe83m12 + d*pe86m12 + e*pe87m12 + f*pe88m12 + g*pe89m12 + h*pe90m12 + i*pe91m12 
  
  # Factor models for social isolation at 4 waves (constrained)
  Fsi5 =~ j*pe2m5 + k*pe4m5 + l*pe7m5 + m*pe11m5 + n*pe13m5 + o*pe25m5 
  Fsi7 =~ j*pe2m7 + k*pe4m7 + l*pe7m7 + m*pe11m7 + n*pe13m7 + o*pe25m7 
  Fsi10 =~ j*pe2m10 + k*pe4m10 + l*pe7m10 + m*pe11m10 + n*pe13m10 + o*pe25m10
  Fsi12 =~ j*pe2m12 + k*pe4m12 + l*pe7m12 + m*pe11m12 + n*pe13m12 + o*pe25m12
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  pe81m5 + pe81m7 + pe81m10 + pe81m12 ~ p*1
  pe82m5 + pe82m7 + pe82m10 + pe82m12 ~ q*1
  pe83m5 + pe83m7 + pe83m10 + pe83m12 ~ r*1
  pe86m5 + pe86m7 + pe86m10 + pe86m12 ~ s*1
  pe87m5 + pe87m7 + pe87m10 + pe87m12 ~ t*1
  pe88m5 + pe88m7 + pe88m10 + pe88m12 ~ u*1
  pe89m5 + pe89m7 + pe89m10 + pe89m12 ~ v*1
  pe90m5 + pe90m7 + pe90m10 + pe90m12 ~ w*1
  pe91m5 + pe91m7 + pe91m10 + pe91m12 ~ x*1
  
  pe2m5 + pe2m7 + pe2m10 + pe2m12 ~ y*1
  pe4m5 + pe4m7 + pe4m10 + pe4m12 ~ z*1
  pe7m5 + pe7m7 + pe7m10 + pe7m12 ~ aa*1
  pe11m5 + pe11m7 + pe11m10 + pe11m12 ~ ab*1
  pe13m5 + pe13m7 + pe13m10 + pe13m12 ~ ac*1
  pe25m5 + pe25m7 + pe25m10 + pe25m12 ~ ad*1
  
  # Free latent means from timepoint = 2 (age 7) onward. 
  # Only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  Finat7 + Finat10 + Finat12 + Fsi7 + Fsi10 + Fsi12 ~ 1
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts). 
  RIinat =~ 1*Finat5 + 1*Finat7 + 1*Finat10 + 1*Finat12 
  RIsi =~ 1*Fsi5 + 1*Fsi7 + 1*Fsi10 + 1*Fsi12
  
  # Set the residual variances of all Finat and Fsi variables to 0. 
  Finat5 ~~ 0*Finat5
  Finat7 ~~ 0*Finat7
  Finat10 ~~ 0*Finat10
  Finat12 ~~ 0*Finat12
  Fsi5 ~~ 0*Fsi5
  Fsi7 ~~ 0*Fsi7
  Fsi10 ~~ 0*Fsi10
  Fsi12 ~~ 0*Fsi12

  ###############
  # WITHIN PART #
  ###############
 
  # Create the within-part
  WFinat5 =~ 1*Finat5
  WFinat7 =~ 1*Finat7
  WFinat10 =~ 1*Finat10
  WFinat12 =~ 1*Finat12
  
  WFsi5 =~ 1*Fsi5
  WFsi7 =~ 1*Fsi7
  WFsi10 =~ 1*Fsi10
  WFsi12 =~ 1*Fsi12

  # Specify the lagged effects between the within-person centered latent variables
  WFinat7 + WFsi7 ~ WFinat5 + WFsi5
  WFinat10 + WFsi10 ~ WFinat7 + WFsi7
  WFinat12 + WFsi12 ~ WFinat10 + WFsi10
  
  # Estimate the correlations within the same wave - age 5 is missing here. 
  WFinat7 ~~ WFsi7
  WFinat10 ~~ WFsi10 
  WFinat12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Set correlations between the between-factors (random intercepts) and within-factors at wave 1 at 0. 
  RIinat + RIsi ~~ 0*WFinat5 + 0*WFsi5
'
```

```{r fit RICLPM_multi_S4}
RICLPM_multi_inat_S4.fit <- cfa(RICLPM_multi_inat_S4, 
                           data = dat, 
                       #    se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise')

summary(RICLPM_multi_inat_S4.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
``` 

S4 Model fit:
(We have included here the change in CFI, TLI and RMSEA compared to the S3 model)
Comparative Fit Index (CFI)                    0.937 (>0.95)    Change in CFI:   0.056 (decrease) - worse fit
Tucker-Lewis Index (TLI)                       0.934 (>0.95)    Change in TLI:   0.057 (decrease) - worse fit
RMSEA                                          0.038 (≤ 0.06)   Change in RMSEA: 0.024 (increase) - worse fit
90 Percent confidence interval - lower         0.037 
90 Percent confidence interval - upper         0.049       
SRMR                                           0.071 (≤ 0.08)   Change in SRMR:  0.036 (increase) - worse fit

```{r compare fit RICLPM_multi_inat_S3 and RICLPM_multi_inat_S4}
summary(semTools::compareFit(RICLPM_multi_inat_S3.fit, RICLPM_multi_inat_S4.fit, nested = TRUE)) #† indicates the best fitting model 
```

**We can conclude that S3 is the best fitting model for inattention scores and social isolation, mother report**

The nonsignificant chi square implies that the current model does not have to be rejected, and we can say that there is *measurement invariance across the stable between structure and fluctuating within-structure.* If the chi-square test is significant, then we need to conclude that *these structures do not coincide, and temporal fluctuations within individuals take place on a different underlying dimension than the stable differences between units* (see Hamaker et al. (2017) for further discussion on this).

From [Hamaker et al. (2017)](https://www.tandfonline.com/doi/full/10.1080/00273171.2016.1251299):
**need to add notes here**

To key points from [Hamaker et al., 2015](https://www.tandfonline.com/doi/pdf/10.1080/10705511.2020.1784738) (page 646 & 647)
1. The disadvantage of using sum and mean scores however is that one assumes an absence of measurement error, which often is an unrealistic assumption, especially within the social sciences (Griliches & Hausman, 1986). Failing to properly account for measurement error can bias lagged-parameter estimates downward, leading to a loss of power. Also, the estimation of factor scores is difficult due to the problem of factor indeterminacy (i.e., there are multiple ways to obtain factor scores, each with their own set of advantages and disadvantages), and it is unclear how this affects the results of the RI-CLPM.
2. The procedure described above for establishing measurement invariance relies heavily on chi-square difference testing which, as mentioned before, can have serious disadvantages such as an increased Type I and Type II error rate when the base model is misspecified (Yuan & Bentler, 2004). Alternatively, researchers can use equivalence testing **(Yuan & Chan, 2016)**, which allows researchers to explicitly specify an acceptable level of model misfit. 

***

So if the S3 model is the way to go here - then I need to figure out how to interpret this 

***

# Multiple indicator RI-CLPM: Hyperactivity and social isolation

## RICLPM_multi_hyp_S1: Hyperactivity/Implsivity step 1

**Multiple response items RICLPM mother report hyperactivity ADHD symptoms and social isolation: Step 1, the configural model**  

The configural model is the least stringent test of invariance, it is designed to test if the constructs have the same pattern of free and fixed loadings. Configural *non*invariance means that the pattern of loadings of items on the latent factors differs over the time points. This would then suggest that a slightly different concept is being measured at each time point (Putnick and Bornstein, 2016). To test if the configural variance holds, we will look at the fit of the configural model (S1).

```{r specify RICLPM_multi_hyp_S1}
RICLPM_multi_hyp_S1 <- '
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of hyperactivity (mother report)
  RIhyp1 =~ 1*pe84m5 + 1*pe84m7 + 1*pe84m10 + 1*pe84m12
  RIhyp2 =~ 1*pe85m5 + 1*pe85m7 + 1*pe85m10 + 1*pe85m12
  RIhyp3 =~ 1*pe96m5 + 1*pe96m7 + 1*pe96m10 + 1*pe96m12
  RIhyp4 =~ 1*pe97m5 + 1*pe97m7 + 1*pe97m10 + 1*pe97m12
  RIhyp5 =~ 1*pe92m5 + 1*pe92m7 + 1*pe92m10 + 1*pe92m12
  RIhyp6 =~ 1*pe93m5 + 1*pe93m7 + 1*pe93m10 + 1*pe93m12
  RIhyp7 =~ 1*pe94m5 + 1*pe94m7 + 1*pe94m10 + 1*pe94m12
  RIhyp8 =~ 1*pe95m5 + 1*pe95m7 + 1*pe95m10 + 1*pe95m12
  RIhyp9 =~ 1*pe64m5 + 1*pe64m7 + 1*pe64m10 + 1*pe64m12
  
  # Create between factors (random intercepts) for each item of social isolation (mother report)
  RIsi1 =~ 1*pe2m5 + 1*pe2m7 + 1*pe2m10 + 1*pe2m12 
  RIsi2 =~ 1*pe4m5 + 1*pe4m7 + 1*pe4m10 + 1*pe4m12
  RIsi3 =~ 1*pe7m5 + 1*pe7m7 + 1*pe7m10 + 1*pe7m12
  RIsi4 =~ 1*pe11m5 + 1*pe11m7 + 1*pe11m10 + 1*pe11m12
  RIsi5 =~ 1*pe13m5 + 1*pe13m7 + 1*pe13m10 + 1*pe13m12
  RIsi6 =~ 1*pe25m5 + 1*pe25m7 + 1*pe25m10 + 1*pe25m12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for hyperactivity symptoms at 4 waves
  WFhyp5 =~ pe84m5 + pe85m5 + pe96m5 + pe97m5 + pe92m5 + pe93m5 + pe94m5 + pe95m5 + pe64m5
  WFhyp7 =~ pe84m7 + pe85m7 + pe96m7 + pe97m7 + pe92m7 + pe93m7 + pe94m7 + pe95m7 + pe64m7
  WFhyp10 =~ pe84m10 + pe85m10 + pe96m10 + pe97m10 + pe92m10 + pe93m10 + pe94m10 + pe95m10 + pe64m10
  WFhyp12 =~ pe84m12 + pe85m12 + pe96m12 + pe97m12 + pe92m12 + pe93m12 + pe94m12 + pe95m12 + pe64m12 
  
  # Factor models for social isolation at 4 waves
  WFsi5 =~ pe2m5 + pe4m5 + pe7m5 + pe11m5 + pe13m5 + pe25m5 
  WFsi7 =~ pe2m7 + pe4m7 + pe7m7 + pe11m7 + pe13m7 + pe25m7 
  WFsi10 =~ pe2m10 + pe4m10 + pe7m10 + pe11m10 + pe13m10 + pe25m10
  WFsi12 =~ pe2m12 + pe4m12 + pe7m12 + pe11m12 + pe13m12 + pe25m12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFhyp7 + WFsi7 ~ WFhyp5 + WFsi5
  WFhyp10 + WFsi10 ~ WFhyp7 + WFsi7
  WFhyp12 + WFsi12 ~ WFhyp10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFhyp5 ~~ WFsi5
  WFhyp7 ~~ WFsi7
  WFhyp10 ~~ WFsi10 
  WFhyp12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIhyp1 + RIhyp2 + RIhyp3 + RIhyp4 + RIhyp5 + RIhyp6 + RIhyp7 + RIhyp8 + RIhyp9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFhyp5
'
```

```{r fit RICLPM_multi_hyp_S1}
RICLPM_multi_hyp_S1.fit <- cfa(RICLPM_multi_hyp_S1, 
                           data = dat, 
                          # se = "robust",          # computes robust standard errors to account for use of twins
                           ordered = TRUE,          # using the "ordered" option will use DWLS with polychoric correlations for the ordinal variables
                           missing = 'pairwise'   # only excludes people who are missing both variables
)

summary(RICLPM_multi_hyp_S1.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S1 Model fit:
Comparative Fit Index (CFI)                    0.989 (>0.95)
Tucker-Lewis Index (TLI)                       0.988 (>0.95)      
RMSEA                                          0.017 (≤ 0.06)         
90 Percent confidence interval - lower         0.016 
90 Percent confidence interval - upper         0.018       
SRMR                                           0.033 (≤ 0.08)      

We can conclude that the model shows very good fit. 

## RICLPM_multi_hyp_S2: Hyperactivity step 2 

**Multiple response items RICLPM mother report hyperactivity ADHD symptoms and social isolation: Step 2**.
If configural variance is supported, we next test for weak invariance (sometimes called metric invariance). This tests for the equivalence of the item loadings on the factors. Weak (metric) invariance means that each item contributes to the latent construct to a similar degree across groups. this is tested by constraining factor loadings (i.e., the loadings of the items on the constructs) to be equivalent in the two time points (Putnick and Bornstein, 2016). The model with constrained factor loadings (S2) is then compared to the configural invariance model (S1) to determine fit. If the overall model fit is significantly worse in the weak invariance model compared to the configural invariance model, it indicates that at least one loading is not equivalent across the groups, and weak invariance is not supported.

In our second  step model, we constrain the factor loadings to be invariant over time using the labels `a*`, `b*`, `c*`, `d*` etc, in the "within" part of the model. 

```{r specify RICLPM_multi_hyp_S2}
RICLPM_multi_hyp_S2 <- '
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of hyptention (mother report)
  RIhyp1 =~ 1*pe84m5 + 1*pe84m7 + 1*pe84m10 + 1*pe84m12
  RIhyp2 =~ 1*pe85m5 + 1*pe85m7 + 1*pe85m10 + 1*pe85m12
  RIhyp3 =~ 1*pe96m5 + 1*pe96m7 + 1*pe96m10 + 1*pe96m12
  RIhyp4 =~ 1*pe97m5 + 1*pe97m7 + 1*pe97m10 + 1*pe97m12
  RIhyp5 =~ 1*pe92m5 + 1*pe92m7 + 1*pe92m10 + 1*pe92m12
  RIhyp6 =~ 1*pe93m5 + 1*pe93m7 + 1*pe93m10 + 1*pe93m12
  RIhyp7 =~ 1*pe94m5 + 1*pe94m7 + 1*pe94m10 + 1*pe94m12
  RIhyp8 =~ 1*pe95m5 + 1*pe95m7 + 1*pe95m10 + 1*pe95m12
  RIhyp9 =~ 1*pe64m5 + 1*pe64m7 + 1*pe64m10 + 1*pe64m12
  
  # Create between factors (random intercepts) for each item of social isolation (mother report)
  RIsi1 =~ 1*pe2m5 + 1*pe2m7 + 1*pe2m10 + 1*pe2m12 
  RIsi2 =~ 1*pe4m5 + 1*pe4m7 + 1*pe4m10 + 1*pe4m12
  RIsi3 =~ 1*pe7m5 + 1*pe7m7 + 1*pe7m10 + 1*pe7m12
  RIsi4 =~ 1*pe11m5 + 1*pe11m7 + 1*pe11m10 + 1*pe11m12
  RIsi5 =~ 1*pe13m5 + 1*pe13m7 + 1*pe13m10 + 1*pe13m12
  RIsi6 =~ 1*pe25m5 + 1*pe25m7 + 1*pe25m10 + 1*pe25m12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for hyptention symptoms at 4 waves (constrained)
  WFhyp5 =~ a*pe84m5 + b*pe85m5 + c*pe96m5 + d*pe97m5 + e*pe92m5 + f*pe93m5 + g*pe94m5 + h*pe95m5 + i*pe64m5
  WFhyp7 =~ a*pe84m7 + b*pe85m7 + c*pe96m7 + d*pe97m7 + e*pe92m7 + f*pe93m7 + g*pe94m7 + h*pe95m7 + i*pe64m7
  WFhyp10 =~ a*pe84m10 + b*pe85m10 + c*pe96m10 + d*pe97m10 + e*pe92m10 + f*pe93m10 + g*pe94m10 + h*pe95m10 + i*pe64m10
  WFhyp12 =~ a*pe84m12 + b*pe85m12 + c*pe96m12 + d*pe97m12 + e*pe92m12 + f*pe93m12 + g*pe94m12 + h*pe95m12 + i*pe64m12 
  
  # Factor models for social isolation at 4 waves (constrained)
  WFsi5 =~ j*pe2m5 + k*pe4m5 + l*pe7m5 + m*pe11m5 + n*pe13m5 + o*pe25m5 
  WFsi7 =~ j*pe2m7 + k*pe4m7 + l*pe7m7 + m*pe11m7 + n*pe13m7 + o*pe25m7 
  WFsi10 =~ j*pe2m10 + k*pe4m10 + l*pe7m10 + m*pe11m10 + n*pe13m10 + o*pe25m10
  WFsi12 =~ j*pe2m12 + k*pe4m12 + l*pe7m12 + m*pe11m12 + n*pe13m12 + o*pe25m12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFhyp7 + WFsi7 ~ WFhyp5 + WFsi5
  WFhyp10 + WFsi10 ~ WFhyp7 + WFsi7
  WFhyp12 + WFsi12 ~ WFhyp10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFhyp5 ~~ WFsi5
  WFhyp7 ~~ WFsi7
  WFhyp10 ~~ WFsi10 
  WFhyp12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIhyp1 + RIhyp2 + RIhyp3 + RIhyp4 + RIhyp5 + RIhyp6 + RIhyp7 + RIhyp8 + RIhyp9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFhyp5
'
```

```{r fit RICLPM_multi_hyp_S2}
RICLPM_multi_hyp_S2.fit <- cfa(RICLPM_multi_hyp_S2, 
                           data = dat, 
                          # se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

summary(RICLPM_multi_hyp_S2.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S2 Model fit:
(We have included here the change in CFI, TLI and RMSEA compared to the S1 model)
Comparative Fit Index (CFI)                    0.986 (>0.95)    Change in CFI:   0.003 (increase) - worse fit 
Tucker-Lewis Index (TLI)                       0.985 (>0.95)    Change in TLI:   0.003 (increase) - worse fit 
RMSEA                                          0.019 (≤ 0.06)   Change in RMSEA: 0.001 (decrease) - worse fit
90 Percent confidence interval - lower         0.018 
90 Percent confidence interval - upper         0.020       
SRMR                                           0.040 (≤ 0.08)   Change in SRMR: 0.006 (increase)  - worse fit (to be expected)

Now we need to conduct a Likelihood ratio test to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. We use the compareFit command which gives the LRT with the comparison in model fit for the two models. 

```{r compare fit RICLPM_multi_hyp_S1 and RICLPM_hyp_S2}
summary(semTools::compareFit(RICLPM_multi_hyp_S1.fit, RICLPM_multi_hyp_S2.fit, nested = TRUE)) #† indicates the best fitting model 
```

Significantly worse fit to include the restrictions, p<0.0001.

*The difference in model fit is still smaller than 0.01 - so we can assume that weak invariance holds - even though there is a significant chi square test.*

We will now go onto strong invariance testing. 

## RICLPM_multi_hyp_S3

**Multiple response items RICLPM mother report hyperactivity ADHD symptoms and social isolation: Step 3** 

If full or partial weak invariance is supported, the next step is to test for strong (scalar) invariance, or equivalence of item intercepts, for weak invariant items. Strong invariance means that mean differences in the latent construct capture all mean differences in the shared variance of the items. Strong invariance is tested by constraining the item intercepts to be equivalent in the two groups - with the restarint applied in the weak invariance model retained. *Any items that had unequal loadings in the weak invariance model (and were allowed to vary) should be allowed to vary in the strong invariance model because it is meaningless to test for equal item intercepts if the factor loadings of the items differs across groups* (Putnick and Bornstein, 2016). 

Fitting a model with constraints to ensure strong factorial invariance, with a random intercept for each indicator separately.

```{r specify RICLPM_multi_hyp_S3}
RICLPM_multi_hyp_S3 <- '
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of hyptention (mother report)
  RIhyp1 =~ 1*pe84m5 + 1*pe84m7 + 1*pe84m10 + 1*pe84m12
  RIhyp2 =~ 1*pe85m5 + 1*pe85m7 + 1*pe85m10 + 1*pe85m12
  RIhyp3 =~ 1*pe96m5 + 1*pe96m7 + 1*pe96m10 + 1*pe96m12
  RIhyp4 =~ 1*pe97m5 + 1*pe97m7 + 1*pe97m10 + 1*pe97m12
  RIhyp5 =~ 1*pe92m5 + 1*pe92m7 + 1*pe92m10 + 1*pe92m12
  RIhyp6 =~ 1*pe93m5 + 1*pe93m7 + 1*pe93m10 + 1*pe93m12
  RIhyp7 =~ 1*pe94m5 + 1*pe94m7 + 1*pe94m10 + 1*pe94m12
  RIhyp8 =~ 1*pe95m5 + 1*pe95m7 + 1*pe95m10 + 1*pe95m12
  RIhyp9 =~ 1*pe64m5 + 1*pe64m7 + 1*pe64m10 + 1*pe64m12
  
  # Create between factors (random intercepts) for each item of social isolation (mother report)
  RIsi1 =~ 1*pe2m5 + 1*pe2m7 + 1*pe2m10 + 1*pe2m12 
  RIsi2 =~ 1*pe4m5 + 1*pe4m7 + 1*pe4m10 + 1*pe4m12
  RIsi3 =~ 1*pe7m5 + 1*pe7m7 + 1*pe7m10 + 1*pe7m12
  RIsi4 =~ 1*pe11m5 + 1*pe11m7 + 1*pe11m10 + 1*pe11m12
  RIsi5 =~ 1*pe13m5 + 1*pe13m7 + 1*pe13m10 + 1*pe13m12
  RIsi6 =~ 1*pe25m5 + 1*pe25m7 + 1*pe25m10 + 1*pe25m12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for hyperactivity symptoms at 4 waves (constrained)
  WFhyp5 =~ a*pe84m5 + b*pe85m5 + c*pe96m5 + d*pe97m5 + e*pe92m5 + f*pe93m5 + g*pe94m5 + h*pe95m5 + i*pe64m5
  WFhyp7 =~ a*pe84m7 + b*pe85m7 + c*pe96m7 + d*pe97m7 + e*pe92m7 + f*pe93m7 + g*pe94m7 + h*pe95m7 + i*pe64m7
  WFhyp10 =~ a*pe84m10 + b*pe85m10 + c*pe96m10 + d*pe97m10 + e*pe92m10 + f*pe93m10 + g*pe94m10 + h*pe95m10 + i*pe64m10
  WFhyp12 =~ a*pe84m12 + b*pe85m12 + c*pe96m12 + d*pe97m12 + e*pe92m12 + f*pe93m12 + g*pe94m12 + h*pe95m12 + i*pe64m12 
  
  # Factor models for social isolation at 4 waves (constrained)
  WFsi5 =~ j*pe2m5 + k*pe4m5 + l*pe7m5 + m*pe11m5 + n*pe13m5 + o*pe25m5 
  WFsi7 =~ j*pe2m7 + k*pe4m7 + l*pe7m7 + m*pe11m7 + n*pe13m7 + o*pe25m7 
  WFsi10 =~ j*pe2m10 + k*pe4m10 + l*pe7m10 + m*pe11m10 + n*pe13m10 + o*pe25m10
  WFsi12 =~ j*pe2m12 + k*pe4m12 + l*pe7m12 + m*pe11m12 + n*pe13m12 + o*pe25m12
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  pe84m5 + pe84m7 + pe84m10 + pe84m12 ~ p*1
  pe85m5 + pe85m7 + pe85m10 + pe85m12 ~ q*1
  pe96m5 + pe96m7 + pe96m10 + pe96m12 ~ r*1
  pe97m5 + pe97m7 + pe97m10 + pe97m12 ~ s*1
  pe92m5 + pe92m7 + pe92m10 + pe92m12 ~ t*1
  pe93m5 + pe93m7 + pe93m10 + pe93m12 ~ u*1
  pe94m5 + pe94m7 + pe94m10 + pe94m12 ~ v*1
  pe95m5 + pe95m7 + pe95m10 + pe95m12 ~ w*1
  pe64m5 + pe64m7 + pe64m10 + pe64m12 ~ x*1
  
  pe2m5 + pe2m7 + pe2m10 + pe2m12 ~ y*1
  pe4m5 + pe4m7 + pe4m10 + pe4m12 ~ z*1
  pe7m5 + pe7m7 + pe7m10 + pe7m12 ~ aa*1
  pe11m5 + pe11m7 + pe11m10 + pe11m12 ~ ab*1
  pe13m5 + pe13m7 + pe13m10 + pe13m12 ~ ac*1
  pe25m5 + pe25m7 + pe25m10 + pe25m12 ~ ad*1
  
  # Free latent means from t = 2 onward (only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  WFhyp7 + WFhyp10 + WFhyp12 + WFsi7 + WFsi10 + WFsi12 ~ 1
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFhyp7 + WFsi7 ~ WFhyp5 + WFsi5
  WFhyp10 + WFsi10 ~ WFhyp7 + WFsi7
  WFhyp12 + WFsi12 ~ WFhyp10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFhyp5 ~~ WFsi5
  WFhyp7 ~~ WFsi7
  WFhyp10 ~~ WFsi10 
  WFhyp12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIhyp1 + RIhyp2 + RIhyp3 + RIhyp4 + RIhyp5 + RIhyp6 + RIhyp7 + RIhyp8 + RIhyp9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFhyp5
'
```

```{r fit RICLPM_multi_hyp_S3}
RICLPM_multi_hyp_S3.fit <- cfa(RICLPM_multi_hyp_S3, 
                           data = dat, 
                         #  se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

RICLPM_multi_hyp_S3.fit.summary <- summary(RICLPM_multi_hyp_S3.fit, 
                                            fit.measures = TRUE,
                                            standardized = TRUE)
```

S3 Model fit:
(We have included here the change in CFI, TLI and RMSEA compared to the S2 model)
Comparative Fit Index (CFI)                    0.986 (>0.95)    Change in CFI:   0.000 (increase) - same fit 
Tucker-Lewis Index (TLI)                       0.985 (>0.95)    Change in TLI:   0.000 (increase) - same fit 
RMSEA                                          0.019 (≤ 0.06)   Change in RMSEA: 0.000 (decrease) - same fit
90 Percent confidence interval - lower         0.018 
90 Percent confidence interval - upper         0.021       
SRMR                                           0.040 (≤ 0.08)   Change in SRMR: 0.006 (increase)  - same fit 

Now we need to conduct a Likelihood ratio test to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. We use the compareFit command which gives the LRT with the comparison in model fit for the two models. 

```{r compare fit RICLPM_multi_hyp_S2 and RICLPM_hyp_S3}
# summary(semTools::compareFit(RICLPM_multi_hyp_S2.fit, RICLPM_multi_hyp_S3.fit, nested = TRUE)) #† indicates the best fitting model - hashed out to keep script running
```

Again this function does not run - perhaps there is something wrong with the way we are running the S3 code.

**But the model shows almost no change in model fit from S2 - so we assume strong measurement invariance.**

```{r tables for inattention ADHD S3}
# Table of model fit 
RICLPM_multi_hyp_S3.fit.summary.fit <- as.data.frame(t(as.data.frame(RICLPM_multi_hyp_S3.fit.summary$FIT)))[,c(6,7,19,20,27,28,29,35)]

# Table of regression coefficients and covariances 
RICLPM_multi_hyp_S3.fit.summary.reg <- as.tibble(RICLPM_multi_hyp_S3.fit.summary$PE[c(187:202),-c(4,5)])
```

## RICLPM_multi_hyp_S4: Hyperactivity step 4 - *Full model*

From Mulder and Hamaker (2021):
A significant chi-square difference test would mean strong factorial invariance does not hold, implying that the actual scores cannot be compared over time, but individual differences in scores can still be meaningfully compared since weak factorial invariance holds. As the focus in cross-lagged panel modeling is primarily on comparing individual differences (by decomposing the observed scores into between-unit and withinunit components) rather than mean scores over time, weak factorial invariance may be enough. However, from a measurement point of view, having strong factorial invariance would be considered more ideal.

Instead of including a random intercept at the observed level for each indicator separately (as done so far and in the upper part of the figure at the beginning of this document), we can also choose to specify the entire RI-CLPM at the latent level; this is illustrated in the lower part of the beginning figure. This can be done in either a model with weak or strong factorial invariance over time. To this end, we specify the common factors that capture both trait-like and state-like common variance, and thereby make the assumption that the trait- and state structures coincide. We then decompose these latent variables into a stable, between-unit part and the within-unit components.

We set the factor loadings of these second-order factors to be identical to the corresponding factor loadings of the withinunit factors. Additionally, we constrain the residual variances for the first-order factors to zero. This model is nested under the model we just presented (top panel of the figure), and is statistically equivalent to the model presented in the lower panel of the figure. This implies that we can use a chi-square difference test to compare. 

Multiple indicator RI-CLPM, 5 waves with 3 indicators for each variable at each wave (30 observed variables). Fitting a model with constraints to ensure strong factorial invariance, with the RI-CLPM at the latent level.

```{r specify RICLPM_multi_hyp_S4}
RICLPM_multi_hyp_S4 <- '
  
  #####################
  # MEASUREMENT MODEL #
  #####################
  
  # Factor models for hyptention symptoms at 4 waves (constrained)
  Fhyp5 =~ a*pe84m5 + b*pe85m5 + c*pe96m5 + d*pe97m5 + e*pe92m5 + f*pe93m5 + g*pe94m5 + h*pe95m5 + i*pe64m5
  Fhyp7 =~ a*pe84m7 + b*pe85m7 + c*pe96m7 + d*pe97m7 + e*pe92m7 + f*pe93m7 + g*pe94m7 + h*pe95m7 + i*pe64m7
  Fhyp10 =~ a*pe84m10 + b*pe85m10 + c*pe96m10 + d*pe97m10 + e*pe92m10 + f*pe93m10 + g*pe94m10 + h*pe95m10 + i*pe64m10
  Fhyp12 =~ a*pe84m12 + b*pe85m12 + c*pe96m12 + d*pe97m12 + e*pe92m12 + f*pe93m12 + g*pe94m12 + h*pe95m12 + i*pe64m12 
  
  # Factor models for social isolation at 4 waves (constrained)
  Fsi5 =~ j*pe2m5 + k*pe4m5 + l*pe7m5 + m*pe11m5 + n*pe13m5 + o*pe25m5 
  Fsi7 =~ j*pe2m7 + k*pe4m7 + l*pe7m7 + m*pe11m7 + n*pe13m7 + o*pe25m7 
  Fsi10 =~ j*pe2m10 + k*pe4m10 + l*pe7m10 + m*pe11m10 + n*pe13m10 + o*pe25m10
  Fsi12 =~ j*pe2m12 + k*pe4m12 + l*pe7m12 + m*pe11m12 + n*pe13m12 + o*pe25m12
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  pe84m5 + pe84m7 + pe84m10 + pe84m12 ~ p*1
  pe85m5 + pe85m7 + pe85m10 + pe85m12 ~ q*1
  pe96m5 + pe96m7 + pe96m10 + pe96m12 ~ r*1
  pe97m5 + pe97m7 + pe97m10 + pe97m12 ~ s*1
  pe92m5 + pe92m7 + pe92m10 + pe92m12 ~ t*1
  pe93m5 + pe93m7 + pe93m10 + pe93m12 ~ u*1
  pe94m5 + pe94m7 + pe94m10 + pe94m12 ~ v*1
  pe95m5 + pe95m7 + pe95m10 + pe95m12 ~ w*1
  pe64m5 + pe64m7 + pe64m10 + pe64m12 ~ x*1
  
  pe2m5 + pe2m7 + pe2m10 + pe2m12 ~ y*1
  pe4m5 + pe4m7 + pe4m10 + pe4m12 ~ z*1
  pe7m5 + pe7m7 + pe7m10 + pe7m12 ~ aa*1
  pe11m5 + pe11m7 + pe11m10 + pe11m12 ~ ab*1
  pe13m5 + pe13m7 + pe13m10 + pe13m12 ~ ac*1
  pe25m5 + pe25m7 + pe25m10 + pe25m12 ~ ad*1
  
  # Free latent means from t = 2 onward (only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  Fhyp7 + Fhyp10 + Fhyp12 + Fsi7 + Fsi10 + Fsi12 ~ 1
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) 
  RIhyp =~ 1*Fhyp5 + 1*Fhyp7 + 1*Fhyp10 + 1*Fhyp12
  RIsi =~ 1*Fsi5 + 1*Fsi7 + 1*Fsi10 + 1*Fsi12
  
  # Set the residual variances of all Fhyp and Fsi variables to 0. 
  Fhyp5 ~~ 0*Fhyp5
  Fhyp7 ~~ 0*Fhyp7
  Fhyp10 ~~ 0*Fhyp10
  Fhyp12 ~~ 0*Fhyp12
  Fsi5 ~~ 0*Fsi5
  Fsi7 ~~ 0*Fsi7
  Fsi10 ~~ 0*Fsi10
  Fsi12 ~~ 0*Fsi12
  
  ###############
  # WITHIN PART #
  ###############
  
  # Create the within-part
  WFhyp5 =~ 1*Fhyp5
  WFhyp7 =~ 1*Fhyp7
  WFhyp10 =~ 1*Fhyp10
  WFhyp12 =~ 1*Fhyp12
  
  WFsi5 =~ 1*Fsi5
  WFsi7 =~ 1*Fsi7
  WFsi10 =~ 1*Fsi10
  WFsi12 =~ 1*Fsi12
  
  # Specify the lagged effects between the within-person centered latent variables
  WFhyp7 + WFsi7 ~ WFhyp5 + WFsi5
  WFhyp10 + WFsi10 ~ WFhyp7 + WFsi7
  WFhyp12 + WFsi12 ~ WFhyp10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFhyp5 ~~ WFsi5
  WFhyp7 ~~ WFsi7
  WFhyp10 ~~ WFsi10 
  WFhyp12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Set correlations between the between-factors (random intercepts) and within-factors at wave 1 (age 5) at 0
  RIhyp + RIsi ~~ 0*WFhyp5 + 0*WFsi5
'
```

```{r fit RICLPM_multi_hyp_S4}
RICLPM_multi_hyp_S4.fit <- cfa(RICLPM_multi_hyp_S4, 
                           data = dat, 
                         #  se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

summary(RICLPM_multi_hyp_S4.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S4 Model fit:
(We have included here the change in CFI, TLI and RMSEA compared to the S3 model)
Comparative Fit Index (CFI)                    0.907 (>0.95)    Change in CFI:   0.079 (decrease) - worse fit 
Tucker-Lewis Index (TLI)                       0.904 (>0.95)    Change in TLI:   0.081 (decrease) - worse fit 
RMSEA                                          0.049 (≤ 0.06)   Change in RMSEA: 0.029 (increase) - worse fit
90 Percent confidence interval - lower         0.058 
90 Percent confidence interval - upper         0.040       
SRMR                                           0.086 (≤ 0.08)   Change in SRMR: 0.046 (increase)  - worse fit 

Now we need to conduct a Likelihood ratio test to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. We use the compareFit command which gives the LRT with the comparison in model fit for the two models. 

```{r compare fit RICLPM_multi_hyp_S3 and RICLPM_hyp_inat_S4}
summary(semTools::compareFit(RICLPM_multi_hyp_S3.fit, RICLPM_multi_hyp_S4.fit, nested = TRUE)) #† indicates the best fitting model
```

**As all fit indices changed by more than 0.01 - we cannot accept this measurement model.**

***

So if the S3 model is the way to go here - then I need to figure out how to interpret this 

***

# Multiple indicator RI-CLPM: ADHD and social isolation

## RICLPM_multi_adhd_S1: ADHD step 1

**Multiple response items RICLPM mother report total ADHD symptoms and social isolation: Step 1, the configural model**  

The configural model is the least stringent test of invariance, it is designed to test if the constructs have the same pattern of free and fixed loadings. Configural *non*invariance means that the pattern of loadings of items on the latent factors differs over the time points. This would then suggest that a slightly different concept is being measured at each time point (Putnick and Bornstein, 2016). To test if the configural variance holds, we will look at the fit of the configural model (S1).

```{r specify RICLPM_multi_adhd_S1}
RICLPM_multi_adhd_S1 <- '
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of ADHD (mother report)
  # Inattention symptoms
  RIadhd1 =~ 1*pe81m5 + 1*pe81m7 + 1*pe81m10 + 1*pe81m12
  RIadhd2 =~ 1*pe82m5 + 1*pe82m7 + 1*pe82m10 + 1*pe82m12
  RIadhd3 =~ 1*pe83m5 + 1*pe83m7 + 1*pe83m10 + 1*pe83m12
  RIadhd4 =~ 1*pe86m5 + 1*pe86m7 + 1*pe86m10 + 1*pe86m12
  RIadhd5 =~ 1*pe87m5 + 1*pe87m7 + 1*pe87m10 + 1*pe87m12
  RIadhd6 =~ 1*pe88m5 + 1*pe88m7 + 1*pe88m10 + 1*pe88m12
  RIadhd7 =~ 1*pe89m5 + 1*pe89m7 + 1*pe89m10 + 1*pe89m12
  RIadhd8 =~ 1*pe90m5 + 1*pe90m7 + 1*pe90m10 + 1*pe90m12
  RIadhd9 =~ 1*pe91m5 + 1*pe91m7 + 1*pe91m10 + 1*pe91m12
  #Hyperactivity symptoms
  RIadhd10 =~ 1*pe84m5 + 1*pe84m7 + 1*pe84m10 + 1*pe84m12
  RIadhd11 =~ 1*pe85m5 + 1*pe85m7 + 1*pe85m10 + 1*pe85m12
  RIadhd12 =~ 1*pe96m5 + 1*pe96m7 + 1*pe96m10 + 1*pe96m12
  RIadhd13 =~ 1*pe97m5 + 1*pe97m7 + 1*pe97m10 + 1*pe97m12
  RIadhd14 =~ 1*pe92m5 + 1*pe92m7 + 1*pe92m10 + 1*pe92m12
  RIadhd15 =~ 1*pe93m5 + 1*pe93m7 + 1*pe93m10 + 1*pe93m12
  RIadhd16 =~ 1*pe94m5 + 1*pe94m7 + 1*pe94m10 + 1*pe94m12
  RIadhd17 =~ 1*pe95m5 + 1*pe95m7 + 1*pe95m10 + 1*pe95m12
  RIadhd18 =~ 1*pe64m5 + 1*pe64m7 + 1*pe64m10 + 1*pe64m12
  
  # Create between factors (random intercepts) for each item of social isolation (mother report)
  RIsi1 =~ 1*pe2m5 + 1*pe2m7 + 1*pe2m10 + 1*pe2m12 
  RIsi2 =~ 1*pe4m5 + 1*pe4m7 + 1*pe4m10 + 1*pe4m12
  RIsi3 =~ 1*pe7m5 + 1*pe7m7 + 1*pe7m10 + 1*pe7m12
  RIsi4 =~ 1*pe11m5 + 1*pe11m7 + 1*pe11m10 + 1*pe11m12
  RIsi5 =~ 1*pe13m5 + 1*pe13m7 + 1*pe13m10 + 1*pe13m12
  RIsi6 =~ 1*pe25m5 + 1*pe25m7 + 1*pe25m10 + 1*pe25m12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for ADHD (inattention and hyperactivity) symptoms at 4 waves
  WFadhd5 =~ pe81m5 + pe82m5 + pe83m5 + pe86m5 + pe87m5 + pe88m5 + pe89m5 + pe90m5 + pe91m5 + pe84m5 + pe85m5 + pe96m5 + pe97m5 + pe92m5 + pe93m5 + pe94m5 + pe95m5 + pe64m5
  WFadhd7 =~ pe81m7 + pe82m7 + pe83m7 + pe86m7 + pe87m7 + pe88m7 + pe89m7 + pe90m7 + pe91m7 + pe84m7 + pe85m7 + pe96m7 + pe97m7 + pe92m7 + pe93m7 + pe94m7 + pe95m7 + pe64m7
  WFadhd10 =~ pe81m10 + pe82m10 + pe83m10 + pe86m10 + pe87m10 + pe88m10 + pe89m10 + pe90m10 + pe91m10 + pe84m10 + pe85m10 + pe96m10 + pe97m10 + pe92m10 + pe93m10 + pe94m10 + pe95m10 + pe64m10
  WFadhd12 =~ pe81m12 + pe82m12 + pe83m12 + pe86m12 + pe87m12 + pe88m12 + pe89m12 + pe90m12 + pe91m12 + pe84m12 + pe85m12 + pe96m12 + pe97m12 + pe92m12 + pe93m12 + pe94m12 + pe95m12 + pe64m12 
  
  # Factor models for social isolation at 4 waves
  WFsi5 =~ pe2m5 + pe4m5 + pe7m5 + pe11m5 + pe13m5 + pe25m5 
  WFsi7 =~ pe2m7 + pe4m7 + pe7m7 + pe11m7 + pe13m7 + pe25m7 
  WFsi10 =~ pe2m10 + pe4m10 + pe7m10 + pe11m10 + pe13m10 + pe25m10
  WFsi12 =~ pe2m12 + pe4m12 + pe7m12 + pe11m12 + pe13m12 + pe25m12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFadhd7 + WFsi7 ~ WFadhd5 + WFsi5
  WFadhd10 + WFsi10 ~ WFadhd7 + WFsi7
  WFadhd12 + WFsi12 ~ WFadhd10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFadhd5 ~~ WFsi5
  WFadhd7 ~~ WFsi7
  WFadhd10 ~~ WFsi10 
  WFadhd12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIadhd1 + RIadhd2 + RIadhd3 + RIadhd4 + RIadhd5 + RIadhd6 + RIadhd7 + RIadhd8 + RIadhd9 + RIadhd10 + RIadhd11 + RIadhd12 + RIadhd13 + RIadhd14 + RIadhd15 + RIadhd16 + RIadhd17 + RIadhd18 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFadhd5
'
```

```{r fit RICLPM_multi_adhd_S1}
RICLPM_multi_adhd_S1.fit <- cfa(RICLPM_multi_adhd_S1, 
                           data = dat, 
                          # se = "robust",          # computes robust standard errors to account for use of twins
                           ordered = TRUE,          # using the "ordered" option will use DWLS with polychoric correlations for the ordinal variables
                           missing = 'pairwise'  # only excludes people who are missing both variables
)

summary(RICLPM_multi_adhd_S1.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S1 Model fit:
Comparative Fit Index (CFI)                    0.986 (>0.95)
Tucker-Lewis Index (TLI)                       0.984 (>0.95)      
RMSEA                                          0.016 (≤ 0.06)         
90 Percent confidence interval - lower         0.015 
90 Percent confidence interval - upper         0.017      
SRMR                                           0.033 (≤ 0.08)      

We can conclude that the model shows very good fit. 

## RICLPM_multi_adhd_S2: ADHD step 2 

**Multiple response items RICLPM mother report ADHD symptoms and social isolation: Step 2**.
If configural variance is supported, we next test for weak invariance (sometimes called metric invariance). This tests for the equivalence of the item loadings on the factors. Weak (metric) invariance means that each item contributes to the latent construct to a similar degree across groups. this is tested by constraining factor loadings (i.e., the loadings of the items on the constructs) to be equivalent in the two time points (Putnick and Bornstein, 2016). The model with constrained factor loadings (S2) is then compared to the configural invariance model (S1) to determine fit. If the overall model fit is significantly worse in the weak invariance model compared to the configural invariance model, it indicates that at least one loading is not equivalent across the groups, and weak invariance is not supported.

In our second  step model, we constrain the factor loadings to be invariant over time using the labels `a*`, `b*`, `c*`, `d*` etc, in the "within" part of the model. 

```{r specify RICLPM_multi_adhd_S2}
RICLPM_multi_adhd_S2 <- '
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of ADHD (mother report)
  # Inattention symptoms
  RIadhd1 =~ 1*pe81m5 + 1*pe81m7 + 1*pe81m10 + 1*pe81m12
  RIadhd2 =~ 1*pe82m5 + 1*pe82m7 + 1*pe82m10 + 1*pe82m12
  RIadhd3 =~ 1*pe83m5 + 1*pe83m7 + 1*pe83m10 + 1*pe83m12
  RIadhd4 =~ 1*pe86m5 + 1*pe86m7 + 1*pe86m10 + 1*pe86m12
  RIadhd5 =~ 1*pe87m5 + 1*pe87m7 + 1*pe87m10 + 1*pe87m12
  RIadhd6 =~ 1*pe88m5 + 1*pe88m7 + 1*pe88m10 + 1*pe88m12
  RIadhd7 =~ 1*pe89m5 + 1*pe89m7 + 1*pe89m10 + 1*pe89m12
  RIadhd8 =~ 1*pe90m5 + 1*pe90m7 + 1*pe90m10 + 1*pe90m12
  RIadhd9 =~ 1*pe91m5 + 1*pe91m7 + 1*pe91m10 + 1*pe91m12
  #Hyperactivity symptoms
  RIadhd10 =~ 1*pe84m5 + 1*pe84m7 + 1*pe84m10 + 1*pe84m12
  RIadhd11 =~ 1*pe85m5 + 1*pe85m7 + 1*pe85m10 + 1*pe85m12
  RIadhd12 =~ 1*pe96m5 + 1*pe96m7 + 1*pe96m10 + 1*pe96m12
  RIadhd13 =~ 1*pe97m5 + 1*pe97m7 + 1*pe97m10 + 1*pe97m12
  RIadhd14 =~ 1*pe92m5 + 1*pe92m7 + 1*pe92m10 + 1*pe92m12
  RIadhd15 =~ 1*pe93m5 + 1*pe93m7 + 1*pe93m10 + 1*pe93m12
  RIadhd16 =~ 1*pe94m5 + 1*pe94m7 + 1*pe94m10 + 1*pe94m12
  RIadhd17 =~ 1*pe95m5 + 1*pe95m7 + 1*pe95m10 + 1*pe95m12
  RIadhd18 =~ 1*pe64m5 + 1*pe64m7 + 1*pe64m10 + 1*pe64m12
  
  # Create between factors (random intercepts) for each item of social isolation (mother report)
  RIsi1 =~ 1*pe2m5 + 1*pe2m7 + 1*pe2m10 + 1*pe2m12 
  RIsi2 =~ 1*pe4m5 + 1*pe4m7 + 1*pe4m10 + 1*pe4m12
  RIsi3 =~ 1*pe7m5 + 1*pe7m7 + 1*pe7m10 + 1*pe7m12
  RIsi4 =~ 1*pe11m5 + 1*pe11m7 + 1*pe11m10 + 1*pe11m12
  RIsi5 =~ 1*pe13m5 + 1*pe13m7 + 1*pe13m10 + 1*pe13m12
  RIsi6 =~ 1*pe25m5 + 1*pe25m7 + 1*pe25m10 + 1*pe25m12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for ADHD (inattention and hyperactivity) symptoms at 4 waves
  WFadhd5 =~ a*pe81m5 + b*pe82m5 + c*pe83m5 + d*pe86m5 + e*pe87m5 + f*pe88m5 + g*pe89m5 + h*pe90m5 + i*pe91m5 + j*pe84m5 + k*pe85m5 + l*pe96m5 + m*pe97m5 + n*pe92m5 + o*pe93m5 + p*pe94m5 + q*pe95m5 + r*pe64m5
  WFadhd7 =~ a*pe81m7 + b*pe82m7 + c*pe83m7 + d*pe86m7 + e*pe87m7 + f*pe88m7 + g*pe89m7 + h*pe90m7 + i*pe91m7 + j*pe84m7 + k*pe85m7 + l*pe96m7 + m*pe97m7 + n*pe92m7 + o*pe93m7 + p*pe94m7 + q*pe95m7 + r*pe64m7
  WFadhd10 =~ a*pe81m10 + b*pe82m10 + c*pe83m10 + d*pe86m10 + e*pe87m10 + f*pe88m10 + g*pe89m10 + h*pe90m10 + i*pe91m10 + j*pe84m10 + k*pe85m10 + l*pe96m10 + m*pe97m10 + n*pe92m10 + o*pe93m10 + p*pe94m10 + q*pe95m10 + r*pe64m10
  WFadhd12 =~ a*pe81m12 + b*pe82m12 + c*pe83m12 + d*pe86m12 + e*pe87m12 + f*pe88m12 + g*pe89m12 + h*pe90m12 + i*pe91m12 + j*pe84m12 + k*pe85m12 + l*pe96m12 + m*pe97m12 + n*pe92m12 + o*pe93m12 + p*pe94m12 + q*pe95m12 + r*pe64m12 
  
  # Factor models for social isolation at 4 waves
  WFsi5 =~ s*pe2m5 + t*pe4m5 + u*pe7m5 + v*pe11m5 + w*pe13m5 + x*pe25m5 
  WFsi7 =~ s*pe2m7 + t*pe4m7 + u*pe7m7 + v*pe11m7 + w*pe13m7 + x*pe25m7 
  WFsi10 =~ s*pe2m10 + t*pe4m10 + u*pe7m10 + v*pe11m10 + w*pe13m10 + x*pe25m10
  WFsi12 =~ s*pe2m12 + t*pe4m12 + u*pe7m12 + v*pe11m12 + w*pe13m12 + x*pe25m12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFadhd7 + WFsi7 ~ WFadhd5 + WFsi5
  WFadhd10 + WFsi10 ~ WFadhd7 + WFsi7
  WFadhd12 + WFsi12 ~ WFadhd10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFadhd5 ~~ WFsi5
  WFadhd7 ~~ WFsi7
  WFadhd10 ~~ WFsi10 
  WFadhd12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIadhd1 + RIadhd2 + RIadhd3 + RIadhd4 + RIadhd5 + RIadhd6 + RIadhd7 + RIadhd8 + RIadhd9 + RIadhd10 + RIadhd11 + RIadhd12 + RIadhd13 + RIadhd14 + RIadhd15 + RIadhd16 + RIadhd17 + RIadhd18 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFadhd5
'
```

```{r fit RICLPM_multi_adhd_S2}
RICLPM_multi_adhd_S2.fit <- cfa(RICLPM_multi_adhd_S2, 
                           data = dat, 
                          # se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

summary(RICLPM_multi_adhd_S2.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S2 Model fit:
Comparative Fit Index (CFI)                    0.984 (>0.95)  Change in CFI:    0.002 (decrease) - worse fit 
Tucker-Lewis Index (TLI)                       0.983 (>0.95)  Change in TLI:    0.001 (decrease) - worse fit     
RMSEA                                          0.017 (≤ 0.06) Change in RMSEA:  0.001 (increase) - worse fit         
90 Percent confidence interval - lower         0.016 
90 Percent confidence interval - upper         0.018       
SRMR                                           0.038 (≤ 0.08) Change in SRMR:   0.005 (increase) - worse fit  

Now we need to conduct a Likelihood ratio test and compare the model fit for S1 and S2 to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. 

```{r compare fit RICLPM_multi_adhd_S1 and RICLPM_hyp_adhd_S2}
summary(semTools::compareFit(RICLPM_multi_adhd_S1.fit, RICLPM_multi_adhd_S2.fit, nested = TRUE)) #† indicates the best fitting model 
```

Significant;y worse fit according to the chi square (p<0.0001). 

**However, since the change in fit did not exceed 0.01 for all indices - we can except that strong invariance holds.**

Notes from Hamaker on a forum: We assume that all the parameters are invariant over time (e.g., the lagged relationships between waves, or the residual variances), which may be problematic when the intervals between the waves vary, and/or if the time intervals between the waves are relatively large and developmental changes are may have occurred during the study. Both of these things could be playing a part in the chi square estimate - so it's good to keep this in mind. 

## RICLPM_multi_adhd_S3: ADHD step 3

**Multiple response items RICLPM mother report ADHD symptoms and social isolation: Step 3** 

If full or partial weak invariance is supported, the next step is to test for strong (scalar) invariance, or equivalence of item intercepts, for weak invariant items. Strong invariance means that mean differences in the latent construct capture all mean differences in the shared variance of the items. Strong invariance is tested by constraining the item intercepts to be equivalent in the two groups - with the restarint applied in the weak invariance model retained. *Any items that had unequal loadings in the weak invariance model (and were allowed to vary) should be allowed to vary in the strong invariance model because it is meaningless to test for equal item intercepts if the factor loadings of the items differs across groups* (Putnick and Bornstein, 2016). 

Fitting a model with constraints to ensure strong factorial invariance, with a random intercept for each indicator separately.

```{r specify RICLPM_multi_adhd_S3}
RICLPM_multi_adhd_S3 <- '
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of ADHD (mother report)
  # Inattention symptoms
  RIadhd1 =~ 1*pe81m5 + 1*pe81m7 + 1*pe81m10 + 1*pe81m12
  RIadhd2 =~ 1*pe82m5 + 1*pe82m7 + 1*pe82m10 + 1*pe82m12
  RIadhd3 =~ 1*pe83m5 + 1*pe83m7 + 1*pe83m10 + 1*pe83m12
  RIadhd4 =~ 1*pe86m5 + 1*pe86m7 + 1*pe86m10 + 1*pe86m12
  RIadhd5 =~ 1*pe87m5 + 1*pe87m7 + 1*pe87m10 + 1*pe87m12
  RIadhd6 =~ 1*pe88m5 + 1*pe88m7 + 1*pe88m10 + 1*pe88m12
  RIadhd7 =~ 1*pe89m5 + 1*pe89m7 + 1*pe89m10 + 1*pe89m12
  RIadhd8 =~ 1*pe90m5 + 1*pe90m7 + 1*pe90m10 + 1*pe90m12
  RIadhd9 =~ 1*pe91m5 + 1*pe91m7 + 1*pe91m10 + 1*pe91m12
  #Hyperactivity symptoms
  RIadhd10 =~ 1*pe84m5 + 1*pe84m7 + 1*pe84m10 + 1*pe84m12
  RIadhd11 =~ 1*pe85m5 + 1*pe85m7 + 1*pe85m10 + 1*pe85m12
  RIadhd12 =~ 1*pe96m5 + 1*pe96m7 + 1*pe96m10 + 1*pe96m12
  RIadhd13 =~ 1*pe97m5 + 1*pe97m7 + 1*pe97m10 + 1*pe97m12
  RIadhd14 =~ 1*pe92m5 + 1*pe92m7 + 1*pe92m10 + 1*pe92m12
  RIadhd15 =~ 1*pe93m5 + 1*pe93m7 + 1*pe93m10 + 1*pe93m12
  RIadhd16 =~ 1*pe94m5 + 1*pe94m7 + 1*pe94m10 + 1*pe94m12
  RIadhd17 =~ 1*pe95m5 + 1*pe95m7 + 1*pe95m10 + 1*pe95m12
  RIadhd18 =~ 1*pe64m5 + 1*pe64m7 + 1*pe64m10 + 1*pe64m12
  
  # Create between factors (random intercepts) for each item of social isolation (mother report)
  RIsi1 =~ 1*pe2m5 + 1*pe2m7 + 1*pe2m10 + 1*pe2m12 
  RIsi2 =~ 1*pe4m5 + 1*pe4m7 + 1*pe4m10 + 1*pe4m12
  RIsi3 =~ 1*pe7m5 + 1*pe7m7 + 1*pe7m10 + 1*pe7m12
  RIsi4 =~ 1*pe11m5 + 1*pe11m7 + 1*pe11m10 + 1*pe11m12
  RIsi5 =~ 1*pe13m5 + 1*pe13m7 + 1*pe13m10 + 1*pe13m12
  RIsi6 =~ 1*pe25m5 + 1*pe25m7 + 1*pe25m10 + 1*pe25m12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for ADHD (inattention and hyperactivity) symptoms at 4 waves
  WFadhd5 =~ a*pe81m5 + b*pe82m5 + c*pe83m5 + d*pe86m5 + e*pe87m5 + f*pe88m5 + g*pe89m5 + h*pe90m5 + i*pe91m5 + j*pe84m5 + k*pe85m5 + l*pe96m5 + m*pe97m5 + n*pe92m5 + o*pe93m5 + p*pe94m5 + q*pe95m5 + r*pe64m5
  WFadhd7 =~ a*pe81m7 + b*pe82m7 + c*pe83m7 + d*pe86m7 + e*pe87m7 + f*pe88m7 + g*pe89m7 + h*pe90m7 + i*pe91m7 + j*pe84m7 + k*pe85m7 + l*pe96m7 + m*pe97m7 + n*pe92m7 + o*pe93m7 + p*pe94m7 + q*pe95m7 + r*pe64m7
  WFadhd10 =~ a*pe81m10 + b*pe82m10 + c*pe83m10 + d*pe86m10 + e*pe87m10 + f*pe88m10 + g*pe89m10 + h*pe90m10 + i*pe91m10 + j*pe84m10 + k*pe85m10 + l*pe96m10 + m*pe97m10 + n*pe92m10 + o*pe93m10 + p*pe94m10 + q*pe95m10 + r*pe64m10
  WFadhd12 =~ a*pe81m12 + b*pe82m12 + c*pe83m12 + d*pe86m12 + e*pe87m12 + f*pe88m12 + g*pe89m12 + h*pe90m12 + i*pe91m12 + j*pe84m12 + k*pe85m12 + l*pe96m12 + m*pe97m12 + n*pe92m12 + o*pe93m12 + p*pe94m12 + q*pe95m12 + r*pe64m12 
  
  # Factor models for social isolation at 4 waves
  WFsi5 =~ s*pe2m5 + t*pe4m5 + u*pe7m5 + v*pe11m5 + w*pe13m5 + x*pe25m5 
  WFsi7 =~ s*pe2m7 + t*pe4m7 + u*pe7m7 + v*pe11m7 + w*pe13m7 + x*pe25m7 
  WFsi10 =~ s*pe2m10 + t*pe4m10 + u*pe7m10 + v*pe11m10 + w*pe13m10 + x*pe25m10
  WFsi12 =~ s*pe2m12 + t*pe4m12 + u*pe7m12 + v*pe11m12 + w*pe13m12 + x*pe25m12
  
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  # Inattention symptoms
  pe81m5 + pe81m7 + pe81m10 + pe81m12 ~ y*1
  pe82m5 + pe82m7 + pe82m10 + pe82m12 ~ z*1
  pe83m5 + pe83m7 + pe83m10 + pe83m12 ~ aa*1
  pe86m5 + pe86m7 + pe86m10 + pe86m12 ~ ab*1
  pe87m5 + pe87m7 + pe87m10 + pe87m12 ~ ac*1
  pe88m5 + pe88m7 + pe88m10 + pe88m12 ~ ad*1
  pe89m5 + pe89m7 + pe89m10 + pe89m12 ~ ae*1
  pe90m5 + pe90m7 + pe90m10 + pe90m12 ~ af*1
  pe91m5 + pe91m7 + pe91m10 + pe91m12 ~ ag*1
  # Hyperactivity symptoms
  pe84m5 + pe84m7 + pe84m10 + pe84m12 ~ ah*1
  pe85m5 + pe85m7 + pe85m10 + pe85m12 ~ ai*1
  pe96m5 + pe96m7 + pe96m10 + pe96m12 ~ aj*1
  pe97m5 + pe97m7 + pe97m10 + pe97m12 ~ ak*1
  pe92m5 + pe92m7 + pe92m10 + pe92m12 ~ al*1
  pe93m5 + pe93m7 + pe93m10 + pe93m12 ~ am*1
  pe94m5 + pe94m7 + pe94m10 + pe94m12 ~ an*1
  pe95m5 + pe95m7 + pe95m10 + pe95m12 ~ ao*1
  pe64m5 + pe64m7 + pe64m10 + pe64m12 ~ ap*1

  # Social isolation
  pe2m5 + pe2m7 + pe2m10 + pe2m12 ~ aq*1
  pe4m5 + pe4m7 + pe4m10 + pe4m12 ~ ar*1
  pe7m5 + pe7m7 + pe7m10 + pe7m12 ~ as*1
  pe11m5 + pe11m7 + pe11m10 + pe11m12 ~ at*1
  pe13m5 + pe13m7 + pe13m10 + pe13m12 ~ au*1
  pe25m5 + pe25m7 + pe25m10 + pe25m12 ~ av*1
  
  # Free latent means from t = 2 onward (only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  WFadhd7 + WFadhd10 + WFadhd12 + WFsi7 + WFsi10 + WFsi12 ~ 1
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFadhd7 + WFsi7 ~ WFadhd5 + WFsi5
  WFadhd10 + WFsi10 ~ WFadhd7 + WFsi7
  WFadhd12 + WFsi12 ~ WFadhd10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFadhd5 ~~ WFsi5
  WFadhd7 ~~ WFsi7
  WFadhd10 ~~ WFsi10 
  WFadhd12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIadhd1 + RIadhd2 + RIadhd3 + RIadhd4 + RIadhd5 + RIadhd6 + RIadhd7 + RIadhd8 + RIadhd9 + RIadhd10 + RIadhd11 + RIadhd12 + RIadhd13 + RIadhd14 + RIadhd15 + RIadhd16 + RIadhd17 + RIadhd18 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFadhd5
'
```

```{r fit RICLPM_multi_adhd_S3}
RICLPM_multi_adhd_S3.fit <- cfa(RICLPM_multi_adhd_S3, 
                           data = dat, 
                          # se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

RICLPM_multi_adhd_S3.fit.summary <- summary(RICLPM_multi_adhd_S3.fit, 
                                            fit.measures = TRUE,
                                            standardized = TRUE)
```

S3 Model fit:
Comparative Fit Index (CFI)                    0.984 (>0.95)  Change in CFI:    0.00 (decrease) - same fit 
Tucker-Lewis Index (TLI)                       0.983 (>0.95)  Change in TLI:    0.00 (decrease) - same fit     
RMSEA                                          0.017 (≤ 0.06) Change in RMSEA:  0.00 (increase) - same fit         
90 Percent confidence interval - lower         0.016 
90 Percent confidence interval - upper         0.018       
SRMR                                           0.038 (≤ 0.08) Change in SRMR:   0.00 (increase) - same fit  

Now we need to conduct a Likelihood ratio test and compare the model fit for S1 and S2 to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. 

```{r compare fit RICLPM_multi_adhd_S2 and RICLPM_hyp_adhd_S3}
summary(semTools::compareFit(RICLPM_multi_adhd_S2.fit, RICLPM_multi_adhd_S3.fit, nested = TRUE)) #† indicates the best fitting model 
```

*** 
below table rows need updating 
***
```{r tables for total ADHD S3}
# Table of model fit 
RICLPM_multi_adhd_S3.fit.summary.fit <- as.data.frame(t(as.data.frame(RICLPM_multi_adhd_S3.fit.summary$FIT)))[,c(3,4,9,10,13,14,16,17,18,19,21)]

# Table of regression coefficient 
RICLPM2d.fit.summary.reg <- as.tibble(RICLPM2d.fit.summary$PE[c(17:28),-c(4,5)])

# Table of co-variances - concurrent associations between SI and ADHD
RICLPM2d.fit.summary.covar <- as.tibble(RICLPM2d.fit.summary$PE[c(29:32),-c(4,5)])
```

## RICLPM_multi_adhd_S4: Total ADHD symptoms step 4 - *Full model*

From Mulder and Hamaker (2021):
A significant chi-square difference test would mean strong factorial invariance does not hold, implying that the actual scores cannot be compared over time, but individual differences in scores can still be meaningfully compared since weak factorial invariance holds. As the focus in cross-lagged panel modeling is primarily on comparing individual differences (by decomposing the observed scores into between-unit and withinunit components) rather than mean scores over time, weak factorial invariance may be enough. However, from a measurement point of view, having strong factorial invariance would be considered more ideal.

Instead of including a random intercept at the observed level for each indicator separately (as done so far and in the upper part of the figure at the beginning of this document), we can also choose to specify the entire RI-CLPM at the latent level; this is illustrated in the lower part of the beginning figure. This can be done in either a model with weak or strong factorial invariance over time. To this end, we specify the common factors that capture both trait-like and state-like common variance, and thereby make the assumption that the trait- and state structures coincide. We then decompose these latent variables into a stable, between-unit part and the within-unit components.

We set the factor loadings of these second-order factors to be identical to the corresponding factor loadings of the withinunit factors. Additionally, we constrain the residual variances for the first-order factors to zero. This model is nested under the model we just presented (top panel of the figure), and is statistically equivalent to the model presented in the lower panel of the figure. This implies that we can use a chi-square difference test to compare. 

Multiple indicator RI-CLPM, 5 waves with 3 indicators for each variable at each wave (30 observed variables). Fitting a model with constraints to ensure strong factorial invariance, with the RI-CLPM at the latent level.

```{r specify RICLPM_multi_adhd_S4}
RICLPM_multi_adhd_S4 <- '
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for ADHD (inattention and hyperactivity) symptoms at 4 waves
  Fadhd5 =~ a*pe81m5 + b*pe82m5 + c*pe83m5 + d*pe86m5 + e*pe87m5 + f*pe88m5 + g*pe89m5 + h*pe90m5 + i*pe91m5 + j*pe84m5 + k*pe85m5 + l*pe96m5 + m*pe97m5 + n*pe92m5 + o*pe93m5 + p*pe94m5 + q*pe95m5 + r*pe64m5
  Fadhd7 =~ a*pe81m7 + b*pe82m7 + c*pe83m7 + d*pe86m7 + e*pe87m7 + f*pe88m7 + g*pe89m7 + h*pe90m7 + i*pe91m7 + j*pe84m7 + k*pe85m7 + l*pe96m7 + m*pe97m7 + n*pe92m7 + o*pe93m7 + p*pe94m7 + q*pe95m7 + r*pe64m7
  Fadhd10 =~ a*pe81m10 + b*pe82m10 + c*pe83m10 + d*pe86m10 + e*pe87m10 + f*pe88m10 + g*pe89m10 + h*pe90m10 + i*pe91m10 + j*pe84m10 + k*pe85m10 + l*pe96m10 + m*pe97m10 + n*pe92m10 + o*pe93m10 + p*pe94m10 + q*pe95m10 + r*pe64m10
  Fadhd12 =~ a*pe81m12 + b*pe82m12 + c*pe83m12 + d*pe86m12 + e*pe87m12 + f*pe88m12 + g*pe89m12 + h*pe90m12 + i*pe91m12 + j*pe84m12 + k*pe85m12 + l*pe96m12 + m*pe97m12 + n*pe92m12 + o*pe93m12 + p*pe94m12 + q*pe95m12 + r*pe64m12 
  
  # Factor models for social isolation at 4 waves
  Fsi5 =~ s*pe2m5 + t*pe4m5 + u*pe7m5 + v*pe11m5 + w*pe13m5 + x*pe25m5 
  Fsi7 =~ s*pe2m7 + t*pe4m7 + u*pe7m7 + v*pe11m7 + w*pe13m7 + x*pe25m7 
  Fsi10 =~ s*pe2m10 + t*pe4m10 + u*pe7m10 + v*pe11m10 + w*pe13m10 + x*pe25m10
  Fsi12 =~ s*pe2m12 + t*pe4m12 + u*pe7m12 + v*pe11m12 + w*pe13m12 + x*pe25m12
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  # Inattention symptoms
  pe81m5 + pe81m7 + pe81m10 + pe81m12 ~ y*1
  pe82m5 + pe82m7 + pe82m10 + pe82m12 ~ z*1
  pe83m5 + pe83m7 + pe83m10 + pe83m12 ~ aa*1
  pe86m5 + pe86m7 + pe86m10 + pe86m12 ~ ab*1
  pe87m5 + pe87m7 + pe87m10 + pe87m12 ~ ac*1
  pe88m5 + pe88m7 + pe88m10 + pe88m12 ~ ad*1
  pe89m5 + pe89m7 + pe89m10 + pe89m12 ~ ae*1
  pe90m5 + pe90m7 + pe90m10 + pe90m12 ~ af*1
  pe91m5 + pe91m7 + pe91m10 + pe91m12 ~ ag*1
  # Hyperactivity symptoms
  pe84m5 + pe84m7 + pe84m10 + pe84m12 ~ ah*1
  pe85m5 + pe85m7 + pe85m10 + pe85m12 ~ ai*1
  pe96m5 + pe96m7 + pe96m10 + pe96m12 ~ aj*1
  pe97m5 + pe97m7 + pe97m10 + pe97m12 ~ ak*1
  pe92m5 + pe92m7 + pe92m10 + pe92m12 ~ al*1
  pe93m5 + pe93m7 + pe93m10 + pe93m12 ~ am*1
  pe94m5 + pe94m7 + pe94m10 + pe94m12 ~ an*1
  pe95m5 + pe95m7 + pe95m10 + pe95m12 ~ ao*1
  pe64m5 + pe64m7 + pe64m10 + pe64m12 ~ ap*1

  # Social isolation
  pe2m5 + pe2m7 + pe2m10 + pe2m12 ~ aq*1
  pe4m5 + pe4m7 + pe4m10 + pe4m12 ~ ar*1
  pe7m5 + pe7m7 + pe7m10 + pe7m12 ~ as*1
  pe11m5 + pe11m7 + pe11m10 + pe11m12 ~ at*1
  pe13m5 + pe13m7 + pe13m10 + pe13m12 ~ au*1
  pe25m5 + pe25m7 + pe25m10 + pe25m12 ~ av*1
  
  # Free latent means from t = 2 onward (only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  Fadhd7 + Fadhd10 + Fadhd12 + Fsi7 + Fsi10 + Fsi12 ~ 1
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) 
  RIadhd =~ 1*Fadhd5 + 1*Fadhd7 + 1*Fadhd10 + 1*Fadhd12
  RIsi =~ 1*Fsi5 + 1*Fsi7 + 1*Fsi10 + 1*Fsi12
  
  # Set the residual variances of all Fadhd and Fsi variables to 0. 
  Fadhd5 ~~ 0*Fadhd5
  Fadhd7 ~~ 0*Fadhd7
  Fadhd10 ~~ 0*Fadhd10
  Fadhd12 ~~ 0*Fadhd12
  Fsi5 ~~ 0*Fsi5
  Fsi7 ~~ 0*Fsi7
  Fsi10 ~~ 0*Fsi10
  Fsi12 ~~ 0*Fsi12
  
  ###############
  # WITHIN PART #
  ###############
  
  # Create the within-part
  WFadhd5 =~ 1*Fadhd5
  WFadhd7 =~ 1*Fadhd7
  WFadhd10 =~ 1*Fadhd10
  WFadhd12 =~ 1*Fadhd12
  
  WFsi5 =~ 1*Fsi5
  WFsi7 =~ 1*Fsi7
  WFsi10 =~ 1*Fsi10
  WFsi12 =~ 1*Fsi12
  
  # Specify the lagged effects between the within-person centered latent variables
  WFadhd7 + WFsi7 ~ WFadhd5 + WFsi5
  WFadhd10 + WFsi10 ~ WFadhd7 + WFsi7
  WFadhd12 + WFsi12 ~ WFadhd10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFadhd5 ~~ WFsi5
  WFadhd7 ~~ WFsi7
  WFadhd10 ~~ WFsi10 
  WFadhd12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Set correlations between the between-factors (random intercepts) and within-factors at wave 1 (age 5) at 0
  RIadhd + RIsi ~~ 0*WFadhd5 + 0*WFsi5
'
```

```{r fit RICLPM_multi_adhd_S4}
RICLPM_multi_adhd_S4.fit <- cfa(RICLPM_multi_adhd_S4, 
                           data = dat, 
                         #  se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

summary(RICLPM_multi_adhd_S4.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S4 Model fit:
(We have included here the change in CFI, TLI and RMSEA compared to the S3 model)
Comparative Fit Index (CFI)                    0. (>0.95)    Change in CFI:   0.0 (decrease) - worse fit 
Tucker-Lewis Index (TLI)                       0. (>0.95)    Change in TLI:   0.0 (decrease) - worse fit 
RMSEA                                          0. (≤ 0.06)   Change in RMSEA: 0.0 (increase) - worse fit
90 Percent confidence interval - lower         0. 
90 Percent confidence interval - upper         0.       
SRMR                                           0. (≤ 0.08)   Change in SRMR: 0.0 (increase)  - worse fit 

Now we need to conduct a Likelihood ratio test to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. We use the compareFit command which gives the LRT with the comparison in model fit for the two models. 

```{r compare fit RICLPM_multi_adhd_S3 and RICLPM_multi_adhd_S4}
summary(semTools::compareFit(RICLPM_multi_adhd_S3.fit, RICLPM_multi_adhd_S4.fit, nested = TRUE)) #† indicates the best fitting model
```

**As all fit indices changed by more than 0.01 - we cannot accept this measurement model.**

***

# Teacher report RI-CLPM: Inattention and social isolation

## RICLPM_multi_inat_S1: Inattention step 1

**Multiple response items RICLPM teacher report inattention ADHD symptoms and social isolation: Step 1, the configural model**  

The configural model is the least stringent test of invariance, it is designed to test if the constructs have the same pattern of free and fixed loadings. Configural *non*invariance means that the pattern of loadings of items on the latent factors differs over the time points. This would then suggest that a slightly different concept is being measured at each time point (Putnick and Bornstein, 2016). To test if the configural variance holds, we will look at the fit of the configural model (S1).

We have six indicators of $Social isolation$, measured at four waves, we specify six random intercepts to capture the trait-like part of each indicator, that is, `RIX1 =~ 1*x11 1*x21 ...`, and `RIX2 =~ 1*x121 1*x22@1 ...`. In addition, we specify four within-unit components that capture the state-like part at each wave, using `WFX1 =~ x11 x12 x13; WFX2 =~ x21 x22 x23; ...`.

At the latent within-unit level, we specify the dynamic model using `WFX2 ~ WFY1 + WFX1; WFX3 ~ WFY2 + WFX2; ...`. In addition, we allow the within-person factors at the first wave, and their residuals at subsequent waves to be correlated within each wave, `WFX1 ~~ WFY1; WFX2 ~~ WFY2; ...`. The random intercepts are allowed to be freely correlated with each other through using the cfa() command below. 

```{r specify RICLPMt_multi_inat_S1}
RICLPMt_multi_inat_S1 <- '
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of inattention (teacher report)
  RIinat1 =~ 1*trf89e5 + 1*trf89e7 + 1*trf89e10 + 1*trf89e12
  RIinat2 =~ 1*trf90e5 + 1*trf90e7 + 1*trf90e10 + 1*trf90e12
  RIinat3 =~ 1*trf91e5 + 1*trf91e7 + 1*trf91e10 + 1*trf91e12
  RIinat4 =~ 1*trf94e5 + 1*trf94e7 + 1*trf94e10 + 1*trf94e12
  RIinat5 =~ 1*trf95e5 + 1*trf95e7 + 1*trf95e10 + 1*trf95e12
  RIinat6 =~ 1*trf96e5 + 1*trf96e7 + 1*trf96e10 + 1*trf96e12
  RIinat7 =~ 1*trf97e5 + 1*trf97e7 + 1*trf97e10 + 1*trf97e12
  RIinat8 =~ 1*trf98e5 + 1*trf98e7 + 1*trf98e10 + 1*trf98e12
  RIinat9 =~ 1*trf99e5 + 1*trf99e7 + 1*trf99e10 + 1*trf99e12
  
  # Create between factors (random intercepts) for each item of social isolation (teacher report)
  RIsi1 =~ 1*trf11e5 + 1*trf11e7 + 1*trf11e10 + 1*trf11e12 
  RIsi2 =~ 1*trf19e5 + 1*trf19e7 + 1*trf19e10 + 1*trf19e12
  RIsi3 =~ 1*trf24e5 + 1*trf24e7 + 1*trf24e10 + 1*trf24e12
  RIsi4 =~ 1*trf30e5 + 1*trf30e7 + 1*trf30e10 + 1*trf30e12
  RIsi5 =~ 1*trf34e5 + 1*trf34e7 + 1*trf34e10 + 1*trf34e12
  RIsi6 =~ 1*trf77e5 + 1*trf77e7 + 1*trf77e10 + 1*trf77e12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for inattention symptoms at 4 waves
  WFinat5 =~ trf89e5 + trf90e5 + trf91e5 + trf94e5 + trf95e5 + trf96e5 + trf97e5 + trf98e5 + trf99e5
  WFinat7 =~ trf89e7 + trf90e7 + trf91e7 + trf94e7 + trf95e7 + trf96e7 + trf97e7 + trf98e7 + trf99e7
  WFinat10 =~ trf89e10 + trf90e10 + trf91e10 + trf94e10 + trf95e10 + trf96e10 + trf97e10 + trf98e10 + trf99e10
  WFinat12 =~ trf89e12 + trf90e12 + trf91e12 + trf94e12 + trf95e12 + trf96e12 + trf97e12 + trf98e12 + trf99e12
  
  # Factor models for social isolation at 4 waves
  WFsi5 =~ trf11e5 + trf19e5 + trf24e5 + trf30e5 + trf34e5 + trf77e5 
  WFsi7 =~ trf11e7 + trf19e7 + trf24e7 + trf30e7 + trf34e7 + trf77e7 
  WFsi10 =~ trf11e10 + trf19e10 + trf24e10 + trf30e10 + trf34e10 + trf77e10 
  WFsi12 =~ trf11e12 + trf19e12 + trf24e12 + trf30e12 + trf34e12 + trf77e12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFinat7 + WFsi7 ~ WFinat5 + WFsi5
  WFinat10 + WFsi10 ~ WFinat7 + WFsi7
  WFinat12 + WFsi12 ~ WFinat10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFinat5 ~~ WFsi5
  WFinat7 ~~ WFsi7
  WFinat10 ~~ WFsi10 
  WFinat12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIinat1 + RIinat2 + RIinat3 + RIinat4 + RIinat5 + RIinat6 + RIinat7 + RIinat8 + RIinat9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFinat5
'
```

```{r fit RICLPMt_multi_inat_S1}
RICLPMt_multi_inat_S1.fit <- cfa(RICLPMt_multi_inat_S1, 
                           data = dat, 
                        #   se = "robust",         # computes robust standard errors to account for use of twins
                           ordered = TRUE,        # using the "ordered" option will use DWLS with polychoric correlations for the ordinal variables
                           missing = 'pairwise'    # only excludes people who are missing both variables
)

summary(RICLPMt_multi_inat_S1.fit, fit.measures = TRUE, standardized = TRUE)
```

For the pairwise deletion model without robust standard errors:
S1 Model fit (robust indices):
Comparative Fit Index (CFI)                    0.995 (>0.95)
Tucker-Lewis Index (TLI)                       0.995 (>0.95)      
RMSEA                                          0.012 (≤ 0.06)         
90 Percent confidence interval - lower         0.011 
90 Percent confidence interval - upper         0.014       
SRMR                                           0.051 (≤ 0.08)      

We can conclude that the model shows very good fit. 

## RICLPMt_multi_inat_S2: Inattention step 2 

**Multiple response items RICLPMt teacher report inattention ADHD symptoms and social isolation: Step 2**.
If configural variance is supported, we next test for weak invariance (sometimes called metric invariance). This tests for the equivalence of the item loadings on the factors. Weak (metric) invariance means that each item contributes to the latent construct to a similar degree across groups. this is tested by constraining factor loadings (i.e., the loadings of the items on the constructs) to be equivalent in the two time points (Putnick and Bornstein, 2016). The model with constrained factor loadings (S2) is then compared to the configural invariance model (S1) to determine fit. If the overall model fit is significantly worse in the weak invariance model compared to the configural invariance model, it indicates that at least one loading is not equivalent across the groups, and weak invariance is not supported.

In our second step model, we constrain the factor loadings to be invariant over time using the labels `a*`, `b*`, `c*`, `d*` etc, in the "within" part of the model. 

```{r specify RICLPMt_multi_inat_S2}
RICLPMt_multi_inat_S2 <- '
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of inattention (teacher report)
  RIinat1 =~ 1*trf89e5 + 1*trf89e7 + 1*trf89e10 + 1*trf89e12
  RIinat2 =~ 1*trf90e5 + 1*trf90e7 + 1*trf90e10 + 1*trf90e12
  RIinat3 =~ 1*trf91e5 + 1*trf91e7 + 1*trf91e10 + 1*trf91e12
  RIinat4 =~ 1*trf94e5 + 1*trf94e7 + 1*trf94e10 + 1*trf94e12
  RIinat5 =~ 1*trf95e5 + 1*trf95e7 + 1*trf95e10 + 1*trf95e12
  RIinat6 =~ 1*trf96e5 + 1*trf96e7 + 1*trf96e10 + 1*trf96e12
  RIinat7 =~ 1*trf97e5 + 1*trf97e7 + 1*trf97e10 + 1*trf97e12
  RIinat8 =~ 1*trf98e5 + 1*trf98e7 + 1*trf98e10 + 1*trf98e12
  RIinat9 =~ 1*trf99e5 + 1*trf99e7 + 1*trf99e10 + 1*trf99e12
  
  # Create between factors (random intercepts) for each item of social isolation (teacher report)
  RIsi1 =~ 1*trf11e5 + 1*trf11e7 + 1*trf11e10 + 1*trf11e12 
  RIsi2 =~ 1*trf19e5 + 1*trf19e7 + 1*trf19e10 + 1*trf19e12
  RIsi3 =~ 1*trf24e5 + 1*trf24e7 + 1*trf24e10 + 1*trf24e12
  RIsi4 =~ 1*trf30e5 + 1*trf30e7 + 1*trf30e10 + 1*trf30e12
  RIsi5 =~ 1*trf34e5 + 1*trf34e7 + 1*trf34e10 + 1*trf34e12
  RIsi6 =~ 1*trf77e5 + 1*trf77e7 + 1*trf77e10 + 1*trf77e12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for inattention symptoms at 4 waves (constrained)
  WFinat5 =~ a*trf89e5 + b*trf90e5 + c*trf91e5 + d*trf94e5 + e*trf95e5 + f*trf96e5 + g*trf97e5 + h*trf98e5 + i*trf99e5
  WFinat7 =~ a*trf89e7 + b*trf90e7 + c*trf91e7 + d*trf94e7 + e*trf95e7 + f*trf96e7 + g*trf97e7 + h*trf98e7 + i*trf99e7
  WFinat10 =~ a*trf89e10 + b*trf90e10 + c*trf91e10 + d*trf94e10 + e*trf95e10 + f*trf96e10 + g*trf97e10 + h*trf98e10 + i*trf99e10
  WFinat12 =~ a*trf89e12 + b*trf90e12 + c*trf91e12 + d*trf94e12 + e*trf95e12 + f*trf96e12 + g*trf97e12 + h*trf98e12 + i*trf99e12
  
  # Factor models for social isolation at 4 waves (constrained)
  WFsi5 =~ j*trf11e5 + k*trf19e5 + l*trf24e5 + m*trf30e5 + n*trf34e5 + o*trf77e5 
  WFsi7 =~ j*trf11e7 + k*trf19e7 + l*trf24e7 + m*trf30e7 + n*trf34e7 + o*trf77e7 
  WFsi10 =~ j*trf11e10 + k*trf19e10 + l*trf24e10 + m*trf30e10 + n*trf34e10 + o*trf77e10 
  WFsi12 =~ j*trf11e12 + k*trf19e12 + l*trf24e12 + m*trf30e12 + n*trf34e12 + o*trf77e12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFinat7 + WFsi7 ~ WFinat5 + WFsi5
  WFinat10 + WFsi10 ~ WFinat7 + WFsi7
  WFinat12 + WFsi12 ~ WFinat10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFinat5 ~~ WFsi5
  WFinat7 ~~ WFsi7
  WFinat10 ~~ WFsi10 
  WFinat12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIinat1 + RIinat2 + RIinat3 + RIinat4 + RIinat5 + RIinat6 + RIinat7 + RIinat8 + RIinat9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFinat5
'
```

```{r fit RICLPMt_multi_inat_S2}
RICLPMt_multi_inat_S2.fit <- cfa(RICLPMt_multi_inat_S2, 
                           data = dat, 
                          # se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

summary(RICLPMt_multi_inat_S2.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S2 for the pairwise deletion model without robust standard errors:
(We have included here the change in CFI, TLI and RMSEA compared to the S1 model)
Comparative Fit Index (CFI)                    0.995 (>0.95)    Change in CFI:   0.000 (increase) - same fit 
Tucker-Lewis Index (TLI)                       0.994 (>0.95)    Change in TLI:   0.001 (decrease) - worse fit 
RMSEA                                          0.013 (≤ 0.06)   Change in RMSEA: 0.001 (decrease) - worse fit
90 Percent confidence interval - lower         0.011 
90 Percent confidence interval - upper         0.014       
SRMR                                           0.052 (≤ 0.08)   Change in SRMR: 0.001 (increase)  - worse fit 

We can look at the best fitting model and the difference in fit indices by using the compareFit function from semTools. 

```{r compare fit RICLPMt_multi_inat_S1 and RICLPMt_multi_inat_S2}
summary(semTools::compareFit(RICLPMt_multi_inat_S1.fit, RICLPMt_multi_inat_S2.fit, nested = TRUE)) #† indicates the best fitting model - using the robust statistics
```

Now we need to conduct a Likelihood ratio test to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. 

Really important to note that the Chi Square p value is very likely to be significant when using large samples. We should consider the change in model fit as well as the Chi square.

```{r LRT for RICLPMt_multi_inat_S1 and RICLPMt_multi_inat_S2}
lavTestLRT(RICLPMt_multi_inat_S1.fit, RICLPMt_multi_inat_S2.fit)
```

Significantly worse fit to include the restrictions, p=0.000000163

**However this is almost never going to be nonsignificant, we can assume here that because the S2 model did not show substantial decrease in model fit (actually showed better fit than the S1 model), that weak invariance holds here.**

Now we will move onto strong invariance tests. 

## RICLPMt_multi_inat_S3: Inattention step 3

**Multiple response items RICLPMt teacher report inattention ADHD symptoms and social isolation: Step 3** 

As full or partial weak invariance is supported, the next step is to test for strong (scalar) invariance, or equivalence of item intercepts, for weak invariant items. Strong invariance means that mean differences in the latent construct capture all mean differences in the shared variance of the items. Strong invariance is tested by constraining the item intercepts to be equivalent in the two groups - with the restraint applied in the weak invariance model retained. *Any items that had unequal loadings in the weak invariance model (and were allowed to vary) should be allowed to vary in the strong invariance model because it is meaningless to test for equal item intercepts if the factor loadings of the items differs across groups* (Putnick and Bornstein, 2016). 

Fitting a model with constraints to ensure strong factorial invariance, with a random intercept for each indicator separately.

```{r specify RICLPMt_multi_inat_S3}
RICLPMt_multi_inat_S3 <- '
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of inattention (teacher report)
  RIinat1 =~ 1*trf89e5 + 1*trf89e7 + 1*trf89e10 + 1*trf89e12
  RIinat2 =~ 1*trf90e5 + 1*trf90e7 + 1*trf90e10 + 1*trf90e12
  RIinat3 =~ 1*trf91e5 + 1*trf91e7 + 1*trf91e10 + 1*trf91e12
  RIinat4 =~ 1*trf94e5 + 1*trf94e7 + 1*trf94e10 + 1*trf94e12
  RIinat5 =~ 1*trf95e5 + 1*trf95e7 + 1*trf95e10 + 1*trf95e12
  RIinat6 =~ 1*trf96e5 + 1*trf96e7 + 1*trf96e10 + 1*trf96e12
  RIinat7 =~ 1*trf97e5 + 1*trf97e7 + 1*trf97e10 + 1*trf97e12
  RIinat8 =~ 1*trf98e5 + 1*trf98e7 + 1*trf98e10 + 1*trf98e12
  RIinat9 =~ 1*trf99e5 + 1*trf99e7 + 1*trf99e10 + 1*trf99e12
  
  # Create between factors (random intercepts) for each item of social isolation (teacher report)
  RIsi1 =~ 1*trf11e5 + 1*trf11e7 + 1*trf11e10 + 1*trf11e12 
  RIsi2 =~ 1*trf19e5 + 1*trf19e7 + 1*trf19e10 + 1*trf19e12
  RIsi3 =~ 1*trf24e5 + 1*trf24e7 + 1*trf24e10 + 1*trf24e12
  RIsi4 =~ 1*trf30e5 + 1*trf30e7 + 1*trf30e10 + 1*trf30e12
  RIsi5 =~ 1*trf34e5 + 1*trf34e7 + 1*trf34e10 + 1*trf34e12
  RIsi6 =~ 1*trf77e5 + 1*trf77e7 + 1*trf77e10 + 1*trf77e12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for inattention symptoms at 4 waves (constrained)
  WFinat5 =~ a*trf89e5 + b*trf90e5 + c*trf91e5 + d*trf94e5 + e*trf95e5 + f*trf96e5 + g*trf97e5 + h*trf98e5 + i*trf99e5
  WFinat7 =~ a*trf89e7 + b*trf90e7 + c*trf91e7 + d*trf94e7 + e*trf95e7 + f*trf96e7 + g*trf97e7 + h*trf98e7 + i*trf99e7
  WFinat10 =~ a*trf89e10 + b*trf90e10 + c*trf91e10 + d*trf94e10 + e*trf95e10 + f*trf96e10 + g*trf97e10 + h*trf98e10 + i*trf99e10
  WFinat12 =~ a*trf89e12 + b*trf90e12 + c*trf91e12 + d*trf94e12 + e*trf95e12 + f*trf96e12 + g*trf97e12 + h*trf98e12 + i*trf99e12
  
  # Factor models for social isolation at 4 waves (constrained)
  WFsi5 =~ j*trf11e5 + k*trf19e5 + l*trf24e5 + m*trf30e5 + n*trf34e5 + o*trf77e5 
  WFsi7 =~ j*trf11e7 + k*trf19e7 + l*trf24e7 + m*trf30e7 + n*trf34e7 + o*trf77e7 
  WFsi10 =~ j*trf11e10 + k*trf19e10 + l*trf24e10 + m*trf30e10 + n*trf34e10 + o*trf77e10 
  WFsi12 =~ j*trf11e12 + k*trf19e12 + l*trf24e12 + m*trf30e12 + n*trf34e12 + o*trf77e12
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  trf89e5 + trf89e7 + trf89e10 + trf89e12 ~ p*1
  trf90e5 + trf90e7 + trf90e10 + trf90e12 ~ q*1
  trf91e5 + trf91e7 + trf91e10 + trf91e12 ~ r*1
  trf94e5 + trf94e7 + trf94e10 + trf94e12 ~ s*1
  trf95e5 + trf95e7 + trf95e10 + trf95e12 ~ t*1
  trf96e5 + trf96e7 + trf96e10 + trf96e12 ~ u*1
  trf97e5 + trf97e7 + trf97e10 + trf97e12 ~ v*1
  trf98e5 + trf98e7 + trf98e10 + trf98e12 ~ w*1
  trf99e5 + trf99e7 + trf99e10 + trf99e12 ~ x*1
  
  trf11e5 + trf11e7 + trf11e10 + trf11e12 ~ y*1
  trf19e5 + trf19e7 + trf19e10 + trf19e12 ~ z*1
  trf24e5 + trf24e7 + trf24e10 + trf24e12 ~ aa*1
  trf30e5 + trf30e7 + trf30e10 + trf30e12 ~ ab*1
  trf34e5 + trf34e7 + trf34e10 + trf34e12 ~ ac*1
  trf77e5 + trf77e7 + trf77e10 + trf77e12 ~ ad*1
  
  # Free latent means from timepoint = 2 (age 7) onward. 
  # Only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  WFinat7 + WFinat10 + WFinat12 + WFsi7 + WFsi10 + WFsi12 ~ 1
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFinat7 + WFsi7 ~ WFinat5 + WFsi5
  WFinat10 + WFsi10 ~ WFinat7 + WFsi7
  WFinat12 + WFsi12 ~ WFinat10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFinat5 ~~ WFsi5
  WFinat7 ~~ WFsi7
  WFinat10 ~~ WFsi10 
  WFinat12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIinat1 + RIinat2 + RIinat3 + RIinat4 + RIinat5 + RIinat6 + RIinat7 + RIinat8 + RIinat9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFinat5
'
```

```{r fit RICLPMt_multi_inat_S3}
RICLPMt_multi_inat_S3.fit <- cfa(RICLPMt_multi_inat_S3, 
                           data = dat, 
                       #    se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise')

RICLPMt_multi_inat_S3.fit.summary <- summary(RICLPMt_multi_inat_S3.fit, 
                                            fit.measures = TRUE,
                                            standardized = TRUE)
```  

S3 Model fit (no robust se):
(We have included here the change in CFI, TLI and RMSEA compared to the S1 model)
Comparative Fit Index (CFI)                    0.995 (>0.95)    Change in CFI:   0.000 (decrease)
Tucker-Lewis Index (TLI)                       0.994 (>0.95)    Change in TLI:   0.000 (decrease)
RMSEA                                          0.013 (≤ 0.06)   Change in RMSEA: 0.000 (increase)
90 Percent confidence interval - lower         0.011 
90 Percent confidence interval - upper         0.014       
SRMR                                           0.052 (≤ 0.08)   Change in SRMR:  0.000 

We attempted to view the fit differences using semTools but it gives the error "a dimention is zero" - which I think means that there is no differences to test here. And this is somethign to do with the way the models are specified. But there is no difference in model fit between S2 and S3, so we can assume that **strong invariance holds here.**

```{r LRT for RICLPMt_multi_inat_S2 and RICLPMt_multi_inat_S3}
#lavTestLRT(RICLPMt_multi_inat_S2.fit, RICLPMt_multi_inat_S3.fit)
```

```{r compare fit RICLPMt_multi_inat_S2 and RICLPMt_multi_inat_S3}
summary(semTools::compareFit(RICLPMt_multi_inat_S2.fit, RICLPMt_multi_inat_S3.fit, nested = TRUE)) #† indicates the best fitting model - have hashed out here
```

Our model does not loose *any* fit, which means we can assume that strong factorial invariance holds over time. In contrast, If the overall model fit is not significantly worse in the strong invariance model compared to the weak invariance model, it indicates that constraining the item intercepts across time points does not significantly affect the model fit, and strong invariance is supported. 

**Going forward, we will assume that we have strong invariance for our inattention and social isolation mother report RI-CLPM.**

***

## RICLPMt_multi_inat_S4: Inattention step 4 - *Full model*

From Mulder and Hamaker (2021):
A significant chi-square difference test would mean strong factorial invariance does not hold, implying that the actual scores cannot be compared over time, but individual differences in scores can still be meaningfully compared since weak factorial invariance holds. As the focus in cross-lagged panel modeling is primarily on comparing individual differences (by decomposing the observed scores into between-unit and withinunit components) rather than mean scores over time, weak factorial invariance may be enough. However, from a measurement point of view, having strong factorial invariance would be considered more ideal.

Instead of including a random intercept at the observed level for each indicator separately (as done so far and in the upper part of the figure at the beginning of this document), we can also choose to specify the entire RI-CLPM at the latent level; this is illustrated in the lower part of the beginning figure. This can be done in either a model with weak or strong factorial invariance over time. To this end, we specify the common factors that capture both trait-like and state-like common variance, and thereby make the assumption that the trait- and state structures coincide. We then decompose these latent variables into a stable, between-unit part and the within-unit components.

We set the factor loadings of these second-order factors to be identical to the corresponding factor loadings of the within unit factors. Additionally, we constrain the residual variances for the first-order factors to zero. This model is nested under the model we just presented, and is statistically equivalent to the model presented in the lower panel of the figure at the top of the script. This implies that we can use a chi-square difference test to compare. 

Multiple indicator RI-CLPM, 4 waves with 9 indicators for inattention and 6 indicators for social isolation. Fitting a model with constraints to ensure strong factorial invariance, with the RI-CLPM at the latent level.

```{r specify RICLPMt_multi_inat_S4}
RICLPMt_multi_inat_S4 <- '
  #####################
  # MEASUREMENT MODEL #
  #####################
  
  # Factor models for inattention symptoms at 4 waves (constrained)
  Finat5 =~ a*trf89e5 + b*trf90e5 + c*trf91e5 + d*trf94e5 + e*trf95e5 + f*trf96e5 + g*trf97e5 + h*trf98e5 + i*trf99e5
  Finat7 =~ a*trf89e7 + b*trf90e7 + c*trf91e7 + d*trf94e7 + e*trf95e7 + f*trf96e7 + g*trf97e7 + h*trf98e7 + i*trf99e7
  Finat10 =~ a*trf89e10 + b*trf90e10 + c*trf91e10 + d*trf94e10 + e*trf95e10 + f*trf96e10 + g*trf97e10 + h*trf98e10 + i*trf99e10
  Finat12 =~ a*trf89e12 + b*trf90e12 + c*trf91e12 + d*trf94e12 + e*trf95e12 + f*trf96e12 + g*trf97e12 + h*trf98e12 + i*trf99e12
  
  # Factor models for social isolation at 4 waves (constrained)
  Fsi5 =~ j*trf11e5 + k*trf19e5 + l*trf24e5 + m*trf30e5 + n*trf34e5 + o*trf77e5 
  Fsi7 =~ j*trf11e7 + k*trf19e7 + l*trf24e7 + m*trf30e7 + n*trf34e7 + o*trf77e7 
  Fsi10 =~ j*trf11e10 + k*trf19e10 + l*trf24e10 + m*trf30e10 + n*trf34e10 + o*trf77e10 
  Fsi12 =~ j*trf11e12 + k*trf19e12 + l*trf24e12 + m*trf30e12 + n*trf34e12 + o*trf77e12
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  trf89e5 + trf89e7 + trf89e10 + trf89e12 ~ p*1
  trf90e5 + trf90e7 + trf90e10 + trf90e12 ~ q*1
  trf91e5 + trf91e7 + trf91e10 + trf91e12 ~ r*1
  trf94e5 + trf94e7 + trf94e10 + trf94e12 ~ s*1
  trf95e5 + trf95e7 + trf95e10 + trf95e12 ~ t*1
  trf96e5 + trf96e7 + trf96e10 + trf96e12 ~ u*1
  trf97e5 + trf97e7 + trf97e10 + trf97e12 ~ v*1
  trf98e5 + trf98e7 + trf98e10 + trf98e12 ~ w*1
  trf99e5 + trf99e7 + trf99e10 + trf99e12 ~ x*1
  
  trf11e5 + trf11e7 + trf11e10 + trf11e12 ~ y*1
  trf19e5 + trf19e7 + trf19e10 + trf19e12 ~ z*1
  trf24e5 + trf24e7 + trf24e10 + trf24e12 ~ aa*1
  trf30e5 + trf30e7 + trf30e10 + trf30e12 ~ ab*1
  trf34e5 + trf34e7 + trf34e10 + trf34e12 ~ ac*1
  trf77e5 + trf77e7 + trf77e10 + trf77e12 ~ ad*1
  
  # Free latent means from timepoint = 2 (age 7) onward. 
  # Only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  Finat7 + Finat10 + Finat12 + Fsi7 + Fsi10 + Fsi12 ~ 1
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts). 
  RIinat =~ 1*Finat5 + 1*Finat7 + 1*Finat10 + 1*Finat12 
  RIsi =~ 1*Fsi5 + 1*Fsi7 + 1*Fsi10 + 1*Fsi12
  
  # Set the residual variances of all Finat and Fsi variables to 0. 
  Finat5 ~~ 0*Finat5
  Finat7 ~~ 0*Finat7
  Finat10 ~~ 0*Finat10
  Finat12 ~~ 0*Finat12
  Fsi5 ~~ 0*Fsi5
  Fsi7 ~~ 0*Fsi7
  Fsi10 ~~ 0*Fsi10
  Fsi12 ~~ 0*Fsi12

  ###############
  # WITHIN PART #
  ###############
 
  # Create the within-part
  WFinat5 =~ 1*Finat5
  WFinat7 =~ 1*Finat7
  WFinat10 =~ 1*Finat10
  WFinat12 =~ 1*Finat12
  
  WFsi5 =~ 1*Fsi5
  WFsi7 =~ 1*Fsi7
  WFsi10 =~ 1*Fsi10
  WFsi12 =~ 1*Fsi12

  # Specify the lagged effects between the within-person centered latent variables
  WFinat7 + WFsi7 ~ WFinat5 + WFsi5
  WFinat10 + WFsi10 ~ WFinat7 + WFsi7
  WFinat12 + WFsi12 ~ WFinat10 + WFsi10
  
  # Estimate the correlations within the same wave - age 5 is missing here. 
  WFinat7 ~~ WFsi7
  WFinat10 ~~ WFsi10 
  WFinat12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Set correlations between the between-factors (random intercepts) and within-factors at wave 1 at 0. 
  RIinat + RIsi ~~ 0*WFinat5 + 0*WFsi5
'
```

```{r fit RICLPMt_multi_S4}
RICLPMt_multi_inat_S4.fit <- cfa(RICLPMt_multi_inat_S4, 
                           data = dat, 
                       #    se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise')

RICLPM_multi_inat_S4.fit.summary <- summary(RICLPMt_multi_inat_S4.fit, 
                                            fit.measures = TRUE,
                                            standardized = TRUE)
``` 

S4 Model fit (no robust se):
(We have included here the change in CFI, TLI and RMSEA compared to the S3 model)
Comparative Fit Index (CFI)                    0.984 (>0.95)    Change in CFI:   0.011 (decrease) - worse fit
Tucker-Lewis Index (TLI)                       0.983 (>0.95)    Change in TLI:   0.011 (decrease) - worse fit
RMSEA                                          0.022 (≤ 0.06)   Change in RMSEA: 0.011 (increase) - worse fit
90 Percent confidence interval - lower         0.021 
90 Percent confidence interval - upper         0.023       
SRMR                                           0.070 (≤ 0.08)   Change in SRMR:  0.018 (increase) - worse fit

```{r LRT for RICLPMt_multi_inat_S3 and RICLPMt_multi_inat_S4}
lavTestLRT(RICLPMt_multi_inat_S3.fit, RICLPMt_multi_inat_S4.fit)
```

According to the chi square - significantly worse fit, p<0.000001

```{r compare fit RICLPMt_multi_inat_S3 and RICLPMt_multi_inat_S4}
summary(semTools::compareFit(RICLPMt_multi_inat_S3.fit, RICLPMt_multi_inat_S4.fit, nested = TRUE)) #† indicates the best fitting model 
```

This is slightly tricky - I would be inclined to say that change of 0.011 in fit statistics and 0.018 in SRMR is not a substantial loss in fit. **Therefore, we can conclude that S4 is good fit for teacher report inattention scores and social isolation**

The nonsignificant chi square implies that the current model does not have to be rejected, and we can say that there is *measurement invariance across the stable between structure and fluctuating within-structure.* If the chi-square test is significant, then we need to conclude that *these structures do not coincide, and temporal fluctuations within individuals take place on a different underlying dimension than the stable differences between units* (see Hamaker et al. (2017) for further discussion on this).

From [Hamaker et al. (2017)](https://www.tandfonline.com/doi/full/10.1080/00273171.2016.1251299):
**need to add notes here**

To key points from [Hamaker et al., 2015](https://www.tandfonline.com/doi/pdf/10.1080/10705511.2020.1784738) (page 646 & 647)
1. The disadvantage of using sum and mean scores however is that one assumes an absence of measurement error, which often is an unrealistic assumption, especially within the social sciences (Griliches & Hausman, 1986). Failing to properly account for measurement error can bias lagged-parameter estimates downward, leading to a loss of power. Also, the estimation of factor scores is difficult due to the problem of factor indeterminacy (i.e., there are multiple ways to obtain factor scores, each with their own set of advantages and disadvantages), and it is unclear how this affects the results of the RI-CLPM.
2. The procedure described above for establishing measurement invariance relies heavily on chi-square difference testing which, as mentioned before, can have serious disadvantages such as an increased Type I and Type II error rate when the base model is misspecified (Yuan & Bentler, 2004). Alternatively, researchers can use equivalence testing **(Yuan & Chan, 2016)**, which allows researchers to explicitly specify an acceptable level of model misfit. 

#### Exported tables for this model - **this does not include robust standard errors at the moment**
```{r tables for RICLPMt_multi_inat_S4}
# Table of model fit 
RICLPM_multi_inat_S4.fit.summary.fit <- as.data.frame(t(as.data.frame(RICLPM_multi_inat_S4.fit.summary$FIT)))[,c(6,7,19,20,27,28,29,35)]
# Table of regression coefficients and covariances 
RICLPM_multi_inat_S4.fit.summary.reg <- as.tibble(RICLPM_multi_inat_S4.fit.summary$PE[c(151:165),-c(4,5)])
```
Here, suddenly the cross-lagged effects go negative??? Need to think about why this could be and what is means. 

***

# Multiple indicator RI-CLPM teacher report: Hyperactivity and social isolation

## RICLPMt_multi_hyp_S1: Hyperactivity/Implsivity step 1

**Multiple response items RICLPMt teacher report hyperactivity ADHD symptoms and social isolation: Step 1, the configural model**  

The configural model is the least stringent test of invariance, it is designed to test if the constructs have the same pattern of free and fixed loadings. Configural *non*invariance means that the pattern of loadings of items on the latent factors differs over the time points. This would then suggest that a slightly different concept is being measured at each time point (Putnick and Bornstein, 2016). To test if the configural variance holds, we will look at the fit of the configural model (S1).

```{r specify RICLPMt_multi_hyp_S1}
RICLPMt_multi_hyp_S1 <- '
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of hyperactivity (teacher report)
  RIhyp1 =~ 1*trf92e5 + 1*trf92e7 + 1*trf92e10 + 1*trf92e12
  RIhyp2 =~ 1*trf93e5 + 1*trf93e7 + 1*trf93e10 + 1*trf93e12
  RIhyp3 =~ 1*trf104e5 + 1*trf104e7 + 1*trf104e10 + 1*trf104e12
  RIhyp4 =~ 1*trf105e5 + 1*trf105e7 + 1*trf105e10 + 1*trf105e12
  RIhyp5 =~ 1*trf100e5 + 1*trf100e7 + 1*trf100e10 + 1*trf100e12
  RIhyp6 =~ 1*trf101e5 + 1*trf101e7 + 1*trf101e10 + 1*trf101e12
  RIhyp7 =~ 1*trf102e5 + 1*trf102e7 + 1*trf102e10 + 1*trf102e12
  RIhyp8 =~ 1*trf103e5 + 1*trf103e7 + 1*trf103e10 + 1*trf103e12
  RIhyp9 =~ 1*trf66e5 + 1*trf66e7 + 1*trf66e10 + 1*trf66e12
  
  # Create between factors (random intercepts) for each item of social isolation (teacher report)
  RIsi1 =~ 1*trf11e5 + 1*trf11e7 + 1*trf11e10 + 1*trf11e12 
  RIsi2 =~ 1*trf19e5 + 1*trf19e7 + 1*trf19e10 + 1*trf19e12
  RIsi3 =~ 1*trf24e5 + 1*trf24e7 + 1*trf24e10 + 1*trf24e12
  RIsi4 =~ 1*trf30e5 + 1*trf30e7 + 1*trf30e10 + 1*trf30e12
  RIsi5 =~ 1*trf34e5 + 1*trf34e7 + 1*trf34e10 + 1*trf34e12
  RIsi6 =~ 1*trf77e5 + 1*trf77e7 + 1*trf77e10 + 1*trf77e12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for hyperactivity symptoms at 4 waves
  WFhyp5 =~ trf92e5 + trf93e5 + trf104e5 + trf105e5 + trf100e5 + trf101e5 + trf102e5 + trf103e5 + trf66e5
  WFhyp7 =~ trf92e7 + trf93e7 + trf104e7 + trf105e7 + trf100e7 + trf101e7 + trf102e7 + trf103e7 + trf66e7
  WFhyp10 =~ trf92e10 + trf93e10 + trf104e10 + trf105e10 + trf100e10 + trf101e10 + trf102e10 + trf103e10 + trf66e10
  WFhyp12 =~ trf92e12 + trf93e12 + trf104e12 + trf105e12 + trf100e12 + trf101e12 + trf102e12 + trf103e12 + trf66e12
  
  # Factor models for social isolation at 4 waves
  WFsi5 =~ trf11e5 + trf19e5 + trf24e5 + trf30e5 + trf34e5 + trf77e5 
  WFsi7 =~ trf11e7 + trf19e7 + trf24e7 + trf30e7 + trf34e7 + trf77e7 
  WFsi10 =~ trf11e10 + trf19e10 + trf24e10 + trf30e10 + trf34e10 + trf77e10 
  WFsi12 =~ trf11e12 + trf19e12 + trf24e12 + trf30e12 + trf34e12 + trf77e12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFhyp7 + WFsi7 ~ WFhyp5 + WFsi5
  WFhyp10 + WFsi10 ~ WFhyp7 + WFsi7
  WFhyp12 + WFsi12 ~ WFhyp10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFhyp5 ~~ WFsi5
  WFhyp7 ~~ WFsi7
  WFhyp10 ~~ WFsi10 
  WFhyp12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIhyp1 + RIhyp2 + RIhyp3 + RIhyp4 + RIhyp5 + RIhyp6 + RIhyp7 + RIhyp8 + RIhyp9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFhyp5
'
```

```{r fit RICLPMt_multi_hyp_S1}
RICLPMt_multi_hyp_S1.fit <- cfa(RICLPMt_multi_hyp_S1, 
                           data = dat, 
                          # se = "robust",          # computes robust standard errors to account for use of twins
                           ordered = TRUE,          # using the "ordered" option will use DWLS with polychoric correlations for the ordinal variables
                           missing = 'pairwise'   # only excludes people who are missing both variables
)

summary(RICLPMt_multi_hyp_S1.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S1 Model fit:
Comparative Fit Index (CFI)                    0.992 (>0.95)
Tucker-Lewis Index (TLI)                       0.991 (>0.95)      
RMSEA                                          0.015 (≤ 0.06)         
90 Percent confidence interval - lower         0.014 
90 Percent confidence interval - upper         0.017       
SRMR                                           0.058 (≤ 0.08)      

We can conclude that the model shows good fit. 

## RICLPMt_multi_hyp_S2: Hyperactivity step 2 

**Multiple response items RICLPMt mother report hyperactivity ADHD symptoms and social isolation: Step 2**.
If configural variance is supported, we next test for weak invariance (sometimes called metric invariance). This tests for the equivalence of the item loadings on the factors. Weak (metric) invariance means that each item contributes to the latent construct to a similar degree across groups. this is tested by constraining factor loadings (i.e., the loadings of the items on the constructs) to be equivalent in the two time points (Putnick and Bornstein, 2016). The model with constrained factor loadings (S2) is then compared to the configural invariance model (S1) to determine fit. If the overall model fit is significantly worse in the weak invariance model compared to the configural invariance model, it indicates that at least one loading is not equivalent across the groups, and weak invariance is not supported.

In our second  step model, we constrain the factor loadings to be invariant over time using the labels `a*`, `b*`, `c*`, `d*` etc, in the "within" part of the model. 

```{r specify RICLPMt_multi_hyp_S2}
RICLPMt_multi_hyp_S2 <- '
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of hyperactivity (teacher report)
  RIhyp1 =~ 1*trf92e5 + 1*trf92e7 + 1*trf92e10 + 1*trf92e12
  RIhyp2 =~ 1*trf93e5 + 1*trf93e7 + 1*trf93e10 + 1*trf93e12
  RIhyp3 =~ 1*trf104e5 + 1*trf104e7 + 1*trf104e10 + 1*trf104e12
  RIhyp4 =~ 1*trf105e5 + 1*trf105e7 + 1*trf105e10 + 1*trf105e12
  RIhyp5 =~ 1*trf100e5 + 1*trf100e7 + 1*trf100e10 + 1*trf100e12
  RIhyp6 =~ 1*trf101e5 + 1*trf101e7 + 1*trf101e10 + 1*trf101e12
  RIhyp7 =~ 1*trf102e5 + 1*trf102e7 + 1*trf102e10 + 1*trf102e12
  RIhyp8 =~ 1*trf103e5 + 1*trf103e7 + 1*trf103e10 + 1*trf103e12
  RIhyp9 =~ 1*trf66e5 + 1*trf66e7 + 1*trf66e10 + 1*trf66e12
  
  # Create between factors (random intercepts) for each item of social isolation (teacher report)
  RIsi1 =~ 1*trf11e5 + 1*trf11e7 + 1*trf11e10 + 1*trf11e12 
  RIsi2 =~ 1*trf19e5 + 1*trf19e7 + 1*trf19e10 + 1*trf19e12
  RIsi3 =~ 1*trf24e5 + 1*trf24e7 + 1*trf24e10 + 1*trf24e12
  RIsi4 =~ 1*trf30e5 + 1*trf30e7 + 1*trf30e10 + 1*trf30e12
  RIsi5 =~ 1*trf34e5 + 1*trf34e7 + 1*trf34e10 + 1*trf34e12
  RIsi6 =~ 1*trf77e5 + 1*trf77e7 + 1*trf77e10 + 1*trf77e12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for hyperactivity symptoms at 4 waves
  WFhyp5 =~ a*trf92e5 + b*trf93e5 + c*trf104e5 + d*trf105e5 + e*trf100e5 + f*trf101e5 + g*trf102e5 + h*trf103e5 + i*trf66e5
  WFhyp7 =~ a*trf92e7 + b*trf93e7 + c*trf104e7 + d*trf105e7 + e*trf100e7 + f*trf101e7 + g*trf102e7 + h*trf103e7 + i*trf66e7
  WFhyp10 =~ a*trf92e10 + b*trf93e10 + c*trf104e10 + d*trf105e10 + e*trf100e10 + f*trf101e10 + g*trf102e10 + h*trf103e10 + i*trf66e10
  WFhyp12 =~ a*trf92e12 + b*trf93e12 + c*trf104e12 + d*trf105e12 + e*trf100e12 + f*trf101e12 + g*trf102e12 + h*trf103e12 + i*trf66e12
  
  # Factor models for social isolation at 4 waves
  WFsi5 =~ j*trf11e5 + k*trf19e5 + l*trf24e5 + m*trf30e5 + n*trf34e5 + o*trf77e5 
  WFsi7 =~ j*trf11e7 + k*trf19e7 + l*trf24e7 + m*trf30e7 + n*trf34e7 + o*trf77e7 
  WFsi10 =~ j*trf11e10 + k*trf19e10 + l*trf24e10 + m*trf30e10 + n*trf34e10 + o*trf77e10 
  WFsi12 =~ j*trf11e12 + k*trf19e12 + l*trf24e12 + m*trf30e12 + n*trf34e12 + o*trf77e12
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFhyp7 + WFsi7 ~ WFhyp5 + WFsi5
  WFhyp10 + WFsi10 ~ WFhyp7 + WFsi7
  WFhyp12 + WFsi12 ~ WFhyp10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFhyp5 ~~ WFsi5
  WFhyp7 ~~ WFsi7
  WFhyp10 ~~ WFsi10 
  WFhyp12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIhyp1 + RIhyp2 + RIhyp3 + RIhyp4 + RIhyp5 + RIhyp6 + RIhyp7 + RIhyp8 + RIhyp9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFhyp5
'
```

```{r fit RICLPMt_multi_hyp_S2}
RICLPMt_multi_hyp_S2.fit <- cfa(RICLPMt_multi_hyp_S2, 
                           data = dat, 
                         #  se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

summary(RICLPMt_multi_hyp_S2.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S2 Model fit (without robust se):
(We have included here the change in CFI, TLI and RMSEA compared to the S1 model)
Comparative Fit Index (CFI)                    0.991 (>0.95)    Change in CFI:   0.001 (decrease) - worse fit 
Tucker-Lewis Index (TLI)                       0.990 (>0.95)    Change in TLI:   0.001 (decrease) - worse fit 
RMSEA                                          0.016 (≤ 0.06)   Change in RMSEA: 0.001 (increase) - worse fit
90 Percent confidence interval - lower         0.014 
90 Percent confidence interval - upper         0.017       
SRMR                                           0.060 (≤ 0.08)   Change in SRMR: 0.002 (increase)  - worse fit

Now we need to conduct a Likelihood ratio test to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. We use the compareFit command which gives the LRT with the comparison in model fit for the two models. 

```{r LRT for RICLPMt_multi_hyp_S1.fit and RICLPMt_multi_hyp_S2.fit}
lavTestLRT(RICLPMt_multi_hyp_S1.fit, RICLPMt_multi_hyp_S2.fit)
```

```{r compare fit RICLPMt_multi_hyp_S1 and RICLPMt_hyp_S2}
summary(semTools::compareFit(RICLPMt_multi_hyp_S1.fit, RICLPMt_multi_hyp_S2.fit, nested = TRUE)) #† indicates the best fitting model 
```

Significantly worse fit to include the restrictions, p<0.0001.

*The difference in model fit is still smaller than 0.01 - so we can assume that weak invariance holds - even though there is a significant chi square test.*

We will now go onto strong invariance testing. 

## RICLPMt_multi_hyp_S3

**Multiple response items RICLPMt mother report hyperactivity ADHD symptoms and social isolation: Step 3** 

If full or partial weak invariance is supported, the next step is to test for strong (scalar) invariance, or equivalence of item intercepts, for weak invariant items. Strong invariance means that mean differences in the latent construct capture all mean differences in the shared variance of the items. Strong invariance is tested by constraining the item intercepts to be equivalent in the two groups - with the restarint applied in the weak invariance model retained. *Any items that had unequal loadings in the weak invariance model (and were allowed to vary) should be allowed to vary in the strong invariance model because it is meaningless to test for equal item intercepts if the factor loadings of the items differs across groups* (Putnick and Bornstein, 2016). 

Fitting a model with constraints to ensure strong factorial invariance, with a random intercept for each indicator separately.

```{r specify RICLPMt_multi_hyp_S3}
RICLPMt_multi_hyp_S3 <- '
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) for each item of hyperactivity (teacher report)
  RIhyp1 =~ 1*trf92e5 + 1*trf92e7 + 1*trf92e10 + 1*trf92e12
  RIhyp2 =~ 1*trf93e5 + 1*trf93e7 + 1*trf93e10 + 1*trf93e12
  RIhyp3 =~ 1*trf104e5 + 1*trf104e7 + 1*trf104e10 + 1*trf104e12
  RIhyp4 =~ 1*trf105e5 + 1*trf105e7 + 1*trf105e10 + 1*trf105e12
  RIhyp5 =~ 1*trf100e5 + 1*trf100e7 + 1*trf100e10 + 1*trf100e12
  RIhyp6 =~ 1*trf101e5 + 1*trf101e7 + 1*trf101e10 + 1*trf101e12
  RIhyp7 =~ 1*trf102e5 + 1*trf102e7 + 1*trf102e10 + 1*trf102e12
  RIhyp8 =~ 1*trf103e5 + 1*trf103e7 + 1*trf103e10 + 1*trf103e12
  RIhyp9 =~ 1*trf66e5 + 1*trf66e7 + 1*trf66e10 + 1*trf66e12
  
  # Create between factors (random intercepts) for each item of social isolation (teacher report)
  RIsi1 =~ 1*trf11e5 + 1*trf11e7 + 1*trf11e10 + 1*trf11e12 
  RIsi2 =~ 1*trf19e5 + 1*trf19e7 + 1*trf19e10 + 1*trf19e12
  RIsi3 =~ 1*trf24e5 + 1*trf24e7 + 1*trf24e10 + 1*trf24e12
  RIsi4 =~ 1*trf30e5 + 1*trf30e7 + 1*trf30e10 + 1*trf30e12
  RIsi5 =~ 1*trf34e5 + 1*trf34e7 + 1*trf34e10 + 1*trf34e12
  RIsi6 =~ 1*trf77e5 + 1*trf77e7 + 1*trf77e10 + 1*trf77e12
  
  ##################################
  # WITHIN PART: MEASUREMENT MODEL #
  ##################################
  
  # Factor models for hyperactivity symptoms at 4 waves (constrained)
  WFhyp5 =~ a*trf92e5 + b*trf93e5 + c*trf104e5 + d*trf105e5 + e*trf100e5 + f*trf101e5 + g*trf102e5 + h*trf103e5 + i*trf66e5
  WFhyp7 =~ a*trf92e7 + b*trf93e7 + c*trf104e7 + d*trf105e7 + e*trf100e7 + f*trf101e7 + g*trf102e7 + h*trf103e7 + i*trf66e7
  WFhyp10 =~ a*trf92e10 + b*trf93e10 + c*trf104e10 + d*trf105e10 + e*trf100e10 + f*trf101e10 + g*trf102e10 + h*trf103e10 + i*trf66e10
  WFhyp12 =~ a*trf92e12 + b*trf93e12 + c*trf104e12 + d*trf105e12 + e*trf100e12 + f*trf101e12 + g*trf102e12 + h*trf103e12 + i*trf66e12
  
  # Factor models for social isolation at 4 waves (constrained)
  WFsi5 =~ j*trf11e5 + k*trf19e5 + l*trf24e5 + m*trf30e5 + n*trf34e5 + o*trf77e5 
  WFsi7 =~ j*trf11e7 + k*trf19e7 + l*trf24e7 + m*trf30e7 + n*trf34e7 + o*trf77e7 
  WFsi10 =~ j*trf11e10 + k*trf19e10 + l*trf24e10 + m*trf30e10 + n*trf34e10 + o*trf77e10 
  WFsi12 =~ j*trf11e12 + k*trf19e12 + l*trf24e12 + m*trf30e12 + n*trf34e12 + o*trf77e12
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  trf92e5 + trf92e7 + trf92e10 + trf92e12 ~ p*1
  trf93e5 + trf93e7 + trf93e10 + trf93e12 ~ q*1
  trf104e5 + trf104e7 + trf104e10 + trf104e12 ~ r*1
  trf105e5 + trf105e7 + trf105e10 + trf105e12 ~ s*1
  trf100e5 + trf100e7 + trf100e10 + trf100e12 ~ t*1
  trf101e5 + trf101e7 + trf101e10 + trf101e12 ~ u*1
  trf102e5 + trf102e7 + trf102e10 + trf102e12 ~ v*1
  trf103e5 + trf103e7 + trf103e10 + trf103e12 ~ w*1
  trf66e5 + trf66e7 + trf66e10 + trf66e12 ~ x*1
  
  trf11e5 + trf11e7 + trf11e10 + trf11e12 ~ y*1
  trf19e5 + trf19e7 + trf19e10 + trf19e12 ~ z*1
  trf24e5 + trf24e7 + trf24e10 + trf24e12 ~ aa*1
  trf30e5 + trf30e7 + trf30e10 + trf30e12 ~ ab*1
  trf34e5 + trf34e7 + trf34e10 + trf34e12 ~ ac*1
  trf77e5 + trf77e7 + trf77e10 + trf77e12 ~ ad*1
  
  # Free latent means from t = 2 onward (only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  WFhyp7 + WFhyp10 + WFhyp12 + WFsi7 + WFsi10 + WFsi12 ~ 1
  
  #########################
  # WITHIN PART: DYNAMICS #
  #########################
  
  # Specify the lagged effects between the within-person centered latent variables
  WFhyp7 + WFsi7 ~ WFhyp5 + WFsi5
  WFhyp10 + WFsi10 ~ WFhyp7 + WFsi7
  WFhyp12 + WFsi12 ~ WFhyp10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFhyp5 ~~ WFsi5
  WFhyp7 ~~ WFsi7
  WFhyp10 ~~ WFsi10 
  WFhyp12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Constrain covariance of the between factors and exogenous within factors to 0
  RIhyp1 + RIhyp2 + RIhyp3 + RIhyp4 + RIhyp5 + RIhyp6 + RIhyp7 + RIhyp8 + RIhyp9 + RIsi1 + RIsi2 + RIsi3 + RIsi4 + RIsi5 + RIsi6 ~~ 0*WFsi5 + 0*WFhyp5
'
```

```{r fit RICLPMt_multi_hyp_S3}
RICLPMt_multi_hyp_S3.fit <- cfa(RICLPMt_multi_hyp_S3, 
                           data = dat, 
                        #   se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

RICLPMt_multi_hyp_S3.fit.summary <- summary(RICLPMt_multi_hyp_S3.fit, 
                                            fit.measures = TRUE,
                                            standardized = TRUE)
```

S3 Model fit:
(We have included here the change in CFI, TLI and RMSEA compared to the S2 model)
Comparative Fit Index (CFI)                    0.991 (>0.95)    Change in CFI:   0.000 (increase) - same fit 
Tucker-Lewis Index (TLI)                       0.990 (>0.95)    Change in TLI:   0.000 (increase) - same fit 
RMSEA                                          0.016 (≤ 0.06)   Change in RMSEA: 0.000 (decrease) - same fit
90 Percent confidence interval - lower         0.014
90 Percent confidence interval - upper         0.017     
SRMR                                           0.060 (≤ 0.08)   Change in SRMR:  0.000 (increase)  - same fit 

Now we need to conduct a Likelihood ratio test to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. We use the compareFit command which gives the LRT with the comparison in model fit for the two models. 

```{r compare fit RICLPMt_multi_hyp_S2 and RICLPMt_hyp_S3}
# summary(semTools::compareFit(RICLPMt_multi_hyp_S2.fit, RICLPMt_multi_hyp_S3.fit, nested = TRUE)) #† indicates the best fitting model - hashed out to keep script running
```

Again this function does not run - perhaps there is something wrong with the way we are running the S3 code.

**But the model shows almost no change in model fit from S2 - so we assume strong measurement invariance.**

## RICLPMt_multi_hyp_S4: Hyperactivity step 4 - *Full model*

From Mulder and Hamaker (2021):
A significant chi-square difference test would mean strong factorial invariance does not hold, implying that the actual scores cannot be compared over time, but individual differences in scores can still be meaningfully compared since weak factorial invariance holds. As the focus in cross-lagged panel modeling is primarily on comparing individual differences (by decomposing the observed scores into between-unit and withinunit components) rather than mean scores over time, weak factorial invariance may be enough. However, from a measurement point of view, having strong factorial invariance would be considered more ideal.

Instead of including a random intercept at the observed level for each indicator separately (as done so far and in the upper part of the figure at the beginning of this document), we can also choose to specify the entire RI-CLPM at the latent level; this is illustrated in the lower part of the beginning figure. This can be done in either a model with weak or strong factorial invariance over time. To this end, we specify the common factors that capture both trait-like and state-like common variance, and thereby make the assumption that the trait- and state structures coincide. We then decompose these latent variables into a stable, between-unit part and the within-unit components.

We set the factor loadings of these second-order factors to be identical to the corresponding factor loadings of the withinunit factors. Additionally, we constrain the residual variances for the first-order factors to zero. This model is nested under the model we just presented (top panel of the figure), and is statistically equivalent to the model presented in the lower panel of the figure. This implies that we can use a chi-square difference test to compare. 

Multiple indicator RI-CLPM, 5 waves with 3 indicators for each variable at each wave (30 observed variables). Fitting a model with constraints to ensure strong factorial invariance, with the RI-CLPM at the latent level.

```{r specify RICLPMt_multi_hyp_S4}
RICLPMt_multi_hyp_S4 <- '
  
  #####################
  # MEASUREMENT MODEL #
  #####################
  
  # Factor models for hyperactivity symptoms at 4 waves (constrained)
  Fhyp5 =~ a*trf92e5 + b*trf93e5 + c*trf104e5 + d*trf105e5 + e*trf100e5 + f*trf101e5 + g*trf102e5 + h*trf103e5 + i*trf66e5
  Fhyp7 =~ a*trf92e7 + b*trf93e7 + c*trf104e7 + d*trf105e7 + e*trf100e7 + f*trf101e7 + g*trf102e7 + h*trf103e7 + i*trf66e7
  Fhyp10 =~ a*trf92e10 + b*trf93e10 + c*trf104e10 + d*trf105e10 + e*trf100e10 + f*trf101e10 + g*trf102e10 + h*trf103e10 + i*trf66e10
  Fhyp12 =~ a*trf92e12 + b*trf93e12 + c*trf104e12 + d*trf105e12 + e*trf100e12 + f*trf101e12 + g*trf102e12 + h*trf103e12 + i*trf66e12
  
  # Factor models for social isolation at 4 waves (constrained)
  Fsi5 =~ j*trf11e5 + k*trf19e5 + l*trf24e5 + m*trf30e5 + n*trf34e5 + o*trf77e5 
  Fsi7 =~ j*trf11e7 + k*trf19e7 + l*trf24e7 + m*trf30e7 + n*trf34e7 + o*trf77e7 
  Fsi10 =~ j*trf11e10 + k*trf19e10 + l*trf24e10 + m*trf30e10 + n*trf34e10 + o*trf77e10 
  Fsi12 =~ j*trf11e12 + k*trf19e12 + l*trf24e12 + m*trf30e12 + n*trf34e12 + o*trf77e12
  
  # Constrained intercepts over time (this is necessary for strong factorial invariance; without these contraints we have week factorial invariance). 
  trf92e5 + trf92e7 + trf92e10 + trf92e12 ~ p*1
  trf93e5 + trf93e7 + trf93e10 + trf93e12 ~ q*1
  trf104e5 + trf104e7 + trf104e10 + trf104e12 ~ r*1
  trf105e5 + trf105e7 + trf105e10 + trf105e12 ~ s*1
  trf100e5 + trf100e7 + trf100e10 + trf100e12 ~ t*1
  trf101e5 + trf101e7 + trf101e10 + trf101e12 ~ u*1
  trf102e5 + trf102e7 + trf102e10 + trf102e12 ~ v*1
  trf103e5 + trf103e7 + trf103e10 + trf103e12 ~ w*1
  trf66e5 + trf66e7 + trf66e10 + trf66e12 ~ x*1
  
  trf11e5 + trf11e7 + trf11e10 + trf11e12 ~ y*1
  trf19e5 + trf19e7 + trf19e10 + trf19e12 ~ z*1
  trf24e5 + trf24e7 + trf24e10 + trf24e12 ~ aa*1
  trf30e5 + trf30e7 + trf30e10 + trf30e12 ~ ab*1
  trf34e5 + trf34e7 + trf34e10 + trf34e12 ~ ac*1
  trf77e5 + trf77e7 + trf77e10 + trf77e12 ~ ad*1
  
  # Free latent means from t = 2 onward (only do this in combination with the constraints on the intercepts; without these, this would not be specified).
  Fhyp7 + Fhyp10 + Fhyp12 + Fsi7 + Fsi10 + Fsi12 ~ 1
  
  ################
  # BETWEEN PART #
  ################
  
  # Create between factors (random intercepts) 
  RIhyp =~ 1*Fhyp5 + 1*Fhyp7 + 1*Fhyp10 + 1*Fhyp12
  RIsi =~ 1*Fsi5 + 1*Fsi7 + 1*Fsi10 + 1*Fsi12
  
  # Set the residual variances of all Fhyp and Fsi variables to 0. 
  Fhyp5 ~~ 0*Fhyp5
  Fhyp7 ~~ 0*Fhyp7
  Fhyp10 ~~ 0*Fhyp10
  Fhyp12 ~~ 0*Fhyp12
  Fsi5 ~~ 0*Fsi5
  Fsi7 ~~ 0*Fsi7
  Fsi10 ~~ 0*Fsi10
  Fsi12 ~~ 0*Fsi12
  
  ###############
  # WITHIN PART #
  ###############
  
  # Create the within-part
  WFhyp5 =~ 1*Fhyp5
  WFhyp7 =~ 1*Fhyp7
  WFhyp10 =~ 1*Fhyp10
  WFhyp12 =~ 1*Fhyp12
  
  WFsi5 =~ 1*Fsi5
  WFsi7 =~ 1*Fsi7
  WFsi10 =~ 1*Fsi10
  WFsi12 =~ 1*Fsi12
  
  # Specify the lagged effects between the within-person centered latent variables
  WFhyp7 + WFsi7 ~ WFhyp5 + WFsi5
  WFhyp10 + WFsi10 ~ WFhyp7 + WFsi7
  WFhyp12 + WFsi12 ~ WFhyp10 + WFsi10
  
  # Estimate the correlations within the same wave
  WFhyp5 ~~ WFsi5
  WFhyp7 ~~ WFsi7
  WFhyp10 ~~ WFsi10 
  WFhyp12 ~~ WFsi12
  
  ##########################
  # ADDITIONAL CONSTRAINTS #
  ##########################
  
  # Set correlations between the between-factors (random intercepts) and within-factors at wave 1 (age 5) at 0
  RIhyp + RIsi ~~ 0*WFhyp5 + 0*WFsi5
'
```

```{r fit RICLPMt_multi_hyp_S4}
RICLPMt_multi_hyp_S4.fit <- cfa(RICLPMt_multi_hyp_S4, 
                           data = dat, 
                         #  se = "robust",
                           ordered = TRUE,
                           missing = 'pairwise'
                           )

summary(RICLPMt_multi_hyp_S4.fit, 
        fit.measures = TRUE,
        standardized = TRUE)
```

S4 Model fit:
(We have included here the change in CFI, TLI and RMSEA compared to the S3 model)
Comparative Fit Index (CFI)                    0.956 (>0.95)    Change in CFI:   0. (decrease) - worse fit 
Tucker-Lewis Index (TLI)                       0.955 (>0.95)    Change in TLI:   0. (decrease) - worse fit 
RMSEA                                          0. (≤ 0.06)   Change in RMSEA: 0. (increase) - worse fit
90 Percent confidence interval - lower         0. 
90 Percent confidence interval - upper         0.       
SRMR                                           0. (≤ 0.08)   Change in SRMR: 0. (increase)  - worse fit 

Now we need to conduct a Likelihood ratio test to see if the constrained model is a significantly worse fit than the free loading model. By constraining the factor loadings over time we can assume that the items load onto the same construct in the same way at each time point. We use the compareFit command which gives the LRT with the comparison in model fit for the two models. 

```{r compare fit RICLPMt_multi_hyp_S3 and RICLPMt_hyp_inat_S4}
summary(semTools::compareFit(RICLPMt_multi_hyp_S3.fit, RICLPMt_multi_hyp_S4.fit, nested = TRUE)) #† indicates the best fitting model
```

**As all fit indices changed by more than 0.01 - we cannot accept this measurement model.**

***

So if the S3 model is the way to go here - then I need to figure out how to interpret this 

***
NOW NEED TO EXPORT THE TABLES OF THE MODEL THAT WE'VE CHOSEN 
```{r tables for inattention ADHD S3}
# Table of model fit 
RICLPMt_multi_hyp_S3.fit.summary.fit <- as.data.frame(t(as.data.frame(RICLPMt_multi_hyp_S3.fit.summary$FIT)))[,c(6,7,19,20,27,28,29,35)]

# Table of regression coefficients and covariances 
RICLPMt_multi_hyp_S3.fit.summary.reg <- as.tibble(RICLPMt_multi_hyp_S3.fit.summary$PE[c(187:202),-c(4,5)])
```














