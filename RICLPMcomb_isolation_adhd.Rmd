---
title: "Random intercept cross lagged panel models for social isolation and ADHD symptoms in childhood (combined parent and teacher report)"
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: hide
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'asis')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(lavaan)
library(ChiBarSq.DiffTest)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path, include=FALSE}
#source raw data directory: data_raw and data included
source("../isolation_ADHD_data_path.R")
```

```{r read in dta data file}
dat.raw <- read_dta(paste0(data.raw_path, "Katie_19Jan22.dta"))

dat <- dat.raw %>%
  dplyr::select(id = atwinid,
         sampsex,
         seswq35,
         sisoem5,  # social isolation mother report
         sisoem7,
         sisoem10,
         sisoem12,
         sisoet5,  # social isolation teacher report
         sisoet7, 
         sisoet10,
         sisoet12,
         tadhdem5,  # total ADHD mother report
         tadhdem7,
         tadhdem10,
         tadhdem12,
         tadhdet5,  # total ADHD teacher report
         tadhdet7,
         tadhdet10,
         tadhdet12,
         hyem5,     # hyperactivity ADHD mother report
         hyem7,
         hyem10,
         hyem12, 
         hyet5,     # hyperactivity ADHD teacher report
         hyet7,
         hyet10,
         hyet12,
         inem5,    # inattention ADHD mother report
         inem7,
         inem10,
         inem12,
         inet5,    # inattention ADHD teacher report
         inet7,
         inet10,
         inet12,
         sisoe5,
         sisoe7,
         sisoe10,
         sisoe12
  )

colnames(dat)
```

***

# Functions

```{r functions}
# Table of model fit 
table.model.fit <- function(model){
  model.fit <- as.data.frame(t(as.data.frame(model$FIT))) %>%
    dplyr::select(chisq, df, chisq.scaled, cfi.robust, tli.robust, aic, bic, bic2, rmsea.robust, rmsea.ci.lower.robust, rmsea.ci.upper.robust, srmr) #can only be used with "MLR" estimator
  return(model.fit)
}

# Table of regression and correlation (standardised covariance) coefficients
table.model.coef <- function(model, type, constraints){
  if (type == "RICLPM" & constraints == "No"){
    model.coef <- as.tibble(model$PE[c(17:32),]) %>% dplyr::select(-exo, -std.lv, -std.nox)
    return(model.coef)
  } else if(type == "RICLPM" & constraints == "Yes"){
    model.coef <- as.tibble(model$PE[c(17:32),]) %>% dplyr::select(-exo, -label, -std.lv, -std.nox)
    return(model.coef)
  } else if(type == "CLPM" & constraints == "No"){
    model.coef <- as.tibble(model$PE[c(1:16),]) %>% dplyr::select(-exo, -std.lv, -std.nox)
    return(model.coef)
  } else if(type == "CLPM" & constraints == "Yes"){
    model.coef <- as.tibble(model$PE[c(1:16),]) %>% dplyr::select(-exo, -std.lv, -std.nox)
    return(model.coef)
  } else {model.coef <- NULL}
}
```

*** 

# Create combined ADHD variables

```{r create combined total adhd variables}
# age 5
dat <- dat %>%
  mutate(tadhde5 = 
           case_when(
             is.na(tadhdem5) & is.na(tadhdet5) ~ NA_real_,
             is.na(tadhdem5) & !is.na(tadhdet5) ~ as.numeric(tadhdet5),
             is.na(tadhdet5) & !is.na(tadhdem5) ~ as.numeric(tadhdem5),
             !is.na(tadhdem5) & !is.na(tadhdet5) ~ as.numeric(rowMeans(across(.cols = c(tadhdem5,tadhdet5)))))
  )
# age 7
dat <- dat %>%
  mutate(tadhde7 = 
           case_when(
             is.na(tadhdem7) & is.na(tadhdet7) ~ NA_real_,
             is.na(tadhdem7) & !is.na(tadhdet7) ~ as.numeric(tadhdet7),
             is.na(tadhdet7) & !is.na(tadhdem7) ~ as.numeric(tadhdem7),
             !is.na(tadhdem7) & !is.na(tadhdet7) ~ as.numeric(rowMeans(across(.cols = c(tadhdem7,tadhdet7)))))
  )
# age 10
dat <- dat %>%
  mutate(tadhde10 = 
           case_when(
             is.na(tadhdem10) & is.na(tadhdet10) ~ NA_real_,
             is.na(tadhdem10) & !is.na(tadhdet10) ~ as.numeric(tadhdet10),
             is.na(tadhdet10) & !is.na(tadhdem10) ~ as.numeric(tadhdem10),
             !is.na(tadhdem10) & !is.na(tadhdet10) ~ as.numeric(rowMeans(across(.cols = c(tadhdem10,tadhdet10)))))
  )
# age 12
dat <- dat %>%
  mutate(tadhde12 = 
           case_when(
             is.na(tadhdem12) & is.na(tadhdet12) ~ NA_real_,
             is.na(tadhdem12) & !is.na(tadhdet12) ~ as.numeric(tadhdet12),
             is.na(tadhdet12) & !is.na(tadhdem12) ~ as.numeric(tadhdem12),
             !is.na(tadhdem12) & !is.na(tadhdet12) ~ as.numeric(rowMeans(across(.cols = c(tadhdem12,tadhdet12)))))
  )
```

```{r create combined hyperactivity adhd variables}
# age 5
dat <- dat %>%
  mutate(hye5 = 
           case_when(
             is.na(hyem5) & is.na(hyet5) ~ NA_real_,
             is.na(hyem5) & !is.na(hyet5) ~ as.numeric(hyet5),
             is.na(hyet5) & !is.na(hyem5) ~ as.numeric(hyem5),
             !is.na(hyem5) & !is.na(hyet5) ~ as.numeric(rowMeans(across(.cols = c(hyem5,hyet5)))))
  )
# age 7
dat <- dat %>%
  mutate(hye7 = 
           case_when(
             is.na(hyem7) & is.na(hyet7) ~ NA_real_,
             is.na(hyem7) & !is.na(hyet7) ~ as.numeric(hyet7),
             is.na(hyet7) & !is.na(hyem7) ~ as.numeric(hyem7),
             !is.na(hyem7) & !is.na(hyet7) ~ as.numeric(rowMeans(across(.cols = c(hyem7,hyet7)))))
  )
# age 10
dat <- dat %>%
  mutate(hye10 = 
           case_when(
             is.na(hyem10) & is.na(hyet10) ~ NA_real_,
             is.na(hyem10) & !is.na(hyet10) ~ as.numeric(hyet10),
             is.na(hyet10) & !is.na(hyem10) ~ as.numeric(hyem10),
             !is.na(hyem10) & !is.na(hyet10) ~ as.numeric(rowMeans(across(.cols = c(hyem10,hyet10)))))
  )
# age 12
dat <- dat %>%
  mutate(hye12 = 
           case_when(
             is.na(hyem12) & is.na(hyet12) ~ NA_real_,
             is.na(hyem12) & !is.na(hyet12) ~ as.numeric(hyet12),
             is.na(hyet12) & !is.na(hyem12) ~ as.numeric(hyem12),
             !is.na(hyem12) & !is.na(hyet12) ~ as.numeric(rowMeans(across(.cols = c(hyem12,hyet12)))))
  )
```

```{r create combined inattention adhd variables}
# age 5
dat <- dat %>%
  mutate(ine5 = 
           case_when(
             is.na(inem5) & is.na(inet5) ~ NA_real_,
             is.na(inem5) & !is.na(inet5) ~ as.numeric(inet5),
             is.na(inet5) & !is.na(inem5) ~ as.numeric(inem5),
             !is.na(inem5) & !is.na(inet5) ~ as.numeric(rowMeans(across(.cols = c(inem5,inet5)))))
  )
# age 7
dat <- dat %>%
  mutate(ine7 = 
           case_when(
             is.na(inem7) & is.na(inet7) ~ NA_real_,
             is.na(inem7) & !is.na(inet7) ~ as.numeric(inet7),
             is.na(inet7) & !is.na(inem7) ~ as.numeric(inem7),
             !is.na(inem7) & !is.na(inet7) ~ as.numeric(rowMeans(across(.cols = c(inem7,inet7)))))
  )
# age 10
dat <- dat %>%
  mutate(ine10 = 
           case_when(
             is.na(inem10) & is.na(inet10) ~ NA_real_,
             is.na(inem10) & !is.na(inet10) ~ as.numeric(inet10),
             is.na(inet10) & !is.na(inem10) ~ as.numeric(inem10),
             !is.na(inem10) & !is.na(inet10) ~ as.numeric(rowMeans(across(.cols = c(inem10,inet10)))))
  )
# age 12
dat <- dat %>%
  mutate(ine12 = 
           case_when(
             is.na(inem12) & is.na(inet12) ~ NA_real_,
             is.na(inem12) & !is.na(inet12) ~ as.numeric(inet12),
             is.na(inet12) & !is.na(inem12) ~ as.numeric(inem12),
             !is.na(inem12) & !is.na(inet12) ~ as.numeric(rowMeans(across(.cols = c(inem12,inet12)))))
  )
```

***

The below introductory notes have been adapted from [Hamaker, Kuiper, and Grasman, 2015](https://www.researchgate.net/profile/Ellen-Hamaker/publication/274262847_A_Critique_of_the_Cross-Lagged_Panel_Model/links/5b80154c92851c1e122f351f/A-Critique-of-the-Cross-Lagged-Panel-Model.pdf)

The CLPM only accounts for temporal stability through the inclusion of autoregressive parameters. Thus, it is implicitly assumed that every person varies over time around the same means μt and πt, and that there are no trait-like individual differences that endure. this is a rather problematic assumption, as it is difficult to imagine a psychological construct – whether behavioral, cognitive, emotional or psychophysiological – that is not to some extent characterized by stable individual differences (if not for the entire lifespan, then at least for the duration of the study; Hamaker, ). Longitudinal data can actually be thought of as multilevel data, in which occasions are nested within individuals (or other systems, like dyads). When considering this perspective, it becomes clear that we need to separate the *within-person* level from the *between-person* level. 

The random intercepts cross lagged panel model (RI-CLPM) accounts not only for temporal stability, but also for time-invariant, trait-like stability through the inclusion of a random intercept. The cross-lagged parameters indicate the extent to which the two variables influence each other. The cross-lagged relationships pertain to a process that takes place at the within-person level and they are therefore of key interest when the interest is in *reciprocal influences over time within individuals or dyads*. The cross-lagged parameter indicates the extent to which the change in y can be predicted from the individual’s prior deviation from their expected score on the other variable, while controlling for the structural change in y and the prior deviation from one’s expected score on y. 

The CLPM requires only two waves of data, but the RI-CLPM requires at least *three waves* of data, in which case there is 1 degree of freedom (df). If the intervals are of the same size, and if we assume that the effects the variables have on each other remain stable over time, we could decide to constrain the lagged parameters over time, giving us an additional 4 df (i.e., 5 df in total).  If we are not willing to make these assumptions, and we are not sure whether the effect of the time-invariant stability components κi and ωi are equal over time, we may wish to remove the constraint on the factor loadings. This relaxation may especially be of interest when the observations are made further apart in time, and we expect that we are also measuring some structural changes. However, this would imply that κi and ωi no longer represents random intercepts (as in multilevel modeling), but rather represent latent variables or traits (as common in SEM). Even more so, it would imply we need more waves of data to estimate this model. **The gaps in our time waves may be a problem here.**

# Correlations between all variables

```{r create data frame for correlation matrix}
# items 
items <- c("tadhde5",
           "sisoe5",
           "tadhde7",
           "sisoe7",
           "tadhde10",
           "sisoe10",
           "tadhde12",
           "sisoe12")

# create data frame
items.df <- as.data.frame(dat[,items])
is.data.frame(items.df)  #check 

colnames(items.df) <- c("ADHD age 5",
                        "Social isolation age 5",
                        "ADHD age 7",
                        "Social isolation age 7",
                        "ADHD age 10",
                        "Social isolation age 10",
                        "ADHD age 12",
                        "Social isolation age 12")
```

```{r correlation matrix for factor scores and sum scores}
item.cor.matrix <- cor(items.df, 
                       method = "pearson", 
                       use = "pairwise.complete.obs")
as.data.frame(item.cor.matrix) %>% mutate_if(is.numeric, round, 2)

# check they are all signficant
item.cor.matrix.sig <- Hmisc::rcorr(as.matrix(items.df),
                                    type = "spearman")
item.cor.matrix.sig$P
```


# All RI-CLPM models in this script 

| Model               | Description                                                                                                                       | 
| ------------------- | --------------------------------------------------------------------------------------------------------------------------------  |
|   CLPMcomb          |  Cross-lagged panel model without random intercepts using **combined mother and teacher report** and **total ADHD** scores        |
|   RICLPMcomb        |  Basic RI-CLPM model using **combined mother and teacher report** ratings for AD and SI, and **total ADHD** scores                |
|   RICLPMcomb2       |  RICLPMcomb but with fixed autoregressive and cross-lagged relations over time                                                    |
|   RICLPMcomb3       |  RICLPMcomb but with constrained grand means for AD and SI                                                                        |
|   RICLPMcomb_hyp    |  Basic RI-CLPM model using **combined mother and teacher report** ratings for AD and SI, and **hyperactivity** scores             |
|   RICLPMcomb_hyp2   |  RICLPMcomb_hyp but with fixed autoregressive and cross-lagged relations over time                                                |
|   RICLPMcomb_hyp3   |  RICLPMcomb_hyp but with constrained grand means for AD and SI                                                                    |
|   RICLPMcomb_inat   |  Basic RI-CLPM model using **combined mother and teacher report** ratings for AD and SI, and **inattention** scores               |
|   RICLPMcomb_inat2  |  RICLPMcomb_inat but with fixed autoregressive and cross-lagged relations over time                                               |
|   RICLPMcomb_inat3  |  RICLPMcomb_inat but with constrained grand means for AD and SI                                                                   |
|   CLPMadt           |  Cross-lagged panel model without random intercepts using **teacher report** and **total ADHD** scores                            |
|   RICLPMadt         |  Basic RI-CLPM model using **teacher report ADHD and combined report isolation**, and **total ADHD** scores                       |
|   RICLPMadt2        |  RICLPMadt but with fixed autoregressive and cross-lagged relations over time                                                     |
|   RICLPMadt3        |  RICLPMadt but with constrained grand means for AD and SI                                                                         |
|   RICLPMadt_hyp     |  Basic RI-CLPM model using **teacher report ADHD and combined report isolation**, and **hyperactivity** scores                    |
|   RICLPMadt_hyp2    |  RICLPMadt_hyp but with fixed autoregressive and cross-lagged relations over time                                                 |
|   RICLPMadt_hyp3    |  RICLPMadt_hyp but with constrained grand means for AD and SI                                                                     |
|   RICLPMadt_inat    |  Basic RI-CLPM model using **teacher report ADHD and combined report isolation**, and **inattention** scores                      |
|   RICLPMadt_inat2   |  RICLPMadt_inat but with fixed autoregressive and cross-lagged relations over time                                                |
|   RICLPMadt_inat3   |  RICLPMadt_inat but with constrained grand means for AD and SI                                                                    |
|   CLPMadm           |  Cross-lagged panel model without random intercepts using **mother report** and **total ADHD** scores                            |
|   RICLPMadm         |  Basic RI-CLPM model using **mother report ADHD and combined report isolation**, and **total ADHD** scores                       |
|   RICLPMadm2        |  RICLPMadm but with fixed autoregressive and cross-lagged relations over time                                                     |
|   RICLPMadm3        |  RICLPMadm but with constrained grand means for AD and SI                                                                         |
|   RICLPMadm_hyp     |  Basic RI-CLPM model using **mother report ADHD and combined report isolation**, and **hyperactivity** scores                    |
|   RICLPMadm_hyp2    |  RICLPMadm_hyp but with fixed autoregressive and cross-lagged relations over time                                                 |
|   RICLPMadm_hyp3    |  RICLPMadm_hyp but with constrained grand means for AD and SI                                                                     |
|   RICLPMadm_inat    |  Basic RI-CLPM model using **mother report ADHD and combined report isolation**, and **inattention** scores                      |
|   RICLPMadm_inat2   |  RICLPMadm_inat but with fixed autoregressive and cross-lagged relations over time                                                |
|   RICLPMadm_inat3   |  RICLPMadm_inat but with constrained grand means for AD and SI                                                                    |


# RI-CLPM: Combined mother and teacher report, total ADHD symptoms

For SEM in [lavaan](https://lavaan.ugent.be/index.html), we use three different formula types: latent variabele definitions (using the `=~` operator, which can be read as is "measured by"), regression formulas (using the `~` operator), and (co)variance formulas (using the `~~` operator). The regression formulas are similar to ordinary formulas in R. The expression `y1 ~~ y2` allows the residual variances of the two observed variables to be correlated. This is sometimes done if it is believed that the two variables have something in common that is not captured by the latent variables. Note that the two expressions `y2 ~~ y4` and `y2 ~~ y6`, can be combined into the expression `y2 ~~ y4 + y6`, because the variable on the left of the `~~` operator (y2) is the same. This is just a shorthand notation. In general, to fix a parameter in a lavaan formula, you need to pre-multiply the corresponding variable in the formula by a numerical value. This is called the pre-multiplication mechanism and will be used for many purposes e.g. `1*x2`. If you wish to fix the correlation (or covariance) between a pair of latent variables to zero, you need to explicity add a covariance-formula for this pair, and fix the parameter to zero.

To specify the RI-CLPM we need four parts: notes from [Mulder's webpage](https://jeroendmulder.github.io/RI-CLPM/lavaan.html).

* A between part, consisting of the random intercepts. It is specified using the =~ command, `RIx =~ 1*x1 1*x2 ...`, where 1* fixes the factor loading to one.

* A within part, consisting of within-unit fluctuations. It is also specified using the =~ command, `wx1 =~ 1*x1; wx2 =~ 1*x2;`

* The lagged regressions between the within-unit components, using `wx2 ~ wx1 wy1; wx3 ~ wx2 wy2; ...`. Here, this is written with two variables on the left hand side of the `~`, this is doing the same thing as calculating just regression paths - but combining DVs that have the same paths leading to them, e.g. `wx2 ~ wx1 + wy1` and `wy2 ~ wx1 + wy1` becomes `wx2+ wy2 ~ wx1 + wy1`. 

* Relevant covariances in both the between and within part. In the within part the components at wave 1, and their residuals at waves 2 and further are correlated within each wave, using `wx1 ~~ wy1; wx2 ~~ wy2;...`. We also need to specify their (residual) variances here using `wx1 ~~ wx1; wx2 ~~ wx2; ...`. For the between part we have to specify the variances and covariance of the random intercepts using `RIx ~~ RIy;`.

Tips for interpreting the output:
- Model Test User Model: which provides a test statistic, degrees of freedom, and a p-value for the model that was specified by the user.
- Model Test Baseline Model: The baseline is a null model, typically in which all of your observed variables are constrained to covary with no other variables (put another way, the covariances are fixed to 0)--just individual variances are estimated.

## Cross-lagged panel model (CLPMcomb)

```{r specify CLPMcomb}
CLPMcomb <- '
  # Estimate the lagged effects between the observed variables.
  tadhde7 + sisoe7 ~ tadhde5 + sisoe5
  tadhde10 + sisoe10 ~ tadhde7 + sisoe7
  tadhde12 + sisoe12 ~ tadhde10 + sisoe10

  # Estimate the covariance between the observed variables at the first wave. 
  tadhde5 ~~ sisoe5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  tadhde7 ~~ sisoe7
  tadhde10 ~~ sisoe10
  tadhde12 ~~ sisoe12
  
  # Estimate the (residual) variance of the observed variables.
  tadhde5 ~~ tadhde5 # Variances
  sisoe5 ~~ sisoe5 
  tadhde7 ~~ tadhde7 # Residual variances
  sisoe7 ~~ sisoe7 
  tadhde10 ~~ tadhde10 
  sisoe10 ~~ sisoe10 
  tadhde12 ~~ tadhde12 
  sisoe12 ~~ sisoe12 
'
```

```{r fit CLPMcomb}
CLPMcomb.fit <- lavaan(CLPMcomb, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMcomb.fit.summary <- summary(CLPMcomb.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMcomb.fit.summary.fit <- table.model.fit(CLPMcomb.fit.summary)
CLPMcomb.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMcomb.fit.summary.reg <- table.model.coef(model = CLPMcomb.fit.summary, type = "CLPM", constraints = "No")
CLPMcomb.fit.summary.reg


CLPMcomb.fit.summary.reg %>% 
  select(lhs, op, rhs, std.all, pvalue) %>%
  mutate_if(is.numeric, round, 3)

CLPMcomb.fit.summary.fit %>%
  select(-aic, -bic, -chisq ) %>%
  mutate_if(is.numeric, round, 2)
```

## Constrained cross-lagged panel model (CLPMcomb)

```{r specify CLPMcomb}
CLPMcomb2 <- '
  # Estimate the lagged effects between the observed variables - constrained
  tadhde7 ~ tadhde5 + d*sisoe5 
  sisoe7 ~ c*tadhde5 + sisoe5
  
  tadhde10 ~ tadhde7 + d*sisoe7
  sisoe10 ~ c*tadhde7 + sisoe7
  
  tadhde12 ~ tadhde10 + d*sisoe10
  sisoe12 ~ c*tadhde10 + sisoe10

  # Estimate the covariance between the observed variables at the first wave. 
  tadhde5 ~~ sisoe5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  tadhde7 ~~ sisoe7
  tadhde10 ~~ sisoe10
  tadhde12 ~~ sisoe12
  
  # Estimate the (residual) variance of the observed variables.
  tadhde5 ~~ tadhde5 # Variances
  sisoe5 ~~ sisoe5 
  tadhde7 ~~ tadhde7 # Residual variances
  sisoe7 ~~ sisoe7 
  tadhde10 ~~ tadhde10 
  sisoe10 ~~ sisoe10 
  tadhde12 ~~ tadhde12 
  sisoe12 ~~ sisoe12 
'
```

```{r fit CLPMcomb2}
CLPMcomb2.fit <- lavaan(CLPMcomb2, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMcomb2.fit.summary <- summary(CLPMcomb2.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMcomb2.fit.summary.fit <- table.model.fit(CLPMcomb2.fit.summary)
CLPMcomb2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMcomb2.fit.summary.reg <- table.model.coef(model = CLPMcomb2.fit.summary, type = "CLPM", constraints = "Yes")
CLPMcomb2.fit.summary.reg


CLPMcomb2.fit.summary.reg %>% 
  select(lhs, op, rhs, std.all, pvalue) %>%
  mutate_if(is.numeric, round, 2)

CLPMcomb2.fit.summary.fit %>%
  select(-aic, -bic, -chisq ) %>%
  mutate_if(is.numeric, round, 2)
```

```{r LRT for RICLPMcomb and RICLPMcomb2}
lavTestLRT(CLPMcomb.fit, CLPMcomb2.fit, method = "satorra.bentler.2010")
```


## The basic RI-CLPM model (RICLPMcomb)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMcomb, class.source = 'fold-show'}
RICLPMcomb <- '
  # Create between components (rando intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb}
RICLPMcomb.fit <- lavaan(RICLPMcomb,               # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMcomb.fit.summary <- summary(RICLPMcomb.fit, 
                              fit.measures = TRUE,
                              standardized = TRUE)

#Table of model fit 
RICLPMcomb.fit.summary.fit <- table.model.fit(RICLPMcomb.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMcomb.fit.summary.reg <- table.model.coef(model = RICLPMcomb.fit.summary, type = "RICLPM", constraints = "No")
```

#### Constraining all lag and crosslag parameters at once (RICLPMcomb2)

```{r specify RICLPMcomb2}
RICLPMcomb2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb2}
RICLPMcomb2.fit <- lavaan(RICLPMcomb2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb and RICLPMcomb2}
lavTestLRT(RICLPMcomb.fit, RICLPMcomb2.fit, method = "satorra.bentler.2010")
```

RICLPMcomb2 is significantly *worse* fit compared to RICLPMcomb according to the Chi square test.

#### Constraining lag in ADHD parameter (RICLPMcomb2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMcomb2a}
RICLPMcomb2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb2a}
RICLPMcomb2a.fit <- lavaan(RICLPMcomb2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb and RICLPMcomb2a}
lavTestLRT(RICLPMcomb.fit, RICLPMcomb2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMcomb2b)

```{r specify RICLPMcomb2b}
RICLPMcomb2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb2b}
RICLPMcomb2b.fit <- lavaan(RICLPMcomb2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb and RICLPMcomb2b}
lavTestLRT(RICLPMcomb.fit, RICLPMcomb2b.fit, method = "satorra.bentler.2010")
```
RICLPMcomb2b is significantly *worse* fit compared to RICLPMcomb. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMcomb2c)

```{r specify RICLPMcomb2c}
RICLPMcomb2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb2c}
RICLPMcomb2c.fit <- lavaan(RICLPMcomb2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb and RICLPMcomb2c}
lavTestLRT(RICLPMcomb.fit, RICLPMcomb2c.fit, method = "satorra.bentler.2010")
```

RICLPMcomb2c is *NOT* significantly worse fit compared to RICLPMcomb (p = 0.7833). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMcomb2d) - **compared to RICLPMcomb2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMcomb2d}
RICLPMcomb2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb2d}
RICLPMcomb2d.fit <- lavaan(RICLPMcomb2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMcomb2d.fit.summary <- summary(RICLPMcomb2d.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)

#Table of model fit 
RICLPMcomb2d.fit.summary.fit <- table.model.fit(RICLPMcomb2d.fit.summary)
RICLPMcomb2d.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMcomb2d.fit.summary.reg <- table.model.coef(model = RICLPMcomb2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMcomb2d.fit.summary.reg %>% select(lhs, op, rhs, std.all, pvalue)  %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMcomb2c and RICLPMcomb2d}
lavTestLRT(RICLPMcomb2c.fit, RICLPMcomb2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMcomb2d is *NOT* significantly worse fit compared to RICLPMcomb2c (p = 0.4947). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMcomb2d where cross-lags are constrained to be equal across time.**

***

### Constrained grand means (RICLPMcomb3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMcomb3}
RICLPMcomb3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  tadhde5 + tadhde7 + tadhde10 + tadhde12 ~ mad*1
  sisoe5 + sisoe7 + sisoe10 + sisoe12 ~ msi*1
'
```

```{r fit RICLPMcomb3}
RICLPMcomb3.fit <- lavaan(RICLPMcomb3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb and RICLPMcomb3}
lavTestLRT(RICLPMcomb.fit, RICLPMcomb3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Combined mother and teacher report, Hyperactive/Impulsive ADHD symptoms

## Cross-lagged panel model (CLPMcomb_hyp)

```{r specify CLPMcomb_hyp}
CLPMcomb_hyp <- '
  # Estimate the lagged effects between the observed variables.
  hye7 + sisoe7 ~ hye5 + sisoe5
  hye10 + sisoe10 ~ hye7 + sisoe7
  hye12 + sisoe12 ~ hye10 + sisoe10

  # Estimate the covariance between the observed variables at the first wave. 
  hye5 ~~ sisoe5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  hye7 ~~ sisoe7
  hye10 ~~ sisoe10
  hye12 ~~ sisoe12
  
  # Estimate the (residual) variance of the observed variables.
  hye5 ~~ hye5 # Variances
  sisoe5 ~~ sisoe5 
  hye7 ~~ hye7 # Residual variances
  sisoe7 ~~ sisoe7 
  hye10 ~~ hye10 
  sisoe10 ~~ sisoe10 
  hye12 ~~ hye12 
  sisoe12 ~~ sisoe12 
'
```

```{r fit CLPMcomb_hyp}
CLPMcomb_hyp.fit <- lavaan(CLPMcomb_hyp, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMcomb_hyp.fit.summary <- summary(CLPMcomb_hyp.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMcomb_hyp.fit.summary.fit <- table.model.fit(CLPMcomb_hyp.fit.summary)
CLPMcomb_hyp.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMcomb_hyp.fit.summary.reg <- table.model.coef(model = CLPMcomb_hyp.fit.summary, type = "CLPM", constraints = "No")
CLPMcomb_hyp.fit.summary.reg

CLPMcomb_hyp.fit.summary.fit %>%
  select(-aic, -bic, -chisq ) %>%
  mutate_if(is.numeric, round, 2)
```

## Constrained cross-lagged panel model (CLPMcomb_hyp)

```{r specify CLPMcomb_hyp}
CLPMcomb_hyp2 <- '
  # Estimate the lagged effects between the observed variables - constrained
  hye7 ~ hye5 + d*sisoe5 
  sisoe7 ~ c*hye5 + sisoe5
  
  hye10 ~ hye7 + d*sisoe7
  sisoe10 ~ c*hye7 + sisoe7
  
  hye12 ~ hye10 + d*sisoe10
  sisoe12 ~ c*hye10 + sisoe10

  # Estimate the covariance between the observed variables at the first wave. 
  hye5 ~~ sisoe5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  hye7 ~~ sisoe7
  hye10 ~~ sisoe10
  hye12 ~~ sisoe12
  
  # Estimate the (residual) variance of the observed variables.
  hye5 ~~ hye5 # Variances
  sisoe5 ~~ sisoe5 
  hye7 ~~ hye7 # Residual variances
  sisoe7 ~~ sisoe7 
  hye10 ~~ hye10 
  sisoe10 ~~ sisoe10 
  hye12 ~~ hye12 
  sisoe12 ~~ sisoe12 
'
```

```{r fit CLPMcomb_hyp2}
CLPMcomb_hyp2.fit <- lavaan(CLPMcomb_hyp2, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMcomb_hyp2.fit.summary <- summary(CLPMcomb_hyp2.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMcomb_hyp2.fit.summary.fit <- table.model.fit(CLPMcomb_hyp2.fit.summary)
CLPMcomb_hyp2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMcomb_hyp2.fit.summary.reg <- table.model.coef(model = CLPMcomb_hyp2.fit.summary, type = "CLPM", constraints = "Yes")
CLPMcomb_hyp2.fit.summary.reg


CLPMcomb_hyp2.fit.summary.reg %>% 
  select(lhs, op, rhs, std.all, pvalue) %>%
  mutate_if(is.numeric, round, 2)

CLPMcomb_hyp2.fit.summary.fit %>%
  select(-aic, -bic, -chisq ) %>%
  mutate_if(is.numeric, round, 2)
```

```{r LRT for RICLPMcomb_hyp and RICLPMcomb_hyp2}
lavTestLRT(CLPMcomb_hyp.fit, CLPMcomb_hyp2.fit, method = "satorra.bentler.2010")
```


## The basic RI-CLPM model (RICLPMcomb_hyp)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMcomb_hyp}
RICLPMcomb_hyp <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_hyp}
RICLPMcomb_hyp.fit <- lavaan(RICLPMcomb_hyp,       # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMcomb_hyp.fit.summary <- summary(RICLPMcomb_hyp.fit, 
                                  fit.measures = TRUE,
                                  standardized = TRUE)

#Table of model fit 
RICLPMcomb_hyp.fit.summary.fit <- table.model.fit(RICLPMcomb_hyp.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMcomb_hyp.fit.summary.reg <- table.model.coef(model = RICLPMcomb_hyp.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

Imposing constraints to the model can be achieved through **pre-multiplication**. It means that we have to prepend the number that we want to fix the parameter to, and an asterisk, to the parameter in the model specification. For example, `F =~ 0*x1` fixes the factor loading of ite `x1` to factor `F` to 0. Using pre-multiplication we can also constrain parameters to be the same by giving the the same label. Below we specify an RI-CLPM with the following constraints: 

1) fixed auto-regressive and cross-lagged relations over time, `wx2 ~ a*wx1 + b*wy1; ...`
2) time-invariant (residual) (co-)variances in the within-person part `wx2 ~~ cov*wy2; ...`, `wx2 ~~ vx*wx2; ...`, and `wy2 ~~ vy*wy2; ...`
3) constrained grand means over time, `x1 + ... ~ mx*1` and `y1 + ... ~ my*1`

Here we will use the Chi square significance value to indicate a significantly worse fitting model. 

You can also use fit indices for large sample sizes as below, we will use this method when looking at invariance testing in the measireent models:
 - RMSEA difference = increase smaller than 0.01 is acceptable
 - CFI difference = decrease smaller than 0.01 is acceptable
 - TLI difference = decrease smaller than 0.01 is acceptable

### Fixed autoregressive and cross-lagged relations over time (RICLPMcomb_hyp2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMcomb2)

```{r specify RICLPMcomb_hyp2}
RICLPMcomb_hyp2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_hyp2}
RICLPMcomb_hyp2.fit <- lavaan(RICLPMcomb_hyp2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_hyp and RICLPMcomb_hyp2}
lavTestLRT(RICLPMcomb_hyp.fit, RICLPMcomb_hyp2.fit, method = "satorra.bentler.2010")
```

RICLPMcomb_hyp2 is significantly *worse* fit compared to RICLPMcomb_hyp. 

#### Constraining lag in ADHD parameter (RICLPMcomb_hyp2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMcomb_hyp2a}
RICLPMcomb_hyp2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_hyp2a}
RICLPMcomb_hyp2a.fit <- lavaan(RICLPMcomb_hyp2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_hyp and RICLPMcomb_hyp2a}
lavTestLRT(RICLPMcomb_hyp.fit, RICLPMcomb_hyp2a.fit, method = "satorra.bentler.2010")
```

RICLPMcomb_hyp2a is significantly *worse* fit compared to RICLPMcomb_hyp. Now we will constrain the other set of stability coefficients: lag in si (b)

#### Constraining lag in social isolation parameter (RICLPMcomb_hyp2b)

```{r specify RICLPMcomb_hyp2b}
RICLPMcomb_hyp2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_hyp2b}
RICLPMcomb_hyp2b.fit <- lavaan(RICLPMcomb_hyp2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_hyp and RICLPMcomb_hyp2b}
lavTestLRT(RICLPMcomb_hyp.fit, RICLPMcomb_hyp2b.fit, method = "satorra.bentler.2010")
```

RICLPMcomb_hyp2b is significantly *worse* fit compared to RICLPMcomb_hyp. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMcomb_hyp2c)

```{r specify RICLPMcomb_hyp2c}
RICLPMcomb_hyp2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_hyp2c}
RICLPMcomb_hyp2c.fit <- lavaan(RICLPMcomb_hyp2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_hyp and RICLPMcomb_hyp2c}
lavTestLRT(RICLPMcomb_hyp.fit, RICLPMcomb_hyp2c.fit, method = "satorra.bentler.2010")
```

RICLPMcomb_hyp2c is *NOT* significantly worse fit compared to RICLPMcomb_hyp (p = 0.8422). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMcomb_hyp2d) - **compared to RICLPMcomb_hyp2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMcomb_hyp2d}
RICLPMcomb_hyp2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_hyp2d}
RICLPMcomb_hyp2d.fit <- lavaan(RICLPMcomb_hyp2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMcomb_hyp2d.fit.summary <- summary(RICLPMcomb_hyp2d.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPMcomb_hyp2d.fit.summary.fit <- table.model.fit(RICLPMcomb_hyp2d.fit.summary)
RICLPMcomb_hyp2d.fit.summary.fit %>% mutate_if(is.numeric, round, 2)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMcomb_hyp2d.fit.summary.reg <- table.model.coef(model = RICLPMcomb_hyp2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMcomb_hyp2d.fit.summary.reg %>% select(lhs, op, rhs, std.all, pvalue) %>% mutate_if(is.numeric, round, 2)
```

```{r LRT for RICLPMcomb_hyp2c and RICLPMcomb_hyp2d}
lavTestLRT(RICLPMcomb_hyp2c.fit, RICLPMcomb_hyp2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMcomb_hyp2d is *NOT* significantly worse fit compared to RICLPMcomb_hyp2c.fit (p = 0.4873). 

**The best fitting model (mother report and Hyperactivity/impulsivity ADHD symptoms) is currently RICLPMcomb2d where cross-lags are constrained to be equal across time.**

***

### Constrained grand means (RICLPMcomb_hyp3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMcomb_hyp3}
RICLPMcomb_hyp3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  hye5 + hye7 + hye10 + hye12 ~ mad*1
  sisoe5 + sisoe7 + sisoe10 + sisoe12 ~ msi*1
'
```

```{r fit RICLPMcomb_hyp3}
RICLPMcomb_hyp3.fit <- lavaan(RICLPMcomb_hyp3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_hyp and RICLPMcomb_hyp3}
lavTestLRT(RICLPMcomb_hyp.fit, RICLPMcomb_hyp3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Combined mother and teacher report, Inattention ADHD symptoms

## Cross-lagged panel model (CLPMcomb_inat)

```{r specify CLPMcomb_inat}
CLPMcomb_inat <- '
  # Estimate the lagged effects between the observed variables.
  ine7 + sisoe7 ~ ine5 + sisoe5
  ine10 + sisoe10 ~ ine7 + sisoe7
  ine12 + sisoe12 ~ ine10 + sisoe10

  # Estimate the covariance between the observed variables at the first wave. 
  ine5 ~~ sisoe5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  ine7 ~~ sisoe7
  ine10 ~~ sisoe10
  ine12 ~~ sisoe12
  
  # Estimate the (residual) variance of the observed variables.
  ine5 ~~ ine5 # Variances
  sisoe5 ~~ sisoe5 
  ine7 ~~ ine7 # Residual variances
  sisoe7 ~~ sisoe7 
  ine10 ~~ ine10 
  sisoe10 ~~ sisoe10 
  ine12 ~~ ine12 
  sisoe12 ~~ sisoe12 
'
```

```{r fit CLPMcomb_inat}
CLPMcomb_inat.fit <- lavaan(CLPMcomb_inat, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMcomb_inat.fit.summary <- summary(CLPMcomb_inat.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMcomb_inat.fit.summary.fit <- table.model.fit(CLPMcomb_inat.fit.summary)
CLPMcomb_inat.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMcomb_inat.fit.summary.reg <- table.model.coef(model = CLPMcomb_inat.fit.summary, type = "CLPM", constraints = "No")
CLPMcomb_inat.fit.summary.reg

CLPMcomb_inat.fit.summary.fit %>%
  select(-aic, -bic, -chisq ) %>%
  mutate_if(is.numeric, round, 2)
```

## Constrained cross-lagged panel model (CLPMcomb_inat2)

```{r specify CLPMcomb_inat}
CLPMcomb_inat2 <- '
  # Estimate the lagged effects between the observed variables - constrained
  ine7 ~ ine5 + d*sisoe5 
  sisoe7 ~ c*ine5 + sisoe5
  
  ine10 ~ ine7 + d*sisoe7
  sisoe10 ~ c*ine7 + sisoe7
  
  ine12 ~ ine10 + d*sisoe10
  sisoe12 ~ c*ine10 + sisoe10

  # Estimate the covariance between the observed variables at the first wave. 
  ine5 ~~ sisoe5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  ine7 ~~ sisoe7
  ine10 ~~ sisoe10
  ine12 ~~ sisoe12
  
  # Estimate the (residual) variance of the observed variables.
  ine5 ~~ ine5 # Variances
  sisoe5 ~~ sisoe5 
  ine7 ~~ ine7 # Residual variances
  sisoe7 ~~ sisoe7 
  ine10 ~~ ine10 
  sisoe10 ~~ sisoe10 
  ine12 ~~ ine12 
  sisoe12 ~~ sisoe12 
'
```

```{r fit CLPMcomb_inat2}
CLPMcomb_inat2.fit <- lavaan(CLPMcomb_inat2, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMcomb_inat2.fit.summary <- summary(CLPMcomb_inat2.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMcomb_inat2.fit.summary.fit <- table.model.fit(CLPMcomb_inat2.fit.summary)
CLPMcomb_inat2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMcomb_inat2.fit.summary.reg <- table.model.coef(model = CLPMcomb_inat2.fit.summary, type = "CLPM", constraints = "Yes")
CLPMcomb_inat2.fit.summary.reg


CLPMcomb_inat2.fit.summary.reg %>% 
  select(lhs, op, rhs, std.all, pvalue) %>%
  mutate_if(is.numeric, round, 2)

CLPMcomb_inat2.fit.summary.fit %>%
  select(-aic, -bic, -chisq ) %>%
  mutate_if(is.numeric, round, 2)
```

```{r LRT for RICLPMcomb_inat and RICLPMcomb_inat2}
lavTestLRT(CLPMcomb_inat.fit, CLPMcomb_inat2.fit, method = "satorra.bentler.2010")
```


## The basic RI-CLPM model (RICLPMcomb_inat)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMcomb_inat}
RICLPMcomb_inat <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_inat}
RICLPMcomb_inat.fit <- lavaan(RICLPMcomb_inat,     # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMcomb_inat.fit.summary <- summary(RICLPMcomb_inat.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPMcomb_inat.fit.summary.fit <- table.model.fit(RICLPMcomb_inat.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMcomb_inat.fit.summary.reg <- table.model.coef(model = RICLPMcomb_inat.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

Imposing constraints to the model can be achieved through **pre-multiplication**. It means that we have to prepend the number that we want to fix the parameter to, and an asterisk, to the parameter in the model specification. For example, `F =~ 0*x1` fixes the factor loading of ite `x1` to factor `F` to 0. Using pre-multiplication we can also constrain parameters to be the same by giving the the same label. Below we specify an RI-CLPM with the following constraints: 

1) fixed auto-regressive and cross-lagged relations over time, `wx2 ~ a*wx1 + b*wy1; ...`
2) time-invariant (residual) (co-)variances in the within-person part `wx2 ~~ cov*wy2; ...`, `wx2 ~~ vx*wx2; ...`, and `wy2 ~~ vy*wy2; ...`
3) constrained grand means over time, `x1 + ... ~ mx*1` and `y1 + ... ~ my*1`


### Fixed autoregressive and cross-lagged relations over time (RICLPMcomb_inat2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMcomb2)

```{r specify RICLPMcomb_inat2}
RICLPMcomb_inat2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_inat2}
RICLPMcomb_inat2.fit <- lavaan(RICLPMcomb_inat2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_inat and RICLPMcomb_inat2}
lavTestLRT(RICLPMcomb_inat.fit, RICLPMcomb_inat2.fit, method = "satorra.bentler.2010")
```

RICLPMcomb_inat2 is significantly *worse* fit compared to RICLPMcomb_inat. 

#### Constraining lag in ADHD parameter (RICLPMcomb_inat2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMcomb_inat2a}
RICLPMcomb_inat2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_inat2a}
RICLPMcomb_inat2a.fit <- lavaan(RICLPMcomb_inat2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_inat and RICLPMcomb_inat2a}
lavTestLRT(RICLPMcomb_inat.fit, RICLPMcomb_inat2a.fit, method = "satorra.bentler.2010")
```

RICLPMcomb_inat2a is significantly *worse* fit compared to RICLPMcomb_inat. Now we will constrain the other set of stability coefficients: lag in si (b)

#### Constraining lag in social isolation parameter (RICLPMcomb_inat2b)

```{r specify RICLPMcomb_inat2b}
RICLPMcomb_inat2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_inat2b}
RICLPMcomb_inat2b.fit <- lavaan(RICLPMcomb_inat2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_inat and RICLPMcomb_inat2b}
lavTestLRT(RICLPMcomb_inat.fit, RICLPMcomb_inat2b.fit, method = "satorra.bentler.2010")
```

RICLPMcomb_inat2b is significantly *worse* fit compared to RICLPMcomb_inat. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMcomb_inat2c)

```{r specify RICLPMcomb_inat2c}
RICLPMcomb_inat2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_inat2c}
RICLPMcomb_inat2c.fit <- lavaan(RICLPMcomb_inat2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_inat and RICLPMcomb_inat2c}
lavTestLRT(RICLPMcomb_inat.fit, RICLPMcomb_inat2c.fit, method = "satorra.bentler.2010")
```

RICLPMcomb_inat2c is *NOT* significantly worse fit compared to RICLPMcomb_inat (p = 0.5174). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMcomb_inat2d) - **compared to RICLPMcomb_inat2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMcomb_inat2d}
RICLPMcomb_inat2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMcomb_inat2d}
RICLPMcomb_inat2d.fit <- lavaan(RICLPMcomb_inat2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMcomb_inat2d.fit.summary <- summary(RICLPMcomb_inat2d.fit, 
                                      fit.measures = TRUE,
                                      standardized = TRUE)

#Table of model fit 
RICLPMcomb_inat2d.fit.summary.fit <- table.model.fit(RICLPMcomb_inat2d.fit.summary)
RICLPMcomb_inat2d.fit.summary.fit %>% mutate_if(is.numeric, round, 2)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMcomb_inat2d.fit.summary.reg <- table.model.coef(model = RICLPMcomb_inat2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMcomb_inat2d.fit.summary.reg %>% select(lhs, op, rhs, std.all, pvalue) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMcomb_inat2c and RICLPMcomb_inat2d}
lavTestLRT(RICLPMcomb_inat2c.fit, RICLPMcomb_inat2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMcomb_inat2d is *NOT* significantly worse fit compared to RICLPMcomb_inat2c.fit (p = 0.6351). 

**The best fitting model (mother report and inattention ADHD symptoms) is currently RICLPMcomb2d where cross-lags are constrained to be equal across time.**

***

### Constrained grand means (RICLPMcomb_inat3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMcomb_inat3}
RICLPMcomb_inat3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  ine5 + ine7 + ine10 + ine12 ~ mad*1
  sisoe5 + sisoe7 + sisoe10 + sisoe12 ~ msi*1
'
```

```{r fit RICLPMcomb_inat3}
RICLPMcomb_inat3.fit <- lavaan(RICLPMcomb_inat3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMcomb_inat and RICLPMcomb_inat3}
lavTestLRT(RICLPMcomb_inat.fit, RICLPMcomb_inat3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Isolation is combined mother and teacher report, total ADHD symptoms is teacher report

## Cross-lagged panel model (CLPMadt)

```{r specify CLPMadt}
CLPMadt <- '
  # Estimate the lagged effects between the observed variables.
  tadhdet7 + sisoe7 ~ tadhdet5 + sisoe5
  tadhdet10 + sisoe10 ~ tadhdet7 + sisoe7
  tadhdet12 + sisoe12 ~ tadhdet10 + sisoe10

  # Estimate the covariance between the observed variables at the first wave. 
  tadhdet5 ~~ sisoe5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  tadhdet7 ~~ sisoe7
  tadhdet10 ~~ sisoe10
  tadhdet12 ~~ sisoe12
  
  # Estimate the (residual) variance of the observed variables.
  tadhdet5 ~~ tadhdet5 # Variances
  sisoe5 ~~ sisoe5 
  tadhdet7 ~~ tadhdet7 # Residual variances
  sisoe7 ~~ sisoe7 
  tadhdet10 ~~ tadhdet10 
  sisoe10 ~~ sisoe10 
  tadhdet12 ~~ tadhdet12 
  sisoe12 ~~ sisoe12 
'
```

```{r fit CLPMadt}
CLPMadt.fit <- lavaan(CLPMadt, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMadt.fit.summary <- summary(CLPMadt.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMadt.fit.summary.fit <- table.model.fit(CLPMadt.fit.summary)
CLPMadt.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMadt.fit.summary.reg <- table.model.coef(model = CLPMadt.fit.summary, type = "CLPM", constraints = "No")
CLPMadt.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

## The basic RI-CLPM model (RICLPMadt)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMadt, class.source = 'fold-show'}
RICLPMadt <- '
  # Create between components (rando intercepts treated as factors here)
  RIad =~ 1*tadhdet5 + 1*tadhdet7 + 1*tadhdet10 + 1*tadhdet12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdet5
  wad7 =~ 1*tadhdet7
  wad10 =~ 1*tadhdet10 
  wad12 =~ 1*tadhdet12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadt}
RICLPMadt.fit <- lavaan(RICLPMadt,               # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMadt.fit.summary <- summary(RICLPMadt.fit, 
                              fit.measures = TRUE,
                              standardized = TRUE)

#Table of model fit 
RICLPMadt.fit.summary.fit <- table.model.fit(RICLPMadt.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadt.fit.summary.reg <- table.model.coef(model = RICLPMadt.fit.summary, type = "RICLPM", constraints = "No")
```

#### Constraining all lag and crosslag parameters at once (RICLPMadt2)

```{r specify RICLPMadt2}
RICLPMadt2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdet5 + 1*tadhdet7 + 1*tadhdet10 + 1*tadhdet12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdet5
  wad7 =~ 1*tadhdet7
  wad10 =~ 1*tadhdet10 
  wad12 =~ 1*tadhdet12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadt2}
RICLPMadt2.fit <- lavaan(RICLPMadt2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMadt2.fit.summary <- summary(RICLPMadt2.fit, 
                              fit.measures = TRUE,
                              standardized = TRUE)

#Table of model fit 
RICLPMadt2.fit.summary.fit <- table.model.fit(RICLPMadt2.fit.summary)
RICLPMadt2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadt2.fit.summary.reg <- table.model.coef(model = RICLPMadt2.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMadt2.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMadt and RICLPMadt2}
lavTestLRT(RICLPMadt.fit, RICLPMadt2.fit, method = "satorra.bentler.2010")
```

RICLPMadt2 is *not* significantly fit compared to RICLPMadt according to the Chi square test (p = 0.09885)

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMadt2 where both autoregressives and cross-lags are constrained to be equal across time.**

***

### Constrainetd grand means (RICLPMadt3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMadt3}
RICLPMadt3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdet5 + 1*tadhdet7 + 1*tadhdet10 + 1*tadhdet12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdet5
  wad7 =~ 1*tadhdet7
  wad10 =~ 1*tadhdet10 
  wad12 =~ 1*tadhdet12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  tadhdet5 + tadhdet7 + tadhdet10 + tadhdet12 ~ mad*1
  sisoe5 + sisoe7 + sisoe10 + sisoe12 ~ msi*1
'
```

```{r fit RICLPMadt3}
RICLPMadt3.fit <- lavaan(RICLPMadt3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadt and RICLPMadt3}
lavTestLRT(RICLPMadt.fit, RICLPMadt3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrainetd to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Isolation is combined mother and teacher report, Hyperactive/Impulsive ADHD is teacher report only

## The basic RI-CLPM model (RICLPMadt_hyp)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMadt_hyp}
RICLPMadt_hyp <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyet5 + 1*hyet7 + 1*hyet10 + 1*hyet12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyet5
  wad7 =~ 1*hyet7
  wad10 =~ 1*hyet10 
  wad12 =~ 1*hyet12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadt_hyp}
RICLPMadt_hyp.fit <- lavaan(RICLPMadt_hyp,       # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMadt_hyp.fit.summary <- summary(RICLPMadt_hyp.fit, 
                                  fit.measures = TRUE,
                                  standardized = TRUE)

#Table of model fit 
RICLPMadt_hyp.fit.summary.fit <- table.model.fit(RICLPMadt_hyp.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadt_hyp.fit.summary.reg <- table.model.coef(model = RICLPMadt_hyp.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

### Fixed autoregressive and cross-lagged relations over time (RICLPMadt_hyp2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMadt2)

```{r specify RICLPMadt_hyp2}
RICLPMadt_hyp2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyet5 + 1*hyet7 + 1*hyet10 + 1*hyet12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyet5
  wad7 =~ 1*hyet7
  wad10 =~ 1*hyet10 
  wad12 =~ 1*hyet12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadt_hyp2}
RICLPMadt_hyp2.fit <- lavaan(RICLPMadt_hyp2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMadt_hyp2.fit.summary <- summary(RICLPMadt_hyp2.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPMadt_hyp2.fit.summary.fit <- table.model.fit(RICLPMadt_hyp2.fit.summary)
RICLPMadt_hyp2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadt_hyp2.fit.summary.reg <- table.model.coef(model = RICLPMadt_hyp2.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMadt_hyp2.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMadt_hyp and RICLPMadt_hyp2}
lavTestLRT(RICLPMadt_hyp.fit, RICLPMadt_hyp2.fit, method = "satorra.bentler.2010")
```

RICLPMadt_hyp2 is significantly *worse* fit compared to RICLPMadt_hyp. **However**, p = 0.042 which is very close to being non-significant. As the Chi square p value is often inflated for large samples, we will accept this model as the best fitting. 

**The best fitting model (mother report and Hyperactivity/impulsivity ADHD symptoms) is currently RICLPMadt2 where cross-lags are constrained to be equal across time.**

### Constrainetd grand means (RICLPMadt_hyp3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMadt_hyp3}
RICLPMadt_hyp3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyet5 + 1*hyet7 + 1*hyet10 + 1*hyet12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyet5
  wad7 =~ 1*hyet7
  wad10 =~ 1*hyet10 
  wad12 =~ 1*hyet12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  hyet5 + hyet7 + hyet10 + hyet12 ~ mad*1
  sisoe5 + sisoe7 + sisoe10 + sisoe12 ~ msi*1
'
```

```{r fit RICLPMadt_hyp3}
RICLPMadt_hyp3.fit <- lavaan(RICLPMadt_hyp3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadt_hyp and RICLPMadt_hyp3}
lavTestLRT(RICLPMadt_hyp.fit, RICLPMadt_hyp3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrainetd to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Isolation is combined mother and teacher report, Inattention ADHD is teacher report only

## The basic RI-CLPM model (RICLPMadt_inat)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMadt_inat}
RICLPMadt_inat <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inet5 + 1*inet7 + 1*inet10 + 1*inet12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inet5
  wad7 =~ 1*inet7
  wad10 =~ 1*inet10 
  wad12 =~ 1*inet12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadt_inat}
RICLPMadt_inat.fit <- lavaan(RICLPMadt_inat,     # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMadt_inat.fit.summary <- summary(RICLPMadt_inat.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPMadt_inat.fit.summary.fit <- table.model.fit(RICLPMadt_inat.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadt_inat.fit.summary.reg <- table.model.coef(model = RICLPMadt_inat.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

### Fixed autoregressive and cross-lagged relations over time (RICLPMadt_inat2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMadt2)

```{r specify RICLPMadt_inat2}
RICLPMadt_inat2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inet5 + 1*inet7 + 1*inet10 + 1*inet12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inet5
  wad7 =~ 1*inet7
  wad10 =~ 1*inet10 
  wad12 =~ 1*inet12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadt_inat2}
RICLPMadt_inat2.fit <- lavaan(RICLPMadt_inat2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMadt_inat2.fit.summary <- summary(RICLPMadt_inat2.fit, 
                                      fit.measures = TRUE,
                                      standardized = TRUE)

#Table of model fit 
RICLPMadt_inat2.fit.summary.fit <- table.model.fit(RICLPMadt_inat2.fit.summary)
RICLPMadt_inat2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadt_inat2.fit.summary.reg <- table.model.coef(model = RICLPMadt_inat2.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMadt_inat2.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMadt_inat and RICLPMadt_inat2}
lavTestLRT(RICLPMadt_inat.fit, RICLPMadt_inat2.fit, method = "satorra.bentler.2010")
```

RICLPMadt_inat2 is significantly *worse* (p = 0.02499) fit compared to RICLPMadt_inat. **However, there was no large change (over 0.01) in model fit - therefore we will keep this as the best fitting model. 

Difference in fit:                      RICLPMadt_inat2     RICLPMadt_inat
  Robust Comparative Fit Index (CFI)      0.978              0.986        (0.008)
  Robust Tucker-Lewis Index (TLI)         0.964              0.957        (-0.007) - better fit 
  Robust RMSEA                            0.045              0.049        (0.004)
  SRMR                                    0.042              0.031        (0.011)
  
  **The best fitting model (mother report and inattention ADHD symptoms) is currently RICLPMadt2 where autoregressives and cross-lags are constrained to be equal across time.**

### Constrainetd grand means (RICLPMadt_inat3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMadt_inat3}
RICLPMadt_inat3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inet5 + 1*inet7 + 1*inet10 + 1*inet12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inet5
  wad7 =~ 1*inet7
  wad10 =~ 1*inet10 
  wad12 =~ 1*inet12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  inet5 + inet7 + inet10 + inet12 ~ mad*1
  sisoe5 + sisoe7 + sisoe10 + sisoe12 ~ msi*1
'
```

```{r fit RICLPMadt_inat3}
RICLPMadt_inat3.fit <- lavaan(RICLPMadt_inat3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadt_inat and RICLPMadt_inat3}
lavTestLRT(RICLPMadt_inat.fit, RICLPMadt_inat3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrainetd to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Isolation is combined mother and teacher report, total ADHD symptoms is mother report

## Cross-lagged panel model (CLPMadm)

```{r specify CLPMadm}
CLPMadm <- '
  # Estimate the lagged effects between the observed variables.
  tadhdem7 + sisoe7 ~ tadhdem5 + sisoe5
  tadhdem10 + sisoe10 ~ tadhdem7 + sisoe7
  tadhdem12 + sisoe12 ~ tadhdem10 + sisoe10

  # Estimate the covariance between the observed variables at the first wave. 
  tadhdem5 ~~ sisoe5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  tadhdem7 ~~ sisoe7
  tadhdem10 ~~ sisoe10
  tadhdem12 ~~ sisoe12
  
  # Estimate the (residual) variance of the observed variables.
  tadhdem5 ~~ tadhdem5 # Variances
  sisoe5 ~~ sisoe5 
  tadhdem7 ~~ tadhdem7 # Residual variances
  sisoe7 ~~ sisoe7 
  tadhdem10 ~~ tadhdem10 
  sisoe10 ~~ sisoe10 
  tadhdem12 ~~ tadhdem12 
  sisoe12 ~~ sisoe12 
'
```

```{r fit CLPMadm}
CLPMadm.fit <- lavaan(CLPMadm, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMadm.fit.summary <- summary(CLPMadm.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMadm.fit.summary.fit <- table.model.fit(CLPMadm.fit.summary)
CLPMadm.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMadm.fit.summary.reg <- table.model.coef(model = CLPMadm.fit.summary, type = "CLPM", constraints = "No")
CLPMadm.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

## The basic RI-CLPM model (RICLPMadm)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMadm, class.source = 'fold-show'}
RICLPMadm <- '
  # Create between components (rando intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm}
RICLPMadm.fit <- lavaan(RICLPMadm,               # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMadm.fit.summary <- summary(RICLPMadm.fit, 
                              fit.measures = TRUE,
                              standardized = TRUE)

#Table of model fit 
RICLPMadm.fit.summary.fit <- table.model.fit(RICLPMadm.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadm.fit.summary.reg <- table.model.coef(model = RICLPMadm.fit.summary, type = "RICLPM", constraints = "No")
```

#### Constraining all lag and crosslag parameters at once (RICLPMadm2)

```{r specify RICLPMadm2}
RICLPMadm2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  
  # Constrainemd lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm2}
RICLPMadm2.fit <- lavaan(RICLPMadm2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm and RICLPMadm2}
lavTestLRT(RICLPMadm.fit, RICLPMadm2.fit, method = "satorra.bentler.2010")
```

RICLPMadm2 is significantly *worse* fit compared to RICLPMadm according to the Chi square test. 

#### Constraining lag in ADHD parameter (RICLPMadm2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMadm2a}
RICLPMadm2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm2a}
RICLPMadm2a.fit <- lavaan(RICLPMadm2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm and RICLPMadm2a}
lavTestLRT(RICLPMadm.fit, RICLPMadm2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMadm2b)

```{r specify RICLPMadm2b}
RICLPMadm2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm2b}
RICLPMadm2b.fit <- lavaan(RICLPMadm2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm and RICLPMadm2b}
lavTestLRT(RICLPMadm.fit, RICLPMadm2b.fit, method = "satorra.bentler.2010")
```

RICLPMadm2b is significantly *worse* fit compared to RICLPMadm. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMadm2c)

```{r specify RICLPMadm2c}
RICLPMadm2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm2c}
RICLPMadm2c.fit <- lavaan(RICLPMadm2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm and RICLPMadm2c}
lavTestLRT(RICLPMadm.fit, RICLPMadm2c.fit, method = "satorra.bentler.2010")
```

RICLPMadm2c is *NOT* significantly worse fit compared to RICLPMadm (p = 0.6336). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMadm2d) - **compared to RICLPMadm2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMadm2d}
RICLPMadm2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm2d}
RICLPMadm2d.fit <- lavaan(RICLPMadm2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMadm2d.fit.summary <- summary(RICLPMadm2d.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)

#Table of model fit 
RICLPMadm2d.fit.summary.fit <- table.model.fit(RICLPMadm2d.fit.summary)
RICLPMadm2d.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadm2d.fit.summary.reg <- table.model.coef(model = RICLPMadm2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMadm2d.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMadm2c and RICLPMadm2d}
lavTestLRT(RICLPMadm2c.fit, RICLPMadm2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMadm2d is *NOT* significantly worse fit compared to RICLPMadm2c (p = 0.2709). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMadm2d where cross-lags are constrained to be equal across time.**

***

### Constrainemd grand means (RICLPMadm3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMadm3}
RICLPMadm3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhdem5 + 1*tadhdem7 + 1*tadhdem10 + 1*tadhdem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhdem5
  wad7 =~ 1*tadhdem7
  wad10 =~ 1*tadhdem10 
  wad12 =~ 1*tadhdem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrainemd lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  tadhdem5 + tadhdem7 + tadhdem10 + tadhdem12 ~ mad*1
  sisoe5 + sisoe7 + sisoe10 + sisoe12 ~ msi*1
'
```

```{r fit RICLPMadm3}
RICLPMadm3.fit <- lavaan(RICLPMadm3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm and RICLPMadm3}
lavTestLRT(RICLPMadm.fit, RICLPMadm3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Isolation is combined mother and teacher report, Hyperactive/Impulsive ADHD is mother report only

## The basic RI-CLPM model (RICLPMadm_hyp)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMadm_hyp}
RICLPMadm_hyp <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_hyp}
RICLPMadm_hyp.fit <- lavaan(RICLPMadm_hyp,       # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMadm_hyp.fit.summary <- summary(RICLPMadm_hyp.fit, 
                                  fit.measures = TRUE,
                                  standardized = TRUE)

#Table of model fit 
RICLPMadm_hyp.fit.summary.fit <- table.model.fit(RICLPMadm_hyp.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadm_hyp.fit.summary.reg <- table.model.coef(model = RICLPMadm_hyp.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

### Fixed autoregressive and cross-lagged relations over time (RICLPMadm_hyp2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMadm2)

```{r specify RICLPMadm_hyp2}
RICLPMadm_hyp2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  
  # Constrainemd lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_hyp2}
RICLPMadm_hyp2.fit <- lavaan(RICLPMadm_hyp2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_hyp and RICLPMadm_hyp2}
lavTestLRT(RICLPMadm_hyp.fit, RICLPMadm_hyp2.fit, method = "satorra.bentler.2010")
```

RICLPMadm_hyp2 is significantly *worse* fit compared to RICLPMadm_hyp. 

#### Constraining lag in ADHD parameter (RICLPMadm_hyp2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMadm_hyp2a}
RICLPMadm_hyp2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_hyp2a}
RICLPMadm_hyp2a.fit <- lavaan(RICLPMadm_hyp2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_hyp and RICLPMadm_hyp2a}
lavTestLRT(RICLPMadm_hyp.fit, RICLPMadm_hyp2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMadm_hyp2b)

```{r specify RICLPMadm_hyp2b}
RICLPMadm_hyp2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_hyp2b}
RICLPMadm_hyp2b.fit <- lavaan(RICLPMadm_hyp2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_hyp and RICLPMadm_hyp2b}
lavTestLRT(RICLPMadm_hyp.fit, RICLPMadm_hyp2b.fit, method = "satorra.bentler.2010")
```

RICLPMadm_hyp2b is significantly *worse* fit compared to RICLPMadm_hyp. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMadm_hyp2c)

```{r specify RICLPMadm_hyp2c}
RICLPMadm_hyp2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_hyp2c}
RICLPMadm_hyp2c.fit <- lavaan(RICLPMadm_hyp2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_hyp and RICLPMadm_hyp2c}
lavTestLRT(RICLPMadm_hyp.fit, RICLPMadm_hyp2c.fit, method = "satorra.bentler.2010")
```

RICLPMadm_hyp2c is *NOT* significantly worse fit compared to RICLPMadm_hyp (p = 0.4853). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMadm_hyp2d) - **compared to RICLPMadm_hyp2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMadm_hyp2d}
RICLPMadm_hyp2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_hyp2d}
RICLPMadm_hyp2d.fit <- lavaan(RICLPMadm_hyp2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMadm_hyp2d.fit.summary <- summary(RICLPMadm_hyp2d.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)

#Table of model fit 
RICLPMadm_hyp2d.fit.summary.fit <- table.model.fit(RICLPMadm_hyp2d.fit.summary)
RICLPMadm_hyp2d.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadm_hyp2d.fit.summary.reg <- table.model.coef(model = RICLPMadm_hyp2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMadm_hyp2d.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMadm_hyp2c and RICLPMadm_hyp2d}
lavTestLRT(RICLPMadm_hyp2c.fit, RICLPMadm_hyp2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMadm_hyp2d is *NOT* significantly worse fit compared to RICLPMadm_hyp2c (0.2131). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMadm_hyp2d where cross-lags are constrained to be equal across time.**

### Constrainemd grand means (RICLPMadm_hyp3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMadm_hyp3}
RICLPMadm_hyp3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hyem5 + 1*hyem7 + 1*hyem10 + 1*hyem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*hyem5
  wad7 =~ 1*hyem7
  wad10 =~ 1*hyem10 
  wad12 =~ 1*hyem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrainemd lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  hyem5 + hyem7 + hyem10 + hyem12 ~ mad*1
  sisoe5 + sisoe7 + sisoe10 + sisoe12 ~ msi*1
'
```

```{r fit RICLPMadm_hyp3}
RICLPMadm_hyp3.fit <- lavaan(RICLPMadm_hyp3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_hyp and RICLPMadm_hyp3}
lavTestLRT(RICLPMadm_hyp.fit, RICLPMadm_hyp3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrainemd to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Isolation is combined mother and teacher report, Inattention ADHD is mother report only

## The basic RI-CLPM model (RICLPMadm_inat)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMadm_inat}
RICLPMadm_inat <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_inat}
RICLPMadm_inat.fit <- lavaan(RICLPMadm_inat,     # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMadm_inat.fit.summary <- summary(RICLPMadm_inat.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPMadm_inat.fit.summary.fit <- table.model.fit(RICLPMadm_inat.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadm_inat.fit.summary.reg <- table.model.coef(model = RICLPMadm_inat.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

### Fixed autoregressive and cross-lagged relations over time (RICLPMadm_inat2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMadm2)

```{r specify RICLPMadm_inat2}
RICLPMadm_inat2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrainemd lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_inat2}
RICLPMadm_inat2.fit <- lavaan(RICLPMadm_inat2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_inat and RICLPMadm_inat2}
lavTestLRT(RICLPMadm_inat.fit, RICLPMadm_inat2.fit, method = "satorra.bentler.2010")
```

RICLPMadm_inat2 is significantly *worse* fit compared to RICLPMadm_inat. 

#### Constraining lag in ADHD parameter (RICLPMadm_inat2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMadm_inat2a}
RICLPMadm_inat2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_inat2a}
RICLPMadm_inat2a.fit <- lavaan(RICLPMadm_inat2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_inat and RICLPMadm_inat2a}
lavTestLRT(RICLPMadm_inat.fit, RICLPMadm_inat2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMadm_inat2b)

```{r specify RICLPMadm_inat2b}
RICLPMadm_inat2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_inat2b}
RICLPMadm_inat2b.fit <- lavaan(RICLPMadm_inat2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_inat and RICLPMadm_inat2b}
lavTestLRT(RICLPMadm_inat.fit, RICLPMadm_inat2b.fit, method = "satorra.bentler.2010")
```

RICLPMadm_inat2b is significantly *worse* fit compared to RICLPMadm_inat. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMadm_inat2c)

```{r specify RICLPMadm_inat2c}
RICLPMadm_inat2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_inat2c}
RICLPMadm_inat2c.fit <- lavaan(RICLPMadm_inat2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_inat and RICLPMadm_inat2c}
lavTestLRT(RICLPMadm_inat.fit, RICLPMadm_inat2c.fit, method = "satorra.bentler.2010")
```

RICLPMadm_inat2c is *NOT* significantly worse fit compared to RICLPMadm_inat (p = 0.5649). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMadm_inat2d) - **compared to RICLPMadm_inat2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMadm_inat2d}
RICLPMadm_inat2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMadm_inat2d}
RICLPMadm_inat2d.fit <- lavaan(RICLPMadm_inat2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMadm_inat2d.fit.summary <- summary(RICLPMadm_inat2d.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)

#Table of model fit 
RICLPMadm_inat2d.fit.summary.fit <- table.model.fit(RICLPMadm_inat2d.fit.summary)
RICLPMadm_inat2d.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMadm_inat2d.fit.summary.reg <- table.model.coef(model = RICLPMadm_inat2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMadm_inat2d.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMadm_inat2c and RICLPMadm_inat2d}
lavTestLRT(RICLPMadm_inat2c.fit, RICLPMadm_inat2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMadm_inat2d is *NOT* significantly worse fit compared to RICLPMadm_inat2c (0.6671). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMadm_inat2d where cross-lags are constrained to be equal across time.**

### Constrainemd grand means (RICLPMadm_inat3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMadm_inat3}
RICLPMadm_inat3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*inem5 + 1*inem7 + 1*inem10 + 1*inem12 #x
  RIsi =~ 1*sisoe5 + 1*sisoe7 + 1*sisoe10 + 1*sisoe12 #y

  # Create within-person centered variables
  wad5 =~ 1*inem5
  wad7 =~ 1*inem7
  wad10 =~ 1*inem10 
  wad12 =~ 1*inem12
  wsi5 =~ 1*sisoe5
  wsi7 =~ 1*sisoe7
  wsi10 =~ 1*sisoe10
  wsi12 =~ 1*sisoe12
  
  # Constrainemd lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  inem5 + inem7 + inem10 + inem12 ~ mad*1
  sisoe5 + sisoe7 + sisoe10 + sisoe12 ~ msi*1
'
```

```{r fit RICLPMadm_inat3}
RICLPMadm_inat3.fit <- lavaan(RICLPMadm_inat3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMadm_inat and RICLPMadm_inat3}
lavTestLRT(RICLPMadm_inat.fit, RICLPMadm_inat3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrainemd to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Total ADHD is combined mother and teacher report, isolation is teacher report

## Cross-lagged panel model (CLPMsit)

```{r specify CLPMsit}
CLPMsit <- '
  # Estimate the lagged effects between the observed variables.
  tadhde7 + sisoet7 ~ tadhde5 + sisoet5
  tadhde10 + sisoet10 ~ tadhde7 + sisoet7
  tadhde12 + sisoet12 ~ tadhde10 + sisoet10

  # Estimate the covariance between the observed variables at the first wave. 
  tadhde5 ~~ sisoet5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  tadhde7 ~~ sisoet7
  tadhde10 ~~ sisoet10
  tadhde12 ~~ sisoet12
  
  # Estimate the (residual) variance of the observed variables.
  tadhde5 ~~ tadhde5 # Variances
  sisoet5 ~~ sisoet5 
  tadhde7 ~~ tadhde7 # Residual variances
  sisoet7 ~~ sisoet7 
  tadhde10 ~~ tadhde10 
  sisoet10 ~~ sisoet10 
  tadhde12 ~~ tadhde12 
  sisoet12 ~~ sisoet12 
'
```

```{r fit CLPMsit}
CLPMsit.fit <- lavaan(CLPMsit, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMsit.fit.summary <- summary(CLPMsit.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMsit.fit.summary.fit <- table.model.fit(CLPMsit.fit.summary)
CLPMsit.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMsit.fit.summary.reg <- table.model.coef(model = CLPMsit.fit.summary, type = "CLPM", constraints = "No")
CLPMsit.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

## The basic RI-CLPM model (RICLPMsit)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMsit, class.source = 'fold-show'}
RICLPMsit <- '
  # Create between components (rando intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit}
RICLPMsit.fit <- lavaan(RICLPMsit,               # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMsit.fit.summary <- summary(RICLPMsit.fit, 
                              fit.measures = TRUE,
                              standardized = TRUE)

#Table of model fit 
RICLPMsit.fit.summary.fit <- table.model.fit(RICLPMsit.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsit.fit.summary.reg <- table.model.coef(model = RICLPMsit.fit.summary, type = "RICLPM", constraints = "No")
RICLPMsit.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

#### Constraining all lag and crosslag parameters at once (RICLPMsit2)

```{r specify RICLPMsit2}
RICLPMsit2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit2}
RICLPMsit2.fit <- lavaan(RICLPMsit2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMsit2.fit.summary <- summary(RICLPMsit2.fit, 
                              fit.measures = TRUE,
                              standardized = TRUE)

#Table of model fit 
RICLPMsit2.fit.summary.fit <- table.model.fit(RICLPMsit2.fit.summary)
RICLPMsit2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsit2.fit.summary.reg <- table.model.coef(model = RICLPMsit2.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMsit2.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMsit and RICLPMsit2}
lavTestLRT(RICLPMsit.fit, RICLPMsit2.fit, method = "satorra.bentler.2010")
```

RICLPMsit2 is significantly *worse* fit compared to RICLPMsit according to the Chi square test (p = 0.005094)

Comparison of fit statistics:       Model2  Model
Robust Comparative Fit Index (CFI)  0.985   0.993 (0.008)
Robust Tucker-Lewis Index (TLI)     0.975   0.978 (0.003)
Robust RMSEA                        0.042   0.039 (0.003)
SRMR                                0.035   0.029 (0.006)
All change in fit statistics is less than 0.01 - we can accept these constraints. Also the other significance levels are almost non-significant (chi square is likely inflated with large sample size)
2a p = 0.016
2b p = 0.1738
2c p = 0.4859
2d p = 0.065

#### Constraining lag in ADHD parameter (RICLPMsit2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMsit2a}
RICLPMsit2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit2a}
RICLPMsit2a.fit <- lavaan(RICLPMsit2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit and RICLPMsit2a}
lavTestLRT(RICLPMsit.fit, RICLPMsit2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMsit2b)

```{r specify RICLPMsit2b}
RICLPMsit2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit2b}
RICLPMsit2b.fit <- lavaan(RICLPMsit2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit and RICLPMsit2b}
lavTestLRT(RICLPMsit.fit, RICLPMsit2b.fit, method = "satorra.bentler.2010")
```

RICLPMsit2b is NOT significantly *worse* fit (p = 0.1738) compared to RICLPMsit. Now we will constrain the other set of stability coefficients: cross lag ad->si (c) comparing to b!

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMsit2c)

```{r specify RICLPMsit2c}
RICLPMsit2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit2c}
RICLPMsit2c.fit <- lavaan(RICLPMsit2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit and RICLPMsit2c}
lavTestLRT(RICLPMsit2b.fit, RICLPMsit2c.fit, method = "satorra.bentler.2010")
```

RICLPMsit2c is *NOT* significantly worse fit compared to RICLPMsit (p = 0.4859). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMsit2d) - **compared to RICLPMsit2c, b,c,d lags constrained** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMsit2d}
RICLPMsit2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit2d}
RICLPMsit2d.fit <- lavaan(RICLPMsit2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit2c and RICLPMsit2d}
lavTestLRT(RICLPMsit2c.fit, RICLPMsit2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMsit2d is *NOT* significantly worse fit compared to RICLPMsit2c (p = 0.06539). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMsit2d where cross-lags and isolation autolag are constrained to be equal across time.**

***

### Constrainetd grand means (RICLPMsit3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMsit3}
RICLPMsit3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  tadhde5 + tadhde7 + tadhde10 + tadhde12 ~ mad*1
  sisoet5 + sisoet7 + sisoet10 + sisoet12 ~ msi*1
'
```

```{r fit RICLPMsit3}
RICLPMsit3.fit <- lavaan(RICLPMsit3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit and RICLPMsit3}
lavTestLRT(RICLPMsit.fit, RICLPMsit3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Hyperactive/Impulsive ADHD is combined mother and teacher report, isolation is teacher report only

## The basic RI-CLPM model (RICLPMsit_hyp)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMsit_hyp}
RICLPMsit_hyp <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_hyp}
RICLPMsit_hyp.fit <- lavaan(RICLPMsit_hyp,       # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMsit_hyp.fit.summary <- summary(RICLPMsit_hyp.fit, 
                                  fit.measures = TRUE,
                                  standardized = TRUE)

#Table of model fit 
RICLPMsit_hyp.fit.summary.fit <- table.model.fit(RICLPMsit_hyp.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsit_hyp.fit.summary.reg <- table.model.coef(model = RICLPMsit_hyp.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

### Fixed autoregressive and cross-lagged relations over time (RICLPMsit_hyp2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMsit2)

```{r specify RICLPMsit_hyp2}
RICLPMsit_hyp2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_hyp2}
RICLPMsit_hyp2.fit <- lavaan(RICLPMsit_hyp2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMsit_hyp2.fit.summary <- summary(RICLPMsit_hyp2.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPMsit_hyp2.fit.summary.fit <- table.model.fit(RICLPMsit_hyp2.fit.summary)
RICLPMsit_hyp2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsit_hyp2.fit.summary.reg <- table.model.coef(model = RICLPMsit_hyp2.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMsit_hyp2.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMsit_hyp and RICLPMsit_hyp2}
lavTestLRT(RICLPMsit_hyp.fit, RICLPMsit_hyp2.fit, method = "satorra.bentler.2010")
```

Comparison of fit statistics:       Model2  Model
Robust Comparative Fit Index (CFI)  0.985   0.993 (0.008)
Robust Tucker-Lewis Index (TLI)     0.976   0.980 (0.004)
Robust RMSEA                        0.037   0.034 (0.003)
SRMR                                0.033   0.025 (0.008)
All change in fit statistics is less than 0.01 - we can accept these constraints. Also the other significance levels are almost non-significant (chi square is likely inflated with large sample size)
2a p = 0.011
2b p = 0.140
2c p = 0.296
2d p = 0.205

*We can accept the constrained RICLPMsit_hyp2*

#### Constraining lag in ADHD parameter (RICLPMsit_hyp2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMsit_hyp2a}
RICLPMsit_hyp2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_hyp2a}
RICLPMsit_hyp2a.fit <- lavaan(RICLPMsit_hyp2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit_hyp and RICLPMsit_hyp2a}
lavTestLRT(RICLPMsit_hyp.fit, RICLPMsit_hyp2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMsit_hyp2b)

```{r specify RICLPMsit_hyp2b}
RICLPMsit_hyp2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_hyp2b}
RICLPMsit_hyp2b.fit <- lavaan(RICLPMsit_hyp2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit_hyp and RICLPMsit_hyp2b}
lavTestLRT(RICLPMsit_hyp.fit, RICLPMsit_hyp2b.fit, method = "satorra.bentler.2010")
```

RICLPMsit_hyp2b is NOT significantly *worse* fit (p = 0.1402) compared to RICLPMsit_hyp. Now we will constrain the other set of stability coefficients: cross lag ad->si (c) comparing to b!

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMsit_hyp2c)

```{r specify RICLPMsit_hyp2c}
RICLPMsit_hyp2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_hyp2c}
RICLPMsit_hyp2c.fit <- lavaan(RICLPMsit_hyp2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit_hyp and RICLPMsit_hyp2c}
lavTestLRT(RICLPMsit_hyp2b.fit, RICLPMsit_hyp2c.fit, method = "satorra.bentler.2010")
```

RICLPMsit_hyp2c is *NOT* significantly worse fit compared to RICLPMsit_hyp (p = 0.2965). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMsit_hyp2d) - **compared to RICLPMsit_hyp2c, b,c,d lags constrained** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMsit_hyp2d}
RICLPMsit_hyp2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_hyp2d}
RICLPMsit_hyp2d.fit <- lavaan(RICLPMsit_hyp2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit_hyp2c and RICLPMsit_hyp2d}
lavTestLRT(RICLPMsit_hyp2c.fit, RICLPMsit_hyp2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMsit_hyp2d is *NOT* significantly worse fit compared to RICLPMsit_hyp2c (p = 0.2054). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMsit_hyp2d where cross-lags and isolation autolag are constrained to be equal across time.**

***

### Constrainetd grand means (RICLPMsit_hyp3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMsit_hyp3}
RICLPMsit_hyp3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrainetd lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  hye5 + hye7 + hye10 + hye12 ~ mad*1
  sisoet5 + sisoet7 + sisoet10 + sisoet12 ~ msi*1
'
```

```{r fit RICLPMsit_hyp3}
RICLPMsit_hyp3.fit <- lavaan(RICLPMsit_hyp3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit_hyp and RICLPMsit_hyp3}
lavTestLRT(RICLPMsit_hyp.fit, RICLPMsit_hyp3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrainetd to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Inattention ADHD is combined mother and teacher report, Isolation is teacher report only

## The basic RI-CLPM model (RICLPMsit_inat)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMsit_inat}
RICLPMsit_inat <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_inat}
RICLPMsit_inat.fit <- lavaan(RICLPMsit_inat,     # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMsit_inat.fit.summary <- summary(RICLPMsit_inat.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPMsit_inat.fit.summary.fit <- table.model.fit(RICLPMsit_inat.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsit_inat.fit.summary.reg <- table.model.coef(model = RICLPMsit_inat.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

### Fixed autoregressive and cross-lagged relations over time (RICLPMsit_inat2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMsit2)

```{r specify RICLPMsit_inat2}
RICLPMsit_inat2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_inat2}
RICLPMsit_inat2.fit <- lavaan(RICLPMsit_inat2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMsit_inat2.fit.summary <- summary(RICLPMsit_inat2.fit, 
                                      fit.measures = TRUE,
                                      standardized = TRUE)

#Table of model fit 
RICLPMsit_inat2.fit.summary.fit <- table.model.fit(RICLPMsit_inat2.fit.summary)
RICLPMsit_inat2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsit_inat2.fit.summary.reg <- table.model.coef(model = RICLPMsit_inat2.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMsit_inat2.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMsit_inat and RICLPMsit_inat2}
lavTestLRT(RICLPMsit_inat.fit, RICLPMsit_inat2.fit, method = "satorra.bentler.2010")
```

RICLPMsit_inat2 is significantly *worse* fit compared to RICLPMsit_inat. However, we should compare the model fit as all other RICLPMsit have been slightly different on the 2a lag. 

Comparison of fit statistics:       Model2  Model
Robust Comparative Fit Index (CFI)  0.985   0.994 (0.009)
Robust Tucker-Lewis Index (TLI)     0.976   0.983 (0.007)
Robust RMSEA                        0.037   0.025 (0.012)
SRMR                                0.032   0.031 (0.001)
All change in fit statistics is less than 0.01 (apart form RMSEA) - we can accept these constraints. Also the other significance levels are almost non-significant (chi square is likely inflated with large sample size)
2a p = 0.007
2b p = 0.225
2c p = 0.731
2d p = 0.107

#### Constraining lag in ADHD parameter (RICLPMsit_inat2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMsit_inat2a}
RICLPMsit_inat2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_inat2a}
RICLPMsit_inat2a.fit <- lavaan(RICLPMsit_inat2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit_inat and RICLPMsit_inat2a}
lavTestLRT(RICLPMsit_inat.fit, RICLPMsit_inat2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMsit_inat2b)

```{r specify RICLPMsit_inat2b}
RICLPMsit_inat2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_inat2b}
RICLPMsit_inat2b.fit <- lavaan(RICLPMsit_inat2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit_inat and RICLPMsit_inat2b}
lavTestLRT(RICLPMsit_inat.fit, RICLPMsit_inat2b.fit, method = "satorra.bentler.2010")
```

RICLPMsit_inat2b is NOT significantly *worse* fit (p = 0.2259) compared to RICLPMsit_inat. Now we will constrain the other set of stability coefficients: cross lag ad->si (c) comparing to b!

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMsit_inat2c)

```{r specify RICLPMsit_inat2c}
RICLPMsit_inat2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_inat2c}
RICLPMsit_inat2c.fit <- lavaan(RICLPMsit_inat2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit_inat and RICLPMsit_inat2c}
lavTestLRT(RICLPMsit_inat2b.fit, RICLPMsit_inat2c.fit, method = "satorra.bentler.2010")
```

RICLPMsit_inat2c is *NOT* significantly worse fit compared to RICLPMsit_inat (p = 0.7317). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMsit_inat2d) - **compared to RICLPMsit_inat2c, b,c,d lags constrained** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMsit_inat2d}
RICLPMsit_inat2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsit_inat2d}
RICLPMsit_inat2d.fit <- lavaan(RICLPMsit_inat2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMsit_inat2d.fit.summary <- summary(RICLPMsit_inat2d.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)

#Table of model fit 
RICLPMsit_inat2d.fit.summary.fit <- table.model.fit(RICLPMsit_inat2d.fit.summary)
RICLPMsit_inat2d.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsit_inat2d.fit.summary.reg <- table.model.coef(model = RICLPMsit_inat2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMsit_inat2d.fit.summary.reg
```

```{r LRT for RICLPMsit_inat2c and RICLPMsit_inat2d}
lavTestLRT(RICLPMsit_inat2c.fit, RICLPMsit_inat2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMsit_inat2d is *NOT* significantly worse fit compared to RICLPMsit_inat2c (p = 0.1073). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMsit_inat2d where cross-lags and isolation autolag are constrained to be equal across time.**

***

### Constrained grand means (RICLPMsit_inat3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMsit_inat3}
RICLPMsit_inat3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoet5 + 1*sisoet7 + 1*sisoet10 + 1*sisoet12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoet5
  wsi7 =~ 1*sisoet7
  wsi10 =~ 1*sisoet10
  wsi12 =~ 1*sisoet12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  ine5 + ine7 + ine10 + ine12 ~ mad*1
  sisoet5 + sisoet7 + sisoet10 + sisoet12 ~ msi*1
'
```

```{r fit RICLPMsit_inat3}
RICLPMsit_inat3.fit <- lavaan(RICLPMsit_inat3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsit_inat and RICLPMsit_inat3}
lavTestLRT(RICLPMsit_inat.fit, RICLPMsit_inat3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Total ADHD is combined mother and teacher report, isolation is mother report

## Cross-lagged panel model (CLPMsim)

```{r specify CLPMsim}
CLPMsim <- '
  # Estimate the lagged effects between the observed variables.
  tadhde7 + sisoem7 ~ tadhde5 + sisoem5
  tadhde10 + sisoem10 ~ tadhde7 + sisoem7
  tadhde12 + sisoem12 ~ tadhde10 + sisoem10

  # Estimate the covariance between the observed variables at the first wave. 
  tadhde5 ~~ sisoem5 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  tadhde7 ~~ sisoem7
  tadhde10 ~~ sisoem10
  tadhde12 ~~ sisoem12
  
  # Estimate the (residual) variance of the observed variables.
  tadhde5 ~~ tadhde5 # Variances
  sisoem5 ~~ sisoem5 
  tadhde7 ~~ tadhde7 # Residual variances
  sisoem7 ~~ sisoem7 
  tadhde10 ~~ tadhde10 
  sisoem10 ~~ sisoem10 
  tadhde12 ~~ tadhde12 
  sisoem12 ~~ sisoem12 
'
```

```{r fit CLPMsim}
CLPMsim.fit <- lavaan(CLPMsim, 
                   data = dat, 
                   missing = 'ML',
                   meanstructure = TRUE, 
                   int.ov.free = TRUE,
                   se = "robust",
                   estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic 
                   ) 

CLPMsim.fit.summary <- summary(CLPMsim.fit, 
                            fit.measures = TRUE,
                            standardized = TRUE)

#Table of model fit 
CLPMsim.fit.summary.fit <- table.model.fit(CLPMsim.fit.summary)
CLPMsim.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
CLPMsim.fit.summary.reg <- table.model.coef(model = CLPMsim.fit.summary, type = "CLPM", constraints = "No")
CLPMsim.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

## The basic RI-CLPM model (RICLPMsim)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMsim, class.source = 'fold-show'}
RICLPMsim <- '
  # Create between components (rando intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim}
RICLPMsim.fit <- lavaan(RICLPMsim,               # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMsim.fit.summary <- summary(RICLPMsim.fit, 
                              fit.measures = TRUE,
                              standardized = TRUE)

#Table of model fit 
RICLPMsim.fit.summary.fit <- table.model.fit(RICLPMsim.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsim.fit.summary.reg <- table.model.coef(model = RICLPMsim.fit.summary, type = "RICLPM", constraints = "No")
```

#### Constraining all lag and crosslag parameters at once (RICLPMsim2)

```{r specify RICLPMsim2}
RICLPMsim2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim2}
RICLPMsim2.fit <- lavaan(RICLPMsim2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim and RICLPMsim2}
lavTestLRT(RICLPMsim.fit, RICLPMsim2.fit, method = "satorra.bentler.2010")
```

RICLPMsim2 is significantly *worse* fit compared to RICLPMsim according to the Chi square test. 

#### Constraining lag in ADHD parameter (RICLPMsim2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMsim2a}
RICLPMsim2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim2a}
RICLPMsim2a.fit <- lavaan(RICLPMsim2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim and RICLPMsim2a}
lavTestLRT(RICLPMsim.fit, RICLPMsim2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMsim2b)

```{r specify RICLPMsim2b}
RICLPMsim2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim2b}
RICLPMsim2b.fit <- lavaan(RICLPMsim2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim and RICLPMsim2b}
lavTestLRT(RICLPMsim.fit, RICLPMsim2b.fit, method = "satorra.bentler.2010")
```

RICLPMsim2b is significantly *worse* fit compared to RICLPMsim. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMsim2c)

```{r specify RICLPMsim2c}
RICLPMsim2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim2c}
RICLPMsim2c.fit <- lavaan(RICLPMsim2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim and RICLPMsim2c}
lavTestLRT(RICLPMsim.fit, RICLPMsim2c.fit, method = "satorra.bentler.2010")
```

RICLPMsim2c is *NOT* significantly worse fit compared to RICLPMsim (p = 0.8972). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMsim2d) - **compared to RICLPMsim2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMsim2d}
RICLPMsim2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim2d}
RICLPMsim2d.fit <- lavaan(RICLPMsim2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMsim2d.fit.summary <- summary(RICLPMsim2d.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)

#Table of model fit 
RICLPMsim2d.fit.summary.fit <- table.model.fit(RICLPMsim2d.fit.summary)
RICLPMsim2d.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsim2d.fit.summary.reg <- table.model.coef(model = RICLPMsim2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMsim2d.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMsim2c and RICLPMsim2d}
lavTestLRT(RICLPMsim2c.fit, RICLPMsim2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMsim2d is *NOT* significantly worse fit compared to RICLPMsim2c (p = 0.5699). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMsim2d where cross-lags are constrained to be equal across time.**

***

### Constrained grand means (RICLPMsim3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMsim3}
RICLPMsim3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*tadhde5 + 1*tadhde7 + 1*tadhde10 + 1*tadhde12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*tadhde5
  wad7 =~ 1*tadhde7
  wad10 =~ 1*tadhde10 
  wad12 =~ 1*tadhde12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  tadhde5 + tadhde7 + tadhde10 + tadhde12 ~ mad*1
  sisoem5 + sisoem7 + sisoem10 + sisoem12 ~ msi*1
'
```

```{r fit RICLPMsim3}
RICLPMsim3.fit <- lavaan(RICLPMsim3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim and RICLPMsim3}
lavTestLRT(RICLPMsim.fit, RICLPMsim3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Hyperactive/Impulsive ADHD is combined mother and teacher report, isolation is mother report only

## The basic RI-CLPM model (RICLPMsim_hyp)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMsim_hyp}
RICLPMsim_hyp <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_hyp}
RICLPMsim_hyp.fit <- lavaan(RICLPMsim_hyp,       # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMsim_hyp.fit.summary <- summary(RICLPMsim_hyp.fit, 
                                  fit.measures = TRUE,
                                  standardized = TRUE)

#Table of model fit 
RICLPMsim_hyp.fit.summary.fit <- table.model.fit(RICLPMsim_hyp.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsim_hyp.fit.summary.reg <- table.model.coef(model = RICLPMsim_hyp.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

### Fixed autoregressive and cross-lagged relations over time (RICLPMsim_hyp2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMsim2)

```{r specify RICLPMsim_hyp2}
RICLPMsim_hyp2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_hyp2}
RICLPMsim_hyp2.fit <- lavaan(RICLPMsim_hyp2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim_hyp and RICLPMsim_hyp2}
lavTestLRT(RICLPMsim_hyp.fit, RICLPMsim_hyp2.fit, method = "satorra.bentler.2010")
```

RICLPMsim_hyp2 is significantly *worse* fit compared to RICLPMsim_hyp. 

#### Constraining lag in ADHD parameter (RICLPMsim_hyp2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMsim_hyp2a}
RICLPMsim_hyp2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_hyp2a}
RICLPMsim_hyp2a.fit <- lavaan(RICLPMsim_hyp2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim_hyp and RICLPMsim_hyp2a}
lavTestLRT(RICLPMsim_hyp.fit, RICLPMsim_hyp2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMsim_hyp2b)

```{r specify RICLPMsim_hyp2b}
RICLPMsim_hyp2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_hyp2b}
RICLPMsim_hyp2b.fit <- lavaan(RICLPMsim_hyp2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim_hyp and RICLPMsim_hyp2b}
lavTestLRT(RICLPMsim_hyp.fit, RICLPMsim_hyp2b.fit, method = "satorra.bentler.2010")
```

RICLPMsim_hyp2b is significantly *worse* fit compared to RICLPMsim_hyp. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMsim_hyp2c)

```{r specify RICLPMsim_hyp2c}
RICLPMsim_hyp2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_hyp2c}
RICLPMsim_hyp2c.fit <- lavaan(RICLPMsim_hyp2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim_hyp and RICLPMsim_hyp2c}
lavTestLRT(RICLPMsim_hyp.fit, RICLPMsim_hyp2c.fit, method = "satorra.bentler.2010")
```

RICLPMsim_hyp2c is *NOT* significantly worse fit compared to RICLPMsim_hyp (p = 0.5396). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMsim_hyp2d) - **compared to RICLPMsim_hyp2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMsim_hyp2d}
RICLPMsim_hyp2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_hyp2d}
RICLPMsim_hyp2d.fit <- lavaan(RICLPMsim_hyp2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMsim_hyp2d.fit.summary <- summary(RICLPMsim_hyp2d.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)

#Table of model fit 
RICLPMsim_hyp2d.fit.summary.fit <- table.model.fit(RICLPMsim_hyp2d.fit.summary)
RICLPMsim_hyp2d.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsim_hyp2d.fit.summary.reg <- table.model.coef(model = RICLPMsim_hyp2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMsim_hyp2d.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMsim_hyp2c and RICLPMsim_hyp2d}
lavTestLRT(RICLPMsim_hyp2c.fit, RICLPMsim_hyp2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMsim_hyp2d is *NOT* significantly worse fit compared to RICLPMsim_hyp2c (0.7596). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMsim_hyp2d where cross-lags are constrained to be equal across time.**

### Constrained grand means (RICLPMsim_hyp3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMsim_hyp3}
RICLPMsim_hyp3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*hye5 + 1*hye7 + 1*hye10 + 1*hye12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*hye5
  wad7 =~ 1*hye7
  wad10 =~ 1*hye10 
  wad12 =~ 1*hye12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  hye5 + hye7 + hye10 + hye12 ~ mad*1
  sisoem5 + sisoem7 + sisoem10 + sisoem12 ~ msi*1
'
```

```{r fit RICLPMsim_hyp3}
RICLPMsim_hyp3.fit <- lavaan(RICLPMsim_hyp3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim_hyp and RICLPMsim_hyp3}
lavTestLRT(RICLPMsim_hyp.fit, RICLPMsim_hyp3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***

# RI-CLPM: Inattention ADHD is combined mother and teacher report, isolationis mother report only

## The basic RI-CLPM model (RICLPMsim_inat)
The code for specifying the basic RI-CLPM is given below.

```{r specify RICLPMsim_inat}
RICLPMsim_inat <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Estimate the lagged effects between the within-person centered variables
  wad7 + wsi7 ~ wad5 + wsi5
  wad10 + wsi10 ~ wad7 + wsi7
  wad12 + wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_inat}
RICLPMsim_inat.fit <- lavaan(RICLPMsim_inat,     # model
                     data = dat,           # data
                     missing = 'ML',       # how to handle missing data 
                     meanstructure = TRUE, # adds intercepts/means to the model for both observed and latent variables
                     se = "robust",        # robust standard errors
                     int.ov.free = TRUE,   # if FALSE, the intercepts of the observed variables are fixed to zero
                     estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
)

RICLPMsim_inat.fit.summary <- summary(RICLPMsim_inat.fit, 
                                    fit.measures = TRUE,
                                    standardized = TRUE)

#Table of model fit 
RICLPMsim_inat.fit.summary.fit <- table.model.fit(RICLPMsim_inat.fit.summary)
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsim_inat.fit.summary.reg <- table.model.coef(model = RICLPMsim_inat.fit.summary, type = "RICLPM", constraints = "No")
```

## RI-CLPM Constraints over time {.tabset .tabset-fade}

### Fixed autoregressive and cross-lagged relations over time (RICLPMsim_inat2)

a = lag in ad
b = lag in si
c = cross lag ad->si
d = cross lag si->ad

#### Constraining all lag and crosslag parameters at once (RICLPMsim2)

```{r specify RICLPMsim_inat2}
RICLPMsim_inat2 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + d*wsi5 
  wsi7 ~ c*wad5 + b*wsi5
  
  wad10 ~ a*wad7 + d*wsi7
  wsi10 ~ c*wad7 + b*wsi7
  
  wad12 ~ a*wad10 + d*wsi10
  wsi12 ~ c*wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_inat2}
RICLPMsim_inat2.fit <- lavaan(RICLPMsim_inat2, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMsim_inat2.fit.summary <- summary(RICLPMsim_inat2.fit, 
                                      fit.measures = TRUE,
                                      standardized = TRUE)

#Table of model fit 
RICLPMsim_inat2.fit.summary.fit <- table.model.fit(RICLPMsim_inat2.fit.summary)
RICLPMsim_inat2.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsim_inat2.fit.summary.reg <- table.model.coef(model = RICLPMsim_inat2.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMsim_inat2.fit.summary.reg
```

```{r LRT for RICLPMsim_inat and RICLPMsim_inat2}
lavTestLRT(RICLPMsim_inat.fit, RICLPMsim_inat2.fit, method = "satorra.bentler.2010")
```

RICLPMsim_inat2 is significantly *worse* fit compared to RICLPMsim_inat. 

#### Constraining lag in ADHD parameter (RICLPMsim_inat2a)

Now we will test the constraints based on the following steps recommended by Curran and Bauer:
1. Estimate the baseline model where all parameters are freely estimated (The basic RI-CLPM)
2. Impose equlaity constraints on one set of stabilities (within variable lags). Use LRT tests to see if he fit becomes significantly worse. 
3. Impose equality constraints on the next set of stabilities. Compare this to wither model 1 (baseline/basic) if step 2 was significant. Compare to model 2 if step 2 was non-significant. *Non-sig LRT = not significantly worse fit*
4. Repeat for first set of cross-lags
5. Repeat for second set of cross-lags

```{r specify RICLPMsim_inat2a}
RICLPMsim_inat2a <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ a*wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  
  wad10 ~ a*wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  
  wad12 ~ a*wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_inat2a}
RICLPMsim_inat2a.fit <- lavaan(RICLPMsim_inat2a, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim_inat and RICLPMsim_inat2a}
lavTestLRT(RICLPMsim_inat.fit, RICLPMsim_inat2a.fit, method = "satorra.bentler.2010")
```

#### Constraining lag in social isolation parameter (RICLPMsim_inat2b)

```{r specify RICLPMsim_inat2b}
RICLPMsim_inat2b <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + b*wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + b*wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + b*wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_inat2b}
RICLPMsim_inat2b.fit <- lavaan(RICLPMsim_inat2b, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim_inat and RICLPMsim_inat2b}
lavTestLRT(RICLPMsim_inat.fit, RICLPMsim_inat2b.fit, method = "satorra.bentler.2010")
```

RICLPMsim_inat2b is significantly *worse* fit compared to RICLPMsim_inat. Now we will constrain the other set of stability coefficients: cross lag ad->si (c)

#### Constraining cross lag in ADHD to social isolation parameter (RICLPMsim_inat2c)

```{r specify RICLPMsim_inat2c}
RICLPMsim_inat2c <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_inat2c}
RICLPMsim_inat2c.fit <- lavaan(RICLPMsim_inat2c, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim_inat and RICLPMsim_inat2c}
lavTestLRT(RICLPMsim_inat.fit, RICLPMsim_inat2c.fit, method = "satorra.bentler.2010")
```

RICLPMsim_inat2c is *NOT* significantly worse fit compared to RICLPMsim_inat (p = 0.9349). Now we will constrain the other set of stability coefficients: cross lag si->ad (d) *but comparing that model to this one*. 

#### Constraining cross lag in social isolation to ADHD parameter (RICLPMsim_inat2d) - **compared to RICLPMsim_inat2c** 

Thus, constraining both sets of lags are tested in this model. 

```{r specify RICLPMsim_inat2d}
RICLPMsim_inat2d <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + d*wsi5 
  wsi7 ~ c*wad5 + wsi5
  
  wad10 ~ wad7 + d*wsi7
  wsi10 ~ c*wad7 + wsi7
  
  wad12 ~ wad10 + d*wsi10
  wsi12 ~ c*wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables.
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
'
```

```{r fit RICLPMsim_inat2d}
RICLPMsim_inat2d.fit <- lavaan(RICLPMsim_inat2d, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 

RICLPMsim_inat2d.fit.summary <- summary(RICLPMsim_inat2d.fit, 
                                fit.measures = TRUE,
                                standardized = TRUE)

#Table of model fit 
RICLPMsim_inat2d.fit.summary.fit <- table.model.fit(RICLPMsim_inat2d.fit.summary)
RICLPMsim_inat2d.fit.summary.fit
#Table of regression coefficients and covariances (concurrent associations)
RICLPMsim_inat2d.fit.summary.reg <- table.model.coef(model = RICLPMsim_inat2d.fit.summary, type = "RICLPM", constraints = "Yes")
RICLPMsim_inat2d.fit.summary.reg %>% select(lhs, op, rhs, pvalue, std.all) %>% mutate_if(is.numeric, round, 3)
```

```{r LRT for RICLPMsim_inat2c and RICLPMsim_inat2d}
lavTestLRT(RICLPMsim_inat2c.fit, RICLPMsim_inat2d.fit, method = "satorra.bentler.2010") #comparing to other best fitting model
```

RICLPMsim_inat2d is *NOT* significantly worse fit compared to RICLPMsim_inat2c (0.2958). 

**The best fitting model (mother report and total ADHD symptoms) is currently RICLPMsim_inat2d where cross-lags are constrained to be equal across time.**

### Constrained grand means (RICLPMsim_inat3)

The grand means are the means over all units per occasion. These grand means may be time-varying, or may be fixed to be invariant over time. 

```{r specify RICLPMsim_inat3}
RICLPMsim_inat3 <- '
  # Create between components (random intercepts treated as factors here)
  RIad =~ 1*ine5 + 1*ine7 + 1*ine10 + 1*ine12 #x
  RIsi =~ 1*sisoem5 + 1*sisoem7 + 1*sisoem10 + 1*sisoem12 #y

  # Create within-person centered variables
  wad5 =~ 1*ine5
  wad7 =~ 1*ine7
  wad10 =~ 1*ine10 
  wad12 =~ 1*ine12
  wsi5 =~ 1*sisoem5
  wsi7 =~ 1*sisoem7
  wsi10 =~ 1*sisoem10
  wsi12 =~ 1*sisoem12
  
  # Constrained lagged effects between the within-person centered variables. 
  wad7 ~ wad5 + wsi5 
  wsi7 ~ wad5 + wsi5
  wad10 ~ wad7 + wsi7
  wsi10 ~ wad7 + wsi7
  wad12 ~ wad10 + wsi10
  wsi12 ~ wad10 + wsi10
  
  # Estimate the covariance between the within-person centered variables at the first wave
  wad5 ~~ wsi5 # Covariance
  
  # Estimate the covariances between the residuals of the within-person centered variables (the innovations)
  wad7 ~~ wsi7
  wad10 ~~ wsi10
  wad12 ~~ wsi12
  
  # Estimate the variance and covariance of the random intercepts
  RIad ~~ RIad
  RIsi ~~ RIsi
  RIad ~~ RIsi
  
  # Estimate the (residual) variance of the within-person centered variables
  wad5 ~~ wad5 # Variances
  wsi5 ~~ wsi5 
  wad7 ~~ wad7 # Residual variances
  wsi7 ~~ wsi7 
  wad10 ~~ wad10 
  wsi10 ~~ wsi10 
  wad12 ~~ wad12 
  wsi12 ~~ wsi12
  
  # Constrain the grand means over time
  ine5 + ine7 + ine10 + ine12 ~ mad*1
  sisoem5 + sisoem7 + sisoem10 + sisoem12 ~ msi*1
'
```

```{r fit RICLPMsim_inat3}
RICLPMsim_inat3.fit <- lavaan(RICLPMsim_inat3, 
                      data = dat, 
                      missing = 'ML', 
                      meanstructure = TRUE, 
                      int.ov.free = TRUE,
                      se = "robust",
                      estimator = "MLR" #maximum likelihood with robust (Huber-White) standard errors and a scaled (Yuan-Bentler) and robust test statistic
                      ) 
```

```{r LRT for RICLPMsim_inat and RICLPMsim_inat3}
lavTestLRT(RICLPMsim_inat.fit, RICLPMsim_inat3.fit, method = "satorra.bentler.2010") 
```

If the grand means cannot be constrained to be invariant over time, this implies that on average there is some change in this variable over time, which may reflect some occasion-specific effect, or a developmental trend. By allowing the means to freely vary over time, we account for such average changes over time.

*This makes sense as we have shown variation in social isolation over time and other literature has shown variation in ADHD over time.*

***




